# 利用者不在情報管理タブ設計書

- 画面名: `利用者不在情報管理タブ`
- パス: `/residents/[residentId]` (詳細情報タブ内)
- URL: https://carebase-staff.vercel.app/residents/1

## 概要

利用者詳細画面内の不在情報管理タブ設計書です。
利用者の外出、通院、一時帰宅、家族との外出などの不在予定の登録、編集、削除、ステータス管理機能を提供します。
利用者の所在把握と適切なケア提供のための重要な情報管理システムです。

Issue: [#TBD [設計] 利用者｜利用者不在情報管理](https://github.com/ambi-tious/CareBase-staff/issues/TBD)

## 全体レイアウト

### 画面構成

タブ内で完結する不在情報管理インターフェース：

- タブヘッダー（不在情報タブ選択状態）
- フィルタ・検索エリア（検索バー、ステータスフィルタ、理由フィルタ、追加ボタン）
- 不在記録一覧表示エリア（タイムライン形式のテーブル表示）
- 空状態メッセージ（不在記録なし時）

### 画面項目

| 項目名             | コンポーネント | 必須 | 表示条件       | 初期値               | 備考                         |
| ------------------ | -------------- | ---- | -------------- | -------------------- | ---------------------------- |
| タブヘッダー       | TabsTrigger    | -    | 常時           | 不在情報             | アクティブ状態で青色表示     |
| 検索バー           | Input          | -    | 常時           | ""                   | 備考・理由で検索             |
| ステータスフィルタ | Select         | -    | 常時           | "すべて"             | 4種類のステータスから選択    |
| 理由フィルタ       | Select         | -    | 常時           | "すべて"             | 6種類の理由から選択          |
| リセットボタン     | Button         | -    | フィルタ適用時 | リセット             | フィルタクリア機能           |
| 追加ボタン         | Button         | -    | 常時           | 不在情報を追加       | 右上配置、プラスアイコン付き |
| 不在記録テーブル   | Table          | -    | 記録存在時     | -                    | タイムライン形式             |
| 空状態メッセージ   | Card           | -    | 記録なし時     | 不在記録がありません | 中央配置、点線ボーダー       |

## 不在記録テーブル詳細

### 画面項目

| 項目名     | コンポーネント     | 必須 | 表示条件 | 初期値 | 備考                       |
| ---------- | ------------------ | ---- | -------- | ------ | -------------------------- |
| 日付区切り | TableRow           | -    | 日付変更 | -      | 日付ごとにグループ化       |
| 日付       | TableCell          | ◯    | 常時     | -      | YYYY/MM/DD形式             |
| 時間       | TableCell          | ◯    | 常時     | -      | HH:MM-HH:MM形式            |
| 期間       | TableCell          | ◯    | 常時     | -      | X時間Y分形式               |
| 理由       | AbsenceReasonBadge | ◯    | 常時     | -      | カテゴリごとに色分け       |
| ステータス | AbsenceStatusBadge | ◯    | 常時     | -      | ステータスごとに色分け     |
| 備考       | TableCell          | -    | 備考あり | -      | 最大2行、省略表示          |
| 登録者     | TableCell          | ◯    | 常時     | -      | スタッフ名表示             |
| 操作ボタン | DropdownMenu       | -    | 常時     | -      | ステータス変更・編集・削除 |

## 機能仕様

### アクション

| 項目名             | 処理内容                     | 対象API                                   | 遷移先画面               |
| ------------------ | ---------------------------- | ----------------------------------------- | ------------------------ |
| 不在記録検索       | 備考・理由での部分一致検索   | -                                         | 同一画面（フィルタ適用） |
| ステータスフィルタ | 選択ステータスで記録絞り込み | -                                         | 同一画面（フィルタ適用） |
| 理由フィルタ       | 選択理由で記録絞り込み       | -                                         | 同一画面（フィルタ適用） |
| フィルタリセット   | 検索・フィルタ条件をクリア   | -                                         | 同一画面（全記録表示）   |
| 不在情報追加       | 新規不在記録登録モーダル     | -                                         | 不在情報登録モーダル     |
| 不在情報編集       | 既存不在記録編集             | `/v1/residents/[id]/absences/[absenceId]` | 不在情報編集モーダル     |
| ステータス更新     | 不在ステータス変更           | `/v1/residents/[id]/absences/[absenceId]` | -                        |
| 不在記録削除       | 不在記録削除確認・実行       | `/v1/residents/[id]/absences/[absenceId]` | 削除確認モーダル         |

### 不在理由カテゴリ

| 理由名       | 値             | アイコン      | カラー                 | 説明               |
| ------------ | -------------- | ------------- | ---------------------- | ------------------ |
| 通院・受診   | hospital_visit | Stethoscope   | 赤系（red-100/700）    | 医療機関での受診   |
| 家族との外出 | family_visit   | Users         | 青系（blue-100/700）   | 家族同伴での外出   |
| 外出・散歩   | outing         | MapPin        | 緑系（green-100/700）  | 個人での外出・散歩 |
| 一時帰宅     | home_visit     | Home          | 紫系（purple-100/700） | 自宅への一時帰宅   |
| 緊急対応     | emergency      | AlertTriangle | 橙系（orange-100/700） | 緊急事態での外出   |
| その他       | other          | FileText      | 灰系（gray-100/700）   | 上記以外の理由     |

### 不在ステータス

| ステータス名 | 値        | カラー                 | 説明                   |
| ------------ | --------- | ---------------------- | ---------------------- |
| 予定         | scheduled | 青系（blue-100/700）   | 不在予定として登録済み |
| 不在中       | ongoing   | 黄系（yellow-100/700） | 現在不在中（外出中）   |
| 帰所済み     | completed | 緑系（green-100/700）  | 外出から帰所完了       |
| キャンセル   | cancelled | 灰系（gray-100/700）   | 不在予定がキャンセル   |

## モーダル仕様

### 不在情報登録・編集モーダル

#### 画面項目

| 項目名           | コンポーネント | 必須 | 表示条件   | 初期値     | 備考                     |
| ---------------- | -------------- | ---- | ---------- | ---------- | ------------------------ |
| 開始日時         | Input          | ◯    | 常時       | 現在日時   | datetime-local形式       |
| 終了日時         | Input          | ◯    | 常時       | 開始+1時間 | datetime-local形式       |
| 不在理由         | Select         | ◯    | 常時       | ""         | 6種類の理由から選択      |
| カスタム理由     | Input          | 条件 | その他選択 | ""         | 「その他」選択時のみ必須 |
| 備考             | Textarea       | -    | 常時       | ""         | 最大500文字              |
| キャンセルボタン | Button         | -    | 常時       | キャンセル | モーダルクローズ         |
| 登録ボタン       | Button         | -    | 常時       | 登録/更新  | フォーム送信             |

#### 入力チェック

| 項目名       | チェック内容              | エラーメッセージ                                     |
| ------------ | ------------------------- | ---------------------------------------------------- |
| 開始日時     | 必須チェック              | 開始日時は必須です                                   |
| 開始日時     | 日時形式チェック          | 有効な日時を入力してください                         |
| 終了日時     | 必須チェック              | 終了日時は必須です                                   |
| 終了日時     | 日時形式チェック          | 有効な日時を入力してください                         |
| 終了日時     | 開始日時より後チェック    | 終了日時は開始日時より後の時刻を入力してください     |
| 不在理由     | 必須チェック              | 不在理由は必須です                                   |
| カスタム理由 | その他選択時必須チェック  | その他を選択した場合は、カスタム理由の入力が必要です |
| カスタム理由 | 文字数チェック（100文字） | カスタム理由は100文字以内で入力してください          |
| 備考         | 文字数チェック（500文字） | 備考は500文字以内で入力してください                  |

### 削除確認モーダル

#### 画面項目

| 項目名           | コンポーネント | 必須 | 表示条件 | 初期値       | 備考                 |
| ---------------- | -------------- | ---- | -------- | ------------ | -------------------- |
| 確認メッセージ   | Text           | ◯    | 常時     | 削除確認文言 | 不在記録の詳細を含む |
| 注意事項         | Alert          | ◯    | 常時     | 注意文言     | 赤色背景で警告表示   |
| キャンセルボタン | Button         | -    | 常時     | キャンセル   | モーダルクローズ     |
| 削除実行ボタン   | Button         | -    | 常時     | 削除         | 赤色、確認後削除実行 |

## ステータス操作仕様

### ステータス遷移

| 現在ステータス | 可能な操作 | 遷移先ステータス | 操作ボタン |
| -------------- | ---------- | ---------------- | ---------- |
| 予定           | 不在開始   | 不在中           | 不在開始   |
| 予定           | キャンセル | キャンセル       | キャンセル |
| 予定           | 編集       | -                | 編集       |
| 不在中         | 帰所完了   | 帰所済み         | 帰所完了   |
| 不在中         | キャンセル | キャンセル       | キャンセル |
| 帰所済み       | なし       | -                | -          |
| キャンセル     | なし       | -                | -          |

### 編集制限

- **編集可能**: 「予定」ステータスの記録のみ
- **ステータス変更可能**: 「予定」「不在中」ステータスの記録
- **削除可能**: 全ステータスの記録（管理者権限必要）

## 入力チェック・バリデーション

### 表示制御

- 不在記録一覧: 開始日時の降順（新しい順）で表示
- 日付区切り: 同一日の記録をグループ化して表示
- フィルタ結果: リアルタイムでの絞り込み表示
- 空状態: 記録が存在しない、またはフィルタ結果が0件の場合に表示

### エラーハンドリング

- 不在記録取得エラー: モックデータによるフォールバック
- 登録・更新エラー: ユーザーフレンドリーなエラーメッセージ表示
- ネットワークエラー: リトライ機能とエラー通知
- バリデーションエラー: フィールド別エラーメッセージ表示

## UI/UX仕様

### レスポンシブデザイン

- **モバイル（〜768px）**:
  - テーブルを横スクロール対応
  - フィルタエリアを縦並び配置
  - モーダルを全画面表示
- **タブレット（768px〜1024px）**:
  - テーブル列幅を調整
  - フィルタエリアを2行配置
- **デスクトップ（1024px〜）**:
  - 全要素を横並び配置
  - テーブル全体表示

### カラーテーマ

- **追加ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark`
- **検索バー**: `border-gray-300 focus:border-carebase-blue`
- **テーブルヘッダー**: `bg-gray-50`
- **日付区切り**: `bg-blue-50 border-blue-200`
- **不在中行**: `bg-yellow-50`
- **帰所済み行**: `bg-green-50`
- **キャンセル行**: `bg-gray-50`
- **操作ボタン**: `text-gray-600 hover:text-carebase-blue`

### アニメーション

- **テーブル行ホバー**: `hover:bg-gray-50 transition-colors`
- **モーダル表示**: `fade-in ease-out duration-300`
- **ステータス更新**: ローディングスピナー表示
- **フィルタ適用**: `transition-opacity duration-200`

### アクセシビリティ

- **キーボードナビゲーション**: Tab順序の最適化
- **スクリーンリーダー**: 適切なaria-label、役割の設定
- **フォーカス管理**: モーダル内でのフォーカストラップ
- **コントラスト**: WCAG AA準拠の色彩設計

## データ仕様

### 不在記録エンティティ

```typescript
interface Absence {
  id: string; // 不在記録ID
  residentId: string; // 利用者ID
  startDateTime: string; // 開始日時（ISO 8601）
  endDateTime: string; // 終了日時（ISO 8601）
  reason: AbsenceReason; // 不在理由
  customReason?: string; // カスタム理由（その他選択時）
  notes?: string; // 備考
  status: AbsenceStatus; // ステータス
  createdAt: string; // 作成日時（ISO 8601）
  updatedAt: string; // 更新日時（ISO 8601）
  createdBy: string; // 作成者ID
  createdByName: string; // 作成者名
  approvedBy?: string; // 承認者ID（必要に応じて）
  approvedByName?: string; // 承認者名（必要に応じて）
  approvedAt?: string; // 承認日時（必要に応じて）
}
```

### API仕様

#### 不在記録一覧取得

- **エンドポイント**: `GET /v1/residents/{residentId}/absences`
- **レスポンス**: `Absence[]`

#### 不在記録登録

- **エンドポイント**: `POST /v1/residents/{residentId}/absences`
- **リクエスト**: `AbsenceFormData`
- **レスポンス**: `Absence`

#### 不在記録更新

- **エンドポイント**: `PUT /v1/residents/{residentId}/absences/{absenceId}`
- **リクエスト**: `AbsenceFormData`
- **レスポンス**: `Absence`

#### ステータス更新

- **エンドポイント**: `PATCH /v1/residents/{residentId}/absences/{absenceId}/status`
- **リクエスト**: `{ status: AbsenceStatus }`
- **レスポンス**: `Absence`

#### 不在記録削除

- **エンドポイント**: `DELETE /v1/residents/{residentId}/absences/{absenceId}`
- **レスポンス**: `void`

## ビジネスルール

### 不在管理ポリシー

1. **事前登録**: 原則として不在予定は事前に登録する
2. **承認フロー**: 長期の一時帰宅は管理者承認が必要（実装検討）
3. **ステータス管理**: リアルタイムでの所在確認が可能
4. **履歴管理**: 過去の不在記録も含めて履歴として保持

### セキュリティ

1. **権限管理**: 利用者担当スタッフのみ編集可能
2. **ログ記録**: 全ての操作をログとして記録
3. **データ保護**: 個人情報保護法に準拠したデータ管理

## 参考資料

- [利用者詳細画面設計書](../README.md)
- [AbsenceTabContent コンポーネント](../../../../../components/3_organisms/absence/absence-tab-content.tsx)
- [AbsenceList コンポーネント](../../../../../components/3_organisms/absence/absence-list.tsx)
- [AbsenceFilters コンポーネント](../../../../../components/2_molecules/absence/absence-filters.tsx)
- [AbsenceTimelineTable コンポーネント](../../../../../components/2_molecules/absence/absence-timeline-table.tsx)
- [AbsenceModal コンポーネント](../../../../../components/3_organisms/modals/absence-modal.tsx)
- [AbsenceService](../../../../../services/absenceService.ts)
- [Absence型定義](../../../../../types/absence.ts)
- [AbsenceValidation](../../../../../validations/absence-validation.ts)
- [画面一覧](../../../../../docs/screen-list.md#利用者管理)
