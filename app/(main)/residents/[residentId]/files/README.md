# 利用者ファイルタブ設計書

- 画面名: `利用者ファイルタブ`
- パス: `/residents/[residentId]` (詳細情報タブ内)
- URL: https://carebase-staff.vercel.app/residents/1

## 概要

利用者詳細画面内のファイルタブ設計書です。
利用者に関連するすべてのファイル（医療記録、ケアプラン、アセスメント、写真等）の表示、アップロード、編集、削除機能を提供します。
利用者の重要な書類や資料を一元管理し、スタッフ間での情報共有を効率化します。

Issue: [#TBD [設計] 利用者｜利用者ファイル](https://github.com/ambi-tious/CareBase-staff/issues/TBD)

## 全体レイアウト

### 画面構成

タブ内で完結するファイルインターフェース：

- タブヘッダー（ファイルタブ選択状態）
- フィルタ・検索エリア（検索バー、カテゴリフィルタ、アップロードボタン）
- ファイル一覧表示エリア（グリッド形式、カード表示）
- 空状態メッセージ（ファイルなし時）

### 画面項目

| 項目名             | コンポーネント | 必須 | 表示条件       | 初期値               | 備考                         |
| ------------------ | -------------- | ---- | -------------- | -------------------- | ---------------------------- |
| タブヘッダー       | TabsTrigger    | -    | 常時           | ファイル             | アクティブ状態で青色表示     |
| 検索バー           | Input          | -    | 常時           | ""                   | ファイル名・説明で検索       |
| カテゴリフィルタ   | Select         | -    | 常時           | "すべて"             | 7種類のカテゴリから選択      |
| リセットボタン     | Button         | -    | フィルタ適用時 | リセット             | フィルタクリア機能           |
| アップロードボタン | Button         | -    | 常時           | アップロード         | 右上配置、プラスアイコン付き |
| ファイルカード     | FileCard       | -    | ファイル存在時 | -                    | サムネイル付きカード表示     |
| 空状態メッセージ   | Card           | -    | ファイルなし時 | ファイルがありません | 中央配置、点線ボーダー       |
| ファイル数表示     | Badge          | -    | ファイル存在時 | "X件のファイル"      | フィルタ結果に応じて動的表示 |

## ファイルカードコンポーネント詳細

### 画面項目

| 項目名             | コンポーネント | 必須 | 表示条件   | 初期値 | 備考                                   |
| ------------------ | -------------- | ---- | ---------- | ------ | -------------------------------------- |
| ファイルサムネイル | Image/Icon     | ◯    | 常時       | -      | 画像ファイルは実画像、その他はアイコン |
| カテゴリバッジ     | Badge          | ◯    | 常時       | -      | カテゴリごとに色分け                   |
| ファイル名         | Text           | ◯    | 常時       | -      | 最大2行、省略表示                      |
| ファイル説明       | Text           | -    | 説明あり時 | -      | 最大2行、グレー文字                    |
| ファイルサイズ     | Text           | ◯    | 常時       | -      | KB/MB単位で表示                        |
| アップロード日時   | Text           | ◯    | 常時       | -      | 相対時間表示（例：2日前）              |
| アップロード者     | Text           | ◯    | 常時       | -      | スタッフ名表示                         |
| アクションボタン   | DropdownMenu   | -    | ホバー時   | -      | 表示・編集・削除・ダウンロード         |

## 機能仕様

### アクション

| 項目名               | 処理内容                         | 対象API                                      | 遷移先画面                 |
| -------------------- | -------------------------------- | -------------------------------------------- | -------------------------- |
| ファイル検索         | ファイル名・説明での部分一致検索 | -                                            | 同一画面（フィルタ適用）   |
| カテゴリフィルタ     | 選択カテゴリでファイル絞り込み   | -                                            | 同一画面（フィルタ適用）   |
| フィルタリセット     | 検索・フィルタ条件をクリア       | -                                            | 同一画面（全ファイル表示） |
| ファイルアップロード | 新規ファイルアップロードモーダル | -                                            | アップロードモーダル       |
| ファイル表示         | ファイル詳細表示・プレビュー     | `/v1/residents/[id]/files/[fileId]`          | ファイル表示モーダル       |
| ファイル編集         | ファイル情報編集                 | `/v1/residents/[id]/files/[fileId]`          | ファイル編集モーダル       |
| ファイル削除         | ファイル削除確認・実行           | `/v1/residents/[id]/files/[fileId]`          | 削除確認モーダル           |
| ファイルダウンロード | ファイルダウンロード             | `/v1/residents/[id]/files/[fileId]/download` | -                          |

### ファイルカテゴリ

| カテゴリ名   | 値              | アイコン      | カラー                 | 説明                     |
| ------------ | --------------- | ------------- | ---------------------- | ------------------------ |
| 医療記録     | medical_record  | FileText      | 赤系（red-100/700）    | 診療記録、検査結果等     |
| ケアプラン   | care_plan       | FileCheck     | 青系（blue-100/700）   | 各種ケアプラン書類       |
| アセスメント | assessment      | ClipboardList | 緑系（green-100/700）  | フェイスシート、評価表等 |
| 写真         | photo           | Camera        | 紫系（purple-100/700） | 利用者・居宅環境写真     |
| 家族関連書類 | family_document | Users         | 橙系（orange-100/700） | 家族に関する書類         |
| 保険関連     | insurance       | Shield        | 藍系（indigo-100/700） | 保険証、負担割合証等     |
| その他       | other           | File          | 灰系（gray-100/700）   | 上記以外の書類           |

## モーダル仕様

### ファイルアップロードモーダル

#### 画面項目

| 項目名             | コンポーネント | 必須 | 表示条件 | 初期値       | 備考                           |
| ------------------ | -------------- | ---- | -------- | ------------ | ------------------------------ |
| ファイル選択       | FileInput      | ◯    | 常時     | -            | ドラッグ&ドロップ対応          |
| ファイルプレビュー | Image/Icon     | -    | 選択後   | -            | 画像ファイルのみプレビュー表示 |
| カテゴリ           | Select         | ◯    | 常時     | auto-detect  | ファイル種別による自動判定     |
| ファイル名         | Input          | ◯    | 常時     | 元ファイル名 | 日本語ファイル名対応           |
| 説明               | Textarea       | -    | 常時     | ""           | 最大500文字                    |
| キャンセルボタン   | Button         | -    | 常時     | キャンセル   | モーダルクローズ               |
| アップロードボタン | Button         | -    | 常時     | アップロード | ファイル未選択時は無効         |

#### 入力チェック

| 項目名     | チェック内容              | エラーメッセージ                          |
| ---------- | ------------------------- | ----------------------------------------- |
| ファイル   | 必須チェック              | ファイルを選択してください                |
| ファイル   | サイズチェック（10MB）    | ファイルサイズは10MB以下にしてください    |
| ファイル   | 形式チェック              | 対応していないファイル形式です            |
| カテゴリ   | 必須チェック              | カテゴリを選択してください                |
| ファイル名 | 必須チェック              | ファイル名を入力してください              |
| ファイル名 | 文字数チェック（100文字） | ファイル名は100文字以下で入力してください |

### ファイル表示モーダル

#### 画面項目

| 項目名             | コンポーネント | 必須 | 表示条件 | 初期値 | 備考                      |
| ------------------ | -------------- | ---- | -------- | ------ | ------------------------- |
| ファイルプレビュー | Image/PDF      | ◯    | 常時     | -      | 画像・PDFはプレビュー表示 |
| ファイル情報       | InfoSection    | ◯    | 常時     | -      | ファイル詳細情報          |
| 編集ボタン         | Button         | -    | 常時     | 編集   | ファイル編集モーダルへ    |
| 削除ボタン         | Button         | -    | 常時     | 削除   | 削除確認モーダルへ        |
| ダウンロードボタン | Button         | -    | 常時     | DL     | ファイルダウンロード      |
| 閉じるボタン       | Button         | -    | 常時     | 閉じる | モーダルクローズ          |

### ファイル編集モーダル

#### 画面項目

| 項目名           | コンポーネント | 必須 | 表示条件 | 初期値     | 備考                  |
| ---------------- | -------------- | ---- | -------- | ---------- | --------------------- |
| カテゴリ         | Select         | ◯    | 常時     | 現在の値   | 変更可能              |
| ファイル名       | Input          | ◯    | 常時     | 現在の値   | 変更可能              |
| 説明             | Textarea       | -    | 常時     | 現在の値   | 変更可能、500文字まで |
| キャンセルボタン | Button         | -    | 常時     | キャンセル | モーダルクローズ      |
| 更新ボタン       | Button         | -    | 常時     | 更新       | フォーム送信          |

### 削除確認モーダル

#### 画面項目

| 項目名           | コンポーネント | 必須 | 表示条件 | 初期値       | 備考                 |
| ---------------- | -------------- | ---- | -------- | ------------ | -------------------- |
| 確認メッセージ   | Text           | ◯    | 常時     | 削除確認文言 | ファイル名を含む     |
| 注意事項         | Alert          | ◯    | 常時     | 注意文言     | 赤色背景で警告表示   |
| キャンセルボタン | Button         | -    | 常時     | キャンセル   | モーダルクローズ     |
| 削除実行ボタン   | Button         | -    | 常時     | 削除         | 赤色、確認後削除実行 |

## 入力チェック・バリデーション

### 表示制御

- ファイル一覧: 有効ステータスのファイルのみ表示
- ファイル数表示: フィルタ適用後の件数を動的表示
- 空状態: ファイルが存在しない、またはフィルタ結果が0件の場合に表示
- プレビュー: 画像ファイル（JPG, PNG, GIF, WebP）のみサムネイル表示

### エラーハンドリング

- ファイル取得エラー: モックデータによるフォールバック
- アップロードエラー: ユーザーフレンドリーなエラーメッセージ表示
- ファイルサイズ超過: アップロード前チェックとアラート表示
- 対応外ファイル形式: ファイル選択時チェックとエラー表示

## UI/UX仕様

### レスポンシブデザイン

- **モバイル（〜768px）**:
  - ファイル一覧を1列表示
  - フィルタエリアを縦並び配置
  - モーダルを全画面表示
- **タブレット（768px〜1024px）**:
  - ファイル一覧を2列グリッド表示
  - フィルタエリアを横並び配置
- **デスクトップ（1024px〜）**:
  - ファイル一覧を3〜4列グリッド表示
  - 全要素を横並び配置

### カラーテーマ

- **アップロードボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark`
- **検索バー**: `border-gray-300 focus:border-carebase-blue`
- **ファイルカード**: `bg-white border-gray-200 hover:shadow-md`
- **カテゴリバッジ**: カテゴリごとの専用カラー（上記参照）
- **アクションボタン**: `text-gray-600 hover:text-carebase-blue`
- **危険操作**: `text-red-600 hover:text-red-700`

### アニメーション

- **ファイルカードホバー**: `transition-shadow duration-200`
- **モーダル表示**: `fade-in ease-out duration-300`
- **ローディング状態**: `animate-spin` スピナー表示
- **フィルタ適用**: `transition-opacity duration-200`

### アクセシビリティ

- **キーボードナビゲーション**: Tab順序の最適化
- **スクリーンリーダー**: 適切なaria-label、alt属性の設定
- **フォーカス管理**: モーダル内でのフォーカストラップ
- **コントラスト**: WCAG AA準拠の色彩設計

## データ仕様

### ファイルエンティティ

```typescript
interface ResidentFile {
  id: string; // ファイルID
  residentId: string; // 利用者ID
  fileName: string; // 表示用ファイル名
  originalFileName: string; // 元のファイル名
  fileType: string; // MIMEタイプ
  fileSize: number; // ファイルサイズ（バイト）
  category: ResidentFileCategory; // カテゴリ
  status: ResidentFileStatus; // ステータス（active/archived）
  description?: string; // 説明
  uploadedAt: string; // アップロード日時（ISO 8601）
  uploadedBy: string; // アップロード者ID
  uploadedByName: string; // アップロード者名
  url: string; // ファイルURL
  thumbnailUrl?: string; // サムネイルURL（画像の場合）
  isImage: boolean; // 画像ファイルか
  isDocument: boolean; // 文書ファイルか
}
```

### API仕様

#### ファイル一覧取得

- **エンドポイント**: `GET /v1/residents/{residentId}/files`
- **レスポンス**: `ResidentFile[]`

#### ファイルアップロード

- **エンドポイント**: `POST /v1/residents/{residentId}/files`
- **リクエスト**: `FormData` (file, category, fileName, description)
- **レスポンス**: `ResidentFile`

#### ファイル更新

- **エンドポイント**: `PUT /v1/residents/{residentId}/files/{fileId}`
- **リクエスト**: `ResidentFileFormData`
- **レスポンス**: `ResidentFile`

#### ファイル削除

- **エンドポイント**: `DELETE /v1/residents/{residentId}/files/{fileId}`
- **レスポンス**: `void`

## 参考資料

- [利用者詳細画面設計書](../README.md)
- [ResidentFilesTabContent コンポーネント](../../../../../components/3_organisms/resident-files/resident-files-tab-content.tsx)
- [FileFilters コンポーネント](../../../../../components/2_molecules/resident-files/file-filters.tsx)
- [FileUploadForm コンポーネント](../../../../../components/2_molecules/resident-files/file-upload-form.tsx)
- [ResidentFileService](../../../../../services/residentFileService.ts)
- [ResidentFile型定義](../../../../../types/resident-file.ts)
- [画面一覧](../../../../../docs/screen-list.md#利用者管理)
