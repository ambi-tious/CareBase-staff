# 既往歴タブ設計書

画面名: `既往歴タブ`  
パス: `/residents/[residentId]` (詳細情報タブ内)  
URL: https://carebase-staff.vercel.app/residents/[residentId]

## 概要

CareBase-staffアプリケーションの利用者詳細画面内の既往歴タブ設計書です。  
利用者の既往歴情報の表示、登録、編集、削除機能を提供します。  
複数の既往歴を登録可能で発症年月順でソート表示し、各既往歴の詳細情報を効率的に管理できます。

## 全体レイアウト

### 画面構成

<img width="1046" height="405" alt="image" src="https://github.com/user-attachments/assets/933bd707-7ba0-4523-a77c-c1820aac63bb" />

タブ内で完結する既往歴情報管理インターフェース：

- タブヘッダー（既往歴タブ選択状態）
- 追加ボタン（右上配置）
- 既往歴カード一覧（発症年月順ソート表示）
- 空状態メッセージ（データなし時）

### 画面項目

| 項目名             | コンポーネント       | 必須 | 表示条件         | 初期値               | 備考                                    |
| ------------------ | -------------------- | ---- | ---------------- | -------------------- | --------------------------------------- |
| タブヘッダー       | TabsTrigger          | -    | 常時             | 既往歴               | アクティブ状態で青色表示                |
| 追加ボタン         | Button               | -    | 常時             | 追加                 | 右上配置、プラスアイコン付き            |
| 既往歴カード       | MedicalHistoryCard   | -    | データ存在時     | -                    | 発症年月降順でソート表示                |
| 空状態メッセージ   | テキスト             | -    | データなし時     | 既往歴はありません。 | 中央配置、Stethoscopeアイコン付き       |
| 病名               | CardTitle            | ◯    | カード内         | -                    | 大文字、太字、青色                      |
| 治療状況バッジ     | Badge                | ◯    | カード内         | -                    | 治療中/完治/経過観察/その他             |
| 発症年月           | テキスト             | ◯    | カード内         | -                    | Calendarアイコン付き、YYYY/MM形式       |
| 治療機関           | テキスト             | -    | カード内         | -                    | Building2アイコン付き                   |
| 備考               | テキスト             | -    | カード内         | -                    | 境界線付きで下部表示                    |
| 編集ボタン         | Button               | -    | カード内         | 編集                 | 鉛筆アイコン付き                        |
| 削除ボタン         | Button               | -    | カード内         | 削除                 | ゴミ箱アイコン付き、赤色                |

## 機能仕様

### アクション

| 項目名     | 処理内容                     | 対象API                                    | 遷移先画面                 |
| ---------- | ---------------------------- | ------------------------------------------ | -------------------------- |
| 追加ボタン | 既往歴登録モーダルを表示     | -                                          | 同一画面（モーダル表示）   |
| 編集ボタン | 既往歴編集モーダルを表示     | -                                          | 同一画面（モーダル表示）   |
| 削除ボタン | 削除確認モーダルを表示       | -                                          | 同一画面（モーダル表示）   |
| 登録処理   | 新しい既往歴情報を登録       | `residentDataService.createMedicalHistory` | 同一画面（モーダル閉じる） |
| 編集処理   | 既存の既往歴情報を更新       | `residentDataService.updateMedicalHistory` | 同一画面（モーダル閉じる） |
| 削除処理   | 既存の既往歴情報を削除       | `residentDataService.deleteMedicalHistory` | 同一画面（モーダル閉じる） |

### モーダル仕様

#### 登録モーダル

<img width="824" height="587" alt="image" src="https://github.com/user-attachments/assets/df016e3e-2335-4678-9edf-b65e13d2054e" />

| 項目名           | コンポーネント    | 必須 | 初期値                                       | 備考                                      |
| ---------------- | ----------------- | ---- | -------------------------------------------- | ----------------------------------------- |
| モーダルタイトル | DialogTitle       | -    | 既往歴の登録                                 | 太字、青色                                |
| 説明文           | DialogDescription | -    | {利用者名}様の既往歴情報を登録してください   | 必須項目説明付き                          |
| 病名入力         | Input             | ◯    | -                                            | プレースホルダー: 高血圧症                |
| 発症年月入力     | Input             | ◯    | -                                            | プレースホルダー: 2023-01、YYYY-MM形式    |
| 治療状況選択     | Select            | ◯    | 治療中                                       | 治療中/完治/経過観察/その他               |
| 治療機関入力     | Input             | -    | -                                            | プレースホルダー: 〇〇病院                |
| 備考入力         | Textarea          | -    | -                                            | プレースホルダー: その他の情報があれば... |
| キャンセルボタン | Button            | -    | キャンセル                                   | アウトライン、グレー                      |
| 登録ボタン       | Button            | -    | 登録                                         | 青色、送信時は「登録中...」               |

#### 編集モーダル

登録モーダルと同様の構成で、以下の違いがあります：

| 項目名           | 相違点                           |
| ---------------- | -------------------------------- |
| モーダルタイトル | 既往歴の編集                     |
| フォーム初期値   | 既存データで各フィールドを初期化 |
| 登録ボタンラベル | 更新                             |

#### 削除確認モーダル

| 項目名           | コンポーネント | 必須 | 初期値                                             | 備考                       |
| ---------------- | -------------- | ---- | -------------------------------------------------- | -------------------------- |
| モーダルタイトル | DialogTitle    | -    | 削除の確認                                         | 警告アイコン付き、赤色     |
| 警告メッセージ   | Alert          | -    | この操作は取り消すことができません。               | 上部警告                   |
| 確認メッセージ   | Alert          | -    | {病名} の既往歴情報を削除してもよろしいですか？    | 削除対象明示               |
| 注意事項         | テキスト       | -    | 削除されたデータは復元できません。                 | 赤色背景                   |
| キャンセルボタン | Button         | -    | キャンセル                                         | アウトライン、グレー       |
| 削除ボタン       | Button         | -    | 削除する                                           | 赤色、ゴミ箱アイコン付き   |

### 入力チェック

| 項目名   | イベント | チェック内容                  | エラーメッセージ                        |
| -------- | -------- | ----------------------------- | --------------------------------------- |
| 病名     | blur     | 必須入力チェック              | 病名は必須です                          |
| 病名     | blur     | 文字数チェック（100文字以内） | 病名は100文字以内で入力してください     |
| 発症年月 | blur     | 必須入力チェック              | 発症年月は必須です                      |
| 発症年月 | blur     | 形式チェック（YYYY-MM）       | 有効な年月を入力してください（YYYY-MM） |
| 発症年月 | blur     | 過去日付チェック              | 発症年月は過去の日付を入力してください  |
| 治療状況 | change   | 必須選択チェック              | 治療状況は必須です                      |
| 治療状況 | change   | 選択肢チェック                | 有効な治療状況を選択してください        |
| 治療機関 | blur     | 文字数チェック（100文字以内） | 治療機関は100文字以内で入力してください |
| 備考     | blur     | 文字数チェック（500文字以内） | 備考は500文字以内で入力してください     |
| フォーム | submit   | 全必須項目チェック            | 必須項目をすべて入力してください        |

### バリデーション仕様

#### 入力形式

- **病名**: 1文字以上100文字以内
- **発症年月**: YYYY-MM形式、過去の日付のみ許可
- **治療状況**: 治療中/完治/経過観察/その他から選択
- **治療機関**: 100文字以内（任意）
- **備考**: 500文字以内（任意）

#### 表示制御

- **既往歴ソート**: 発症年月の新しい順（降順）で表示
- **治療状況バッジ**:
  - 治療中: `bg-blue-100 text-blue-700`
  - 完治: `bg-green-100 text-green-700`
  - 経過観察: `bg-yellow-100 text-yellow-700`
  - その他: `bg-gray-100 text-gray-700`
- **空状態**: 既往歴が登録されていない場合の案内表示
- **条件表示**: 治療機関、備考は入力されている場合のみ表示
- 必須項目には赤いアスタリスク（*）を表示
- エラー時は該当フィールドを赤枠で強調
- 送信中はフォーム全体を無効化

#### エラーハンドリング

- バリデーションエラーの個別表示
- ネットワークエラーの統一表示
- 削除処理エラーの表示
- 楽観的更新とエラー時のロールバック
- **API通信エラー**: ネットワークエラー時のリトライ機能
- **削除エラー**: 削除失敗時のエラーメッセージ表示
- **フォームエラー**: 入力値検証エラーの項目別表示
- **同時編集制御**: 楽観的ロック制御

## UI/UX仕様

### レスポンシブデザイン

- **既往歴カード**: 1列（モバイル）→ 1列（タブレット・デスクトップ）
- **フォームレイアウト**: 1列（モバイル）→ 2列（タブレット以上）
- **カード内情報**: 1列（モバイル）→ 2列（タブレット以上）
- **モバイル（〜768px）**:
  - 既往歴カードを1列で縦並び表示
  - 追加ボタンを上部に固定配置
  - カード内情報を縦積み表示
- **タブレット（768px〜1024px）**:
  - 既往歴カードを1列で表示
  - カード内情報を2列グリッドで表示
  - ボタンエリアは右寄せ表示
- **デスクトップ（1024px〜）**:
  - 既往歴カードを1列で表示
  - カード内情報を2列グリッドで表示
  - モーダルは最大幅4xlで中央表示

### カラーテーマ

- **追加ボタン**: `border-carebase-blue text-carebase-blue hover:bg-carebase-blue-light`
- **編集ボタン**: `variant="outline"` デフォルトスタイル
- **削除ボタン**: `border-red-300 text-red-600 hover:bg-red-50`
- **登録ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark`
- **病名**: `text-carebase-blue font-bold text-xl`
- **治療状況バッジ**: 状況に応じた色分け（上記参照）
- **情報ラベル**: `text-gray-500 text-sm font-medium`
- **情報値**: `text-carebase-text-primary`

### アイコン使用

- **追加ボタン**: `PlusCircle` アイコン
- **編集ボタン**: `Edit3` アイコン
- **削除ボタン**: `Trash2` アイコン
- **発症年月**: `Calendar` アイコン
- **治療機関**: `Building2` アイコン
- **空状態**: `Stethoscope` アイコン
- **エラー表示**: `AlertCircle` アイコン

### アニメーション

- **モーダル表示**: フェードイン・スケールアニメーション
- **カード追加**: スムーズな挿入アニメーション
- **削除処理**: ローディングスピナー表示
- **ホバー効果**: ボタンの背景色変更トランジション
- **カードホバー**: `hover:shadow-md transition-shadow duration-200`
- **ボタンホバー**: カラー変更アニメーション
- **モーダル表示**: フェードイン・アウト効果

### アクセシビリティ

- **フォーカス管理**: モーダル内でのキーボードナビゲーション
- **スクリーンリーダー対応**: 適切なaria-label設定
  - 追加ボタン: `aria-label="新しい既往歴を追加"`
  - 編集ボタン: `aria-label="${病名}の既往歴を編集"`
  - 削除ボタン: `aria-label="${病名}の既往歴を削除"`
- **エラー表示**: role="alert"でエラーメッセージを通知
- **必須項目表示**: 視覚的・音声的な必須項目の明示
- **キーボードナビゲーション**: Tab キーでの要素移動対応
- **コントラスト**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスインジケーター

## 参考資料

- [利用者詳細画面実装](../page.tsx)
- [ResidentDetailTabs コンポーネント](../../../../components/3_organisms/resident/resident-detail-tabs.tsx)
- [MedicalHistoryCard コンポーネント](../../../../components/2_molecules/resident/medical-history-card.tsx)
- [MedicalHistoryModal コンポーネント](../../../../components/3_organisms/modals/medical-history-modal.tsx)
- [MedicalHistoryForm コンポーネント](../../../../components/2_molecules/forms/medical-history-form.tsx)
- [MedicalHistory Types](../../../../types/resident-data.ts)
- [ResidentDataService](../../../../services/residentDataService.ts)
- [Issue #172: [設計] #005-4 利用者｜利用者詳細（既往歴）](https://github.com/ambi-tious/CareBase-staff/issues/172)
- [親Issue #133: [設計] #005 利用者｜利用者詳細（基本情報）](https://github.com/ambi-tious/CareBase-staff/issues/133)
- [画面一覧](../../../../docs/screen-list.md#利用者管理)
