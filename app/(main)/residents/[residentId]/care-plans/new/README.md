# ケアプラン登録画面設計書

- 画面名: `ケアプラン登録`
- パス: `/residents/[residentId]/care-plans/new`
- URL: https://carebase-staff.vercel.app/residents/1/care-plans/new

## 概要

ケアプラン登録画面設計書です。
利用者の施設サービス計画を新規作成するためのフォーム画面です。
施設サービス計画の作成に必要な項目を入力し、ケアプランの新規登録を行う機能を実装します。
利用者詳細画面のケアプラン一覧から遷移し、登録完了後は新しく作成されたケアプランの詳細画面に自動遷移します。

Issue: [#113 [設計] #015 利用者｜ケアプラン登録](https://github.com/ambi-tious/CareBase-staff/issues/113)

## 全体レイアウト
<img width="1026" height="1757" alt="image" src="https://github.com/user-attachments/assets/dce7587f-d1e1-4014-8e47-fe4965811874" />

### 画面構成

職員による利用者のケアプラン情報入力のためのフォーム画面として以下の要素で構成：

- ページヘッダー（画面タイトル、利用者情報、戻るボタン）
- エラー表示エリア（入力エラー時に表示）
- 施設サービス計画情報入力フォーム（セクション別レイアウト）
- 基本情報入力フォーム
- 計画内容入力フォーム
- 同意チェック
- アクションボタン（キャンセル、登録）

### 画面項目

| 項目名 | コンポーネント | 必須 | 表示条件 | 初期値 | 備考 |
| ------ | -------------- | ---- | -------- | ------ | ---- |
| 戻るボタン | Button | - | 常時 | 戻る | アウトライン、ArrowLeft アイコン |
| 画面タイトル | Heading | - | 常時 | ケアプラン登録 | ClipboardList アイコン付き |
| 利用者情報表示 | InfoCard | - | 常時 | 利用者名・ID | 対象利用者の基本情報 |
| エラーアラート | Alert | - | 送信エラー時 | - | 赤色背景、エラーメッセージ表示 |

#### 該当ご利用者セクション
| プラン種別 | FormSelect | ◯ | 常時 | 初回 | 選択肢：初回/紹介/継続 |
| 認定状況 | FormSelect | ◯ | 常時 | 認定済み | 選択肢：認定済み/申請中 |

#### 施設サービス計画セクション
| 作成者氏名 | FormField | ◯ | 常時 | localStorage自動取得 | ログイン職員名を自動設定 |
| 作成者職種 | FormSelect | ◯ | 常時 | localStorage自動取得 | 職種選択肢から選択 |
| 作成介護保険施設名 | FormField | ◯ | 常時 | localStorage自動取得 | 事業所名を自動設定 |
| 施設所在地 | FormField | ◯ | 常時 | localStorage自動取得 | 施設住所を自動設定 |
| 作成日 | FormField | ◯ | 常時 | 今日の日付 | 日付入力 |
| 変更日［更新日］ | FormField | - | 常時 | 空文字 | 日付入力（任意） |

#### 基本情報セクション
| 初回施設サービス計画作成日 | FormField | ◯ | 常時 | 今日の日付 | 日付入力 |
| 認定日 | FormField | ◯ | 常時 | 空文字 | 日付入力 |
| 認定有効期限開始日 | FormField | ◯ | 常時 | 空文字 | 日付入力 |
| 認定有効期限終了日 | FormField | ◯ | 常時 | 開始日+1年-1日 | 日付入力、開始日から自動計算 |

#### 計画内容セクション
| 要介護状態区分 | FormSelect | ◯ | 常時 | 空文字 | 選択肢：要介護1-5 |
| 利用者及び家族の生活に対する意向 | Textarea | ◯ | 常時 | 空文字 | 大きなテキストエリア、500文字制限 |
| 介護認定審査会の意見及びサービスの種類の指定 | Textarea | ◯ | 常時 | 空文字 | 大きなテキストエリア、500文字制限 |
| 総合的な援助の指針 | Textarea | ◯ | 常時 | 空文字 | 大きなテキストエリア、1000文字制限 |
| 備考 | Textarea | - | 常時 | 空文字 | テキストエリア、500文字制限 |
| 同意チェック | Checkbox | ◯ | 常時 | false | 「施設サービス計画について説明を行い同意を得た」 |

#### アクションボタン
| キャンセルボタン | Button | - | 常時 | キャンセル | アウトライン |
| 登録ボタン | Button | - | 常時 | 登録 | 青色スタイル、Save アイコン |

## 機能仕様

### アクション

| 項目名 | 処理内容 | 対象API | 遷移先画面 |
| ------ | -------- | ------- | ---------- |
| 戻るボタン | ケアプラン一覧画面に戻る | - | ケアプラン一覧画面 (`/residents/[residentId]/care-plans`) |
| フォーム入力 | リアルタイムバリデーション実行 | - | 同一画面（エラー表示更新） |
| キャンセルボタン | 入力内容を破棄して一覧に戻る | - | ケアプラン一覧画面 (`/residents/[residentId]/care-plans`) |
| 登録ボタン | ケアプラン情報を保存して詳細画面に遷移 | `POST /api/v1/care-plans` | ケアプラン詳細画面 (`/residents/[residentId]/care-plans/[planId]`) |

### 入力チェック

| 項目名 | イベント | チェック内容 | エラーメッセージ |
| ------ | -------- | ------------ | ---------------- |
| 利用者区分 | select | 必須チェック | 利用者区分は必須です |
| 認定状況 | select | 必須チェック | 認定状況は必須です |
| 作成者氏名 | input | 必須チェック | 作成者氏名は必須です |
| 作成者職種 | select | 必須チェック | 作成者職種は必須です |
| 作成介護保険施設名 | input | 必須チェック | 作成介護保険施設名は必須です |
| 施設所在地 | input | 必須チェック | 施設所在地は必須です |
| 作成日 | input | 必須チェック | 作成日は必須です |
| 初回施設サービス計画作成日 | input | 必須チェック | 初回施設サービス計画作成日は必須です |
| 認定日 | input | 必須チェック | 認定日は必須です |
| 認定有効期限開始日 | input | 必須チェック | 認定有効期限開始日は必須です |
| 認定有効期限終了日 | input | 必須チェック | 認定有効期限終了日は必須です |
| 認定有効期限終了日 | input | 日付整合性チェック | 終了日は開始日より後の日付を入力してください |
| 要介護状態区分 | select | 必須チェック | 要介護状態区分は必須です |
| 利用者及び家族の意向 | textarea | 必須チェック | 利用者及び家族の生活に対する意向は必須です |
| 利用者及び家族の意向 | textarea | 文字数チェック（500文字以内） | 意向は500文字以内で入力してください |
| 審査会の意見 | textarea | 必須チェック | 介護認定審査会の意見は必須です |
| 審査会の意見 | textarea | 文字数チェック（500文字以内） | 意見は500文字以内で入力してください |
| 総合的な援助の指針 | textarea | 必須チェック | 総合的な援助の指針は必須です |
| 総合的な援助の指針 | textarea | 文字数チェック（1000文字以内） | 指針は1000文字以内で入力してください |
| 備考 | textarea | 文字数チェック（500文字以内） | 備考は500文字以内で入力してください |
| 同意チェック | checkbox | 必須チェック | 施設サービス計画について説明を行い同意を得たかチェックしてください |

### バリデーション仕様

#### リアルタイムバリデーション
- **入力時検証**: フォーム項目への入力と同時にバリデーションを実行（`mode: 'onChange'`）
- **エラー表示**: 各項目下部に赤色でエラーメッセージを表示
- **送信制御**: バリデーションエラーがある場合は登録ボタンクリック時に送信を阻止
- **バリデーションライブラリ**: Zod + React Hook Form

#### 文字数制限
- **利用者及び家族の意向**: 500文字以内、リアルタイム文字数表示
- **審査会の意見**: 500文字以内、リアルタイム文字数表示
- **総合的な援助の指針**: 1000文字以内、リアルタイム文字数表示
- **備考**: 500文字以内、リアルタイム文字数表示

#### 日付検証
- **認定有効期限**: 終了日が開始日より後の日付であることを確認
- **作成日**: 未来日の制限（現在日より未来の日付は警告表示）
- **認定日**: 未来日の制限（現在日より未来の日付は警告表示）

#### エラーハンドリング

| エラー種別 | 発生条件 | 表示メッセージ | 表示場所 |
| ---------- | -------- | -------------- | -------- |
| API通信エラー | ケアプラン作成API失敗 | ケアプランの登録に失敗しました。もう一度お試しください。 | 画面上部アラート |
| バリデーションエラー | 必須項目未入力時の送信 | 入力内容に不備があります。必須項目を確認してください。 | 画面上部アラート |
| フィールド個別エラー | リアルタイムバリデーション | 各項目固有のエラーメッセージ | 該当フィールド下部 |
| 同意チェックエラー | 同意チェック未確認時の送信 | 施設サービス計画について説明を行い同意を得たかチェックしてください | 同意チェック下部 |

## UI/UX仕様

### レスポンシブデザイン

- **モバイル（〜768px）**:
  - フォーム項目を1列で縦並び表示
  - セクション間の余白を最小化
  - ボタンを全幅で縦積み配置
- **タブレット（768px〜1024px）**:
  - フォーム項目を2列グリッドで表示
  - セクション見出しを明確に分離
  - ボタンを右寄せで横並び配置
- **デスクトップ（1024px〜）**:
  - フォーム全体の最大幅を6xlに制限
  - 2列グリッドレイアウトを維持
  - 十分な余白を確保

### カラーテーマ

- **背景色**: `bg-carebase-bg` - アプリケーション標準背景色
- **登録ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark` - メインアクション
- **戻る・キャンセルボタン**: `border-gray-300 text-gray-700` - セカンダリアクション
- **エラーアラート**: `bg-red-50 border-red-200 text-red-700` - エラー状態
- **必須マーク**: `text-red-500` - 必須項目表示
- **セクション見出し**: `text-carebase-text-primary border-b` - セクション分割
- **利用者情報カード**: `bg-blue-50 border-blue-200 text-blue-800` - 情報表示

### フォームUI仕様

- **セクション分割**: 該当ご利用者、施設サービス計画、基本情報、計画内容を明確に分離
- **フィールド間隔**: `gap-6` - 項目間の適切な間隔
- **ラベル配置**: 各入力フィールドの上部に配置
- **プレースホルダー**: 入力例を示すサンプルテキスト
- **フォーカス状態**: 青色のアウトライン表示
- **文字数カウンター**: テキストエリアの下部に表示

### アニメーション

- **ボタンホバー**: スムーズなカラートランジション
- **フォーム送信**: ローディング状態の表示（「登録中...」）
- **エラー表示**: フェードイン効果でアラート表示
- **バリデーション**: リアルタイムでエラーメッセージ表示・非表示
- **セクション展開**: スムーズなアコーディオン効果（必要に応じて）

### アクセシビリティ

- **キーボードナビゲーション**: Tabキーでの順次フォーカス移動
- **スクリーンリーダー**:
  - 適切なlabel要素の関連付け
  - 必須項目のaria-required属性
  - エラーメッセージのaria-describedby属性
  - セクション見出しのheading要素
- **コントラスト比**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスリング表示

### ローディング・無効化状態

#### 送信中状態（isSubmitting: true）
- **フォーム全体**: `disabled={isSubmitting}` で全入力フィールドを無効化
- **戻るボタン**: クリック無効化で誤操作防止
- **キャンセルボタン**: クリック無効化で誤操作防止
- **登録ボタン**:
  - テキスト変更: 「登録」→「登録中...」
  - クリック無効化: `disabled={isSubmitting}`
  - ローディング表示: Saveアイコン継続表示

#### 自動設定フィールド
- **作成者関連フィールド**: localStorage から自動設定、編集可能
- **日付フィールド**: デフォルト値を自動設定、編集可能
- **視覚的表示**: 通常の入力フィールドと同様の表示

## 技術仕様

### 使用コンポーネント

#### 3_organisms層
- **CarePlanRegistrationForm**: ケアプラン登録フォーム全体

#### 2_molecules層
- **CarePlanBasicInfoForm**: 基本情報セクション
- **CarePlanContentForm**: 計画内容セクション
- **FacilityServicePlanForm**: 施設サービス計画セクション

#### 1_atoms層
- **FormField**: 基本入力フィールド
- **FormSelect**: 選択フィールド
- **Textarea**: テキストエリア
- **Checkbox**: チェックボックス
- **Button**: アクションボタン

#### カスタムフック
- **useCarePlanForm**: フォーム状態管理とバリデーション

### データ型定義

```typescript
interface CarePlanRegistrationData {
  // 該当ご利用者
  residentType: 'initial' | 'referral' | 'continuation'; // 初回/紹介/継続
  certificationStatus: 'certified' | 'pending'; // 認定済み/申請中
  
  // 施設サービス計画
  creatorName: string; // 作成者氏名（必須）
  creatorJobTitle: string; // 作成者職種（必須）
  facilityName: string; // 作成介護保険施設名（必須）
  facilityAddress: string; // 施設所在地（必須）
  createdDate: string; // 作成日（必須）
  updatedDate?: string; // 変更日［更新日］（任意）
  
  // 基本情報
  initialPlanDate: string; // 初回施設サービス計画作成日（必須）
  certificationDate: string; // 認定日（必須）
  certValidityStart: string; // 認定有効期限開始日（必須）
  certValidityEnd: string; // 認定有効期限終了日（必須、開始日から自動計算）
  
  // 計画内容
  careLevel: string; // 要介護状態区分（必須）
  residentIntention: string; // 利用者及び家族の意向（必須、500文字以内）
  assessmentCommitteeOpinion: string; // 審査会の意見（必須、500文字以内）
  comprehensiveGuidance: string; // 総合的な援助の指針（必須、1000文字以内）
  notes?: string; // 備考（任意、500文字以内）
  consentObtained: boolean; // 同意チェック（必須）
}
```

### API仕様

| メソッド | エンドポイント | 説明 |
| -------- | -------------- | ---- |
| POST | `/api/v1/care-plans` | ケアプラン新規作成 |
| GET | `/api/v1/residents/{residentId}` | 利用者情報取得 |
| GET | `/api/v1/staff/current` | 現在のスタッフ情報取得 |

#### リクエスト例
```json
{
  "residentId": "1",
  "residentType": "initial",
  "certificationStatus": "certified",
  "creatorName": "山田太郎",
  "creatorJobTitle": "介護支援専門員",
  "facilityName": "こうべ介護老人保健施設",
  "facilityAddress": "兵庫県神戸市中央区...",
  "createdDate": "2025-01-31",
  "initialPlanDate": "2025-01-31",
  "certificationDate": "2025-01-15",
  "certValidityStart": "2025-01-15",
  "certValidityEnd": "2026-01-14",
  "careLevel": "要介護1",
  "residentIntention": "自宅での生活を継続したい...",
  "assessmentCommitteeOpinion": "要介護1の認定は適切...",
  "comprehensiveGuidance": "血圧管理を中心とした...",
  "notes": "血圧管理に注意が必要",
  "consentObtained": true
}
```

## 参考資料

- [Issue #113: [設計] #015 利用者｜ケアプラン登録](https://github.com/ambi-tious/CareBase-staff/issues/113)
- [ケアプラン編集画面設計書 (#111)](https://github.com/ambi-tious/CareBase-staff/issues/111)
- [利用者詳細（ケアプラン）画面設計書 (#115)](https://github.com/ambi-tious/CareBase-staff/issues/115)
- [CareBase-staff設計書フォーマット (#141)](https://github.com/ambi-tious/CareBase-staff/issues/141)
- [Care Plan Types](../../../../types/care-plan.ts)
- [Care Plan Mock Data](../../../../mocks/care-plan-data.ts)
- [利用者登録画面設計書](../../new/README.md) - フォーム設計の参考
- [申し送り作成画面設計書](../../../handovers/new/README.md) - フォーム設計の参考
- [標準設計書](../../../../docs/standard-design-document.md)
- [画面一覧](../../../../docs/screen-list.md)
