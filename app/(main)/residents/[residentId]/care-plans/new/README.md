# ケアプラン登録画面設計書

- 画面名: `新規ケアプラン作成`
- パス: `/residents/[residentId]/care-plans/new`
- URL: https://carebase-staff.vercel.app/residents/1/care-plans/new

## 概要

ケアプラン登録画面設計書です。
利用者の施設サービス計画を新規作成するためのフォーム画面です。
施設サービス計画の作成に必要な項目を入力し、ケアプランの新規登録を行う機能を実装します。
利用者詳細画面のケアプラン一覧から遷移し、登録完了後は新しく作成されたケアプランの詳細画面に自動遷移します。

Issue: [#113 [設計] #015 利用者｜ケアプラン登録](https://github.com/ambi-tious/CareBase-staff/issues/113)

## 全体レイアウト

<img width="1026" height="1757" alt="image" src="https://github.com/user-attachments/assets/dce7587f-d1e1-4014-8e47-fe4965811874" />

### 画面構成

職員による利用者のケアプラン情報入力のためのフォーム画面として以下の要素で構成：

- ページヘッダー（画面タイトル、利用者情報、戻るボタン）
- エラー表示エリア（入力エラー時に表示）
- 施設サービス計画情報入力フォーム（セクション別レイアウト）
- 基本情報入力フォーム
- 計画内容入力フォーム
- 同意チェック
- アクションボタン（キャンセル、登録）

### 画面項目

| 項目名         | コンポーネント | 必須 | 表示条件     | 初期値             | 備考                             |
| -------------- | -------------- | ---- | ------------ | ------------------ | -------------------------------- |
| 戻るボタン     | Button         | -    | 常時         | 戻る               | アウトライン、ArrowLeft アイコン |
| 画面タイトル   | Heading        | -    | 常時         | 新規ケアプラン作成 | FileText アイコン付き            |
| 利用者情報表示 | InfoCard       | -    | 常時         | 利用者名・ID       | 対象利用者の基本情報             |
| エラーアラート | Alert          | -    | 送信エラー時 | -                  | 赤色背景、エラーメッセージ表示   |

#### 作成者情報表示

| 作成者情報カード | InfoCard | - | 常時 | localStorage自動取得 | ログイン職員情報を自動表示、青背景 |

#### 基本情報セクション

| プラン名 | FormField | ◯ | 常時 | 空文字 | 例：2025年度 第1期ケアプラン |
| プラン種別 | FormSelect | ◯ | 常時 | 空文字 | 選択肢：初回/継続 |
| 紹介 | Checkbox | ◯ | 常時 | false | 紹介あり/なしのラジオボタン形式 |
| 要介護度 | FormSelect | ◯ | 常時 | 空文字 | 選択肢：要介護1-5 |
| 認定状況 | FormSelect | ◯ | 常時 | 空文字 | 選択肢：認定済み/申請中 |
| 認定日 | FormField | ◯ | 常時 | 空文字 | 日付入力 |
| 認定有効開始日 | FormField | ◯ | 常時 | 空文字 | 日付入力 |
| 認定有効終了日 | FormField | ◯ | 常時 | 空文字 | 日付入力、開始日からの検証あり |
| ケアマネージャー | FormField | ◯ | 常時 | 空文字 | 例：山田太郎 |
| 事業所名 | FormField | ◯ | 常時 | 空文字 | 例：こうべケアプランセンター |
| 次回見直し日 | FormField | ◯ | 常時 | 空文字 | 日付入力 |

#### ケア目標セクション

| ケア目標 | DynamicList | ◯ | 常時 | [''] | 動的に追加・削除可能、最低1つ必須 |
| 目標追加ボタン | Button | - | 常時 | 目標を追加 | Plus アイコン付き |
| 目標削除ボタン | Button | - | 2つ以上時 | X | X アイコン付き |

#### 意向・意見セクション

| 利用者の生活に対する意向 | Textarea | ◯ | 常時 | 空文字 | 1000文字制限、文字数カウンター付き |
| 家族の生活に対する意向 | Textarea | ◯ | 常時 | 空文字 | 1000文字制限、文字数カウンター付き |
| 介護認定審査会の意見及びサービスの種類の指定 | Textarea | ◯ | 常時 | 空文字 | 1000文字制限、文字数カウンター付き |
| 総合的な援助の指針 | Textarea | ◯ | 常時 | 空文字 | 1000文字制限、文字数カウンター付き |

#### 備考・同意確認セクション

| 備考 | Textarea | - | 常時 | 空文字 | 1000文字制限、文字数カウンター付き |
| 同意確認 | Checkbox | ◯ | 常時 | false | 「施設サービス計画について説明を行い同意を得た」説明文付き |

#### 利用サービスセクション

| 利用サービス | DynamicList | ◯ | 常時 | [デフォルトサービス] | 動的に追加・削除可能、最低1つ必須 |
| サービス追加ボタン | Button | - | 常時 | サービスを追加 | Plus アイコン付き |
| サービス削除ボタン | Button | - | 2つ以上時 | 削除 | Trash2 アイコン付き |
| サービス名 | FormField | ◯ | サービス存在時 | 空文字 | 例：訪問介護 |
| サービス種別 | FormSelect | ◯ | サービス存在時 | home_care | 訪問介護/デイサービス/ショートステイ/その他 |
| 頻度 | FormField | ◯ | サービス存在時 | 空文字 | 例：週3回 |
| 時間 | FormField | ◯ | サービス存在時 | 空文字 | 例：1時間/回 |
| 提供事業者 | FormField | ◯ | サービス存在時 | 空文字 | 例：ハートケアサービス |
| 開始日 | FormField | ◯ | サービス存在時 | 空文字 | 日付入力 |
| 終了日 | FormField | - | サービス存在時 | 空文字 | 日付入力（任意） |
| メモ | Textarea | - | サービス存在時 | 空文字 | サービス関連メモ |

#### アクションボタン

| キャンセルボタン | Button | - | 常時 | キャンセル | アウトライン |
| 下書き保存ボタン | Button | - | 常時 | 下書き保存 | アウトライン、Save アイコン |
| 作成ボタン | Button | - | 常時 | ケアプランを作成 | 青色スタイル、Send アイコン |

## 機能仕様

### アクション

| 項目名             | 処理内容                               | 対象API                   | 遷移先画面                                                         |
| ------------------ | -------------------------------------- | ------------------------- | ------------------------------------------------------------------ |
| 戻るボタン         | ケアプラン一覧画面に戻る               | -                         | ケアプラン一覧画面 (`/residents/[residentId]/care-plans`)          |
| フォーム入力       | リアルタイムバリデーション実行         | -                         | 同一画面（エラー表示更新）                                         |
| キャンセルボタン   | 入力内容を破棄して一覧に戻る           | -                         | ケアプラン一覧画面 (`/residents/[residentId]/care-plans`)          |
| 下書き保存ボタン   | ケアプラン情報を下書きとして保存       | `POST /api/v1/care-plans` | 同一画面（成功メッセージ表示後継続編集可能）                       |
| 作成ボタン         | ケアプラン情報を保存して詳細画面に遷移 | `POST /api/v1/care-plans` | ケアプラン詳細画面 (`/residents/[residentId]/care-plans/[planId]`) |
| 目標追加ボタン     | ケア目標フィールドを動的に追加         | -                         | 同一画面（フィールド追加）                                         |
| 目標削除ボタン     | 特定のケア目標フィールドを削除         | -                         | 同一画面（フィールド削除）                                         |
| サービス追加ボタン | 利用サービスブロックを動的に追加       | -                         | 同一画面（サービスブロック追加）                                   |
| サービス削除ボタン | 特定の利用サービスブロックを削除       | -                         | 同一画面（サービスブロック削除）                                   |

### 入力チェック

| 項目名                                   | イベント | チェック内容                   | エラーメッセージ                                     |
| ---------------------------------------- | -------- | ------------------------------ | ---------------------------------------------------- |
| プラン名                                 | input    | 必須チェック                   | プラン名は必須です                                   |
| プラン名                                 | input    | 文字数チェック（100文字以内）  | プラン名は100文字以内で入力してください              |
| プラン種別                               | select   | 必須チェック                   | プラン種別は必須です                                 |
| 紹介                                     | checkbox | 必須チェック                   | 紹介情報は必須です                                   |
| 要介護度                                 | select   | 必須チェック                   | 要介護度は必須です                                   |
| 認定状況                                 | select   | 必須チェック                   | 認定状況は必須です                                   |
| 認定日                                   | input    | 必須チェック                   | 認定日は必須です                                     |
| 認定日                                   | input    | 日付形式チェック               | 有効な日付を入力してください（YYYY-MM-DD）           |
| 認定有効開始日                           | input    | 必須チェック                   | 認定有効開始日は必須です                             |
| 認定有効開始日                           | input    | 日付形式チェック               | 有効な日付を入力してください（YYYY-MM-DD）           |
| 認定有効開始日                           | input    | 日付整合性チェック             | 認定有効開始日は認定日以降の日付を入力してください   |
| 認定有効終了日                           | input    | 必須チェック                   | 認定有効終了日は必須です                             |
| 認定有効終了日                           | input    | 日付形式チェック               | 有効な日付を入力してください（YYYY-MM-DD）           |
| 認定有効終了日                           | input    | 日付整合性チェック             | 認定有効終了日は開始日より後の日付を入力してください |
| ケアマネージャー                         | input    | 必須チェック                   | ケアマネージャー名は必須です                         |
| ケアマネージャー                         | input    | 文字数チェック（50文字以内）   | ケアマネージャー名は50文字以内で入力してください     |
| 事業所名                                 | input    | 必須チェック                   | 事業所名は必須です                                   |
| 事業所名                                 | input    | 文字数チェック（100文字以内）  | 事業所名は100文字以内で入力してください              |
| 次回見直し日                             | input    | 必須チェック                   | 次回見直し日は必須です                               |
| 次回見直し日                             | input    | 日付形式チェック               | 有効な日付を入力してください（YYYY-MM-DD）           |
| ケア目標                                 | array    | 必須チェック                   | ケア目標は1つ以上入力してください                    |
| ケア目標（各項目）                       | input    | 必須チェック                   | ケア目標を入力してください                           |
| 利用者の生活に対する意向                 | textarea | 必須チェック                   | 利用者の意向は必須です                               |
| 利用者の生活に対する意向                 | textarea | 文字数チェック（1000文字以内） | 利用者の意向は1000文字以内で入力してください         |
| 家族の生活に対する意向                   | textarea | 必須チェック                   | 家族の意向は必須です                                 |
| 家族の生活に対する意向                   | textarea | 文字数チェック（1000文字以内） | 家族の意向は1000文字以内で入力してください           |
| 介護認定審査会の意見及びサービス種類指定 | textarea | 必須チェック                   | 介護認定審査会の意見は必須です                       |
| 介護認定審査会の意見及びサービス種類指定 | textarea | 文字数チェック（1000文字以内） | 介護認定審査会の意見は1000文字以内で入力してください |
| 総合的な援助の指針                       | textarea | 必須チェック                   | 総合的な援助の指針は必須です                         |
| 総合的な援助の指針                       | textarea | 文字数チェック（1000文字以内） | 総合的な援助の指針は1000文字以内で入力してください   |
| 備考                                     | textarea | 文字数チェック（1000文字以内） | 備考は1000文字以内で入力してください                 |
| 同意確認                                 | checkbox | 必須チェック                   | 同意確認は必須です                                   |
| 利用サービス                             | array    | 必須チェック                   | サービスは1つ以上登録してください                    |
| サービス名                               | input    | 必須チェック                   | サービス名は必須です                                 |
| サービス名                               | input    | 文字数チェック（100文字以内）  | サービス名は100文字以内で入力してください            |
| サービス種別                             | select   | 必須チェック                   | サービス種別は必須です                               |
| 頻度                                     | input    | 必須チェック                   | 頻度は必須です                                       |
| 頻度                                     | input    | 文字数チェック（50文字以内）   | 頻度は50文字以内で入力してください                   |
| 時間                                     | input    | 必須チェック                   | 時間は必須です                                       |
| 時間                                     | input    | 文字数チェック（50文字以内）   | 時間は50文字以内で入力してください                   |
| 提供事業者                               | input    | 必須チェック                   | 提供事業者は必須です                                 |
| 提供事業者                               | input    | 文字数チェック（100文字以内）  | 提供事業者は100文字以内で入力してください            |
| 開始日                                   | input    | 必須チェック                   | 開始日は必須です                                     |
| 開始日                                   | input    | 日付形式チェック               | 有効な日付を入力してください（YYYY-MM-DD）           |
| 終了日                                   | input    | 日付形式チェック               | 有効な日付を入力してください（YYYY-MM-DD）           |
| メモ                                     | textarea | 文字数チェック（500文字以内）  | メモは500文字以内で入力してください                  |

### バリデーション仕様

#### リアルタイムバリデーション

- **入力時検証**: フォーム項目への入力と同時にバリデーションを実行（`mode: 'onChange'`）
- **エラー表示**: 各項目下部に赤色でエラーメッセージを表示
- **送信制御**: バリデーションエラーがある場合は登録ボタンクリック時に送信を阻止
- **バリデーションライブラリ**: Zod + React Hook Form

#### 文字数制限

- **利用者及び家族の意向**: 500文字以内、リアルタイム文字数表示
- **審査会の意見**: 500文字以内、リアルタイム文字数表示
- **総合的な援助の指針**: 1000文字以内、リアルタイム文字数表示
- **備考**: 500文字以内、リアルタイム文字数表示

#### 日付検証

- **認定有効期限**: 終了日が開始日より後の日付であることを確認
- **作成日**: 未来日の制限（現在日より未来の日付は警告表示）
- **認定日**: 未来日の制限（現在日より未来の日付は警告表示）

#### エラーハンドリング

| エラー種別           | 発生条件                   | 表示メッセージ                                                     | 表示場所           |
| -------------------- | -------------------------- | ------------------------------------------------------------------ | ------------------ |
| API通信エラー        | ケアプラン作成API失敗      | ケアプランの登録に失敗しました。もう一度お試しください。           | 画面上部アラート   |
| バリデーションエラー | 必須項目未入力時の送信     | 入力内容に不備があります。必須項目を確認してください。             | 画面上部アラート   |
| フィールド個別エラー | リアルタイムバリデーション | 各項目固有のエラーメッセージ                                       | 該当フィールド下部 |
| 同意チェックエラー   | 同意チェック未確認時の送信 | 施設サービス計画について説明を行い同意を得たかチェックしてください | 同意チェック下部   |

## UI/UX仕様

### レスポンシブデザイン

- **モバイル（〜768px）**:
  - フォーム項目を1列で縦並び表示
  - セクション間の余白を最小化
  - ボタンを全幅で縦積み配置
- **タブレット（768px〜1024px）**:
  - フォーム項目を2列グリッドで表示
  - セクション見出しを明確に分離
  - ボタンを右寄せで横並び配置
- **デスクトップ（1024px〜）**:
  - フォーム全体の最大幅を6xlに制限
  - 2列グリッドレイアウトを維持
  - 十分な余白を確保

### カラーテーマ

- **背景色**: `bg-carebase-bg` - アプリケーション標準背景色
- **登録ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark` - メインアクション
- **戻る・キャンセルボタン**: `border-gray-300 text-gray-700` - セカンダリアクション
- **エラーアラート**: `bg-red-50 border-red-200 text-red-700` - エラー状態
- **必須マーク**: `text-red-500` - 必須項目表示
- **セクション見出し**: `text-carebase-text-primary border-b` - セクション分割
- **利用者情報カード**: `bg-blue-50 border-blue-200 text-blue-800` - 情報表示

### フォームUI仕様

- **セクション分割**: 該当ご利用者、施設サービス計画、基本情報、計画内容を明確に分離
- **フィールド間隔**: `gap-6` - 項目間の適切な間隔
- **ラベル配置**: 各入力フィールドの上部に配置
- **プレースホルダー**: 入力例を示すサンプルテキスト
- **フォーカス状態**: 青色のアウトライン表示
- **文字数カウンター**: テキストエリアの下部に表示

### アニメーション

- **ボタンホバー**: スムーズなカラートランジション
- **フォーム送信**: ローディング状態の表示（「登録中...」）
- **エラー表示**: フェードイン効果でアラート表示
- **バリデーション**: リアルタイムでエラーメッセージ表示・非表示
- **セクション展開**: スムーズなアコーディオン効果（必要に応じて）

### アクセシビリティ

- **キーボードナビゲーション**: Tabキーでの順次フォーカス移動
- **スクリーンリーダー**:
  - 適切なlabel要素の関連付け
  - 必須項目のaria-required属性
  - エラーメッセージのaria-describedby属性
  - セクション見出しのheading要素
- **コントラスト比**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスリング表示

### ローディング・無効化状態

#### 送信中状態（isSubmitting: true）

- **フォーム全体**: `disabled={isSubmitting}` で全入力フィールドを無効化
- **戻るボタン**: クリック無効化で誤操作防止
- **キャンセルボタン**: クリック無効化で誤操作防止
- **下書き保存ボタン**:
  - テキスト変更: 「下書き保存」→「保存中...」
  - クリック無効化: `disabled={isSavingDraft}`
  - ローディング表示: Saveアイコン継続表示
- **作成ボタン**:
  - テキスト変更: 「ケアプランを作成」→「保存中...」
  - クリック無効化: `disabled={isSubmitting}`
  - ローディング表示: Sendアイコン継続表示

#### 自動設定フィールド

- **作成者情報**: localStorage から自動取得して表示、編集不可
- **未保存変更警告**: フォーム内容変更時に警告表示
- **動的フィールド管理**: 目標とサービスの追加・削除機能

## 技術仕様

### 使用コンポーネント

#### 2_molecules層

- **CarePlanForm**: ケアプラン作成フォーム全体
  - パス: `components/2_molecules/care-plan/care-plan-form.tsx`
  - 機能: ケアプラン作成・編集フォームの包括的管理
  - プロパティ: onSubmit, onCancel, initialData, mode

#### 1_atoms層

- **FormField**: 基本入力フィールド
  - パス: `components/1_atoms/forms/form-field.tsx`
- **FormSelect**: 選択フィールド
  - パス: `components/1_atoms/forms/form-select.tsx`
- **Textarea**: テキストエリア（shadcn/ui）
- **Checkbox**: チェックボックス（shadcn/ui）
- **Button**: アクションボタン（shadcn/ui）
- **Input**: 基本入力フィールド（shadcn/ui）
- **Label**: ラベル（shadcn/ui）
- **Alert**: エラー・成功メッセージ表示（shadcn/ui）

#### カスタムフック

- **useCarePlanForm**: フォーム状態管理とバリデーション
  - パス: `hooks/useCarePlanForm.ts`
  - 機能: フォーム状態、バリデーション、送信処理の統合管理

### データ型定義

```typescript
// ケアプランフォームデータ型（validation/care-plan-validation.tsより）
interface CarePlanFormData {
  // 基本情報
  planTitle: string; // プラン名（必須、100文字以内）
  planType: 'initial' | 'continuation'; // プラン種別（必須）
  careLevel: string; // 要介護度（必須）
  certificationDate: string; // 認定日（必須、YYYY-MM-DD）
  certValidityStart: string; // 認定有効開始日（必須、YYYY-MM-DD）
  certValidityEnd: string; // 認定有効終了日（必須、YYYY-MM-DD）
  certificationStatus: 'certified' | 'pending'; // 認定状況（必須）
  careManager: string; // ケアマネージャー（必須、50文字以内）
  careManagerOffice: string; // 事業所名（必須、100文字以内）
  nextReviewDate: string; // 次回見直し日（必須、YYYY-MM-DD）
  isReferral: boolean; // 紹介フラグ（必須）

  // ケア目標・意向
  goals: string[]; // ケア目標配列（必須、最低1つ）
  residentIntention: string; // 利用者の意向（必須、1000文字以内）
  familyIntention: string; // 家族の意向（必須、1000文字以内）
  assessmentCommitteeOpinion: string; // 審査会意見（必須、1000文字以内）
  comprehensiveGuidance: string; // 総合的援助指針（必須、1000文字以内）

  // その他
  notes?: string; // 備考（任意、1000文字以内）
  consentObtained: boolean; // 同意確認（必須）
  services: CarePlanServiceFormData[]; // 利用サービス（必須、最低1つ）
}

// サービスフォームデータ型
interface CarePlanServiceFormData {
  serviceName: string; // サービス名（必須、100文字以内）
  serviceType: 'home_care' | 'day_service' | 'short_stay' | 'other'; // サービス種別（必須）
  frequency: string; // 頻度（必須、50文字以内）
  duration: string; // 時間（必須、50文字以内）
  provider: string; // 提供事業者（必須、100文字以内）
  startDate: string; // 開始日（必須、YYYY-MM-DD）
  endDate?: string; // 終了日（任意、YYYY-MM-DD）
  notes?: string; // メモ（任意、500文字以内）
}
```

### API仕様

| メソッド | エンドポイント                   | 説明               |
| -------- | -------------------------------- | ------------------ |
| POST     | `/api/v1/care-plans`             | ケアプラン新規作成 |
| GET      | `/api/v1/residents/{residentId}` | 利用者情報取得     |

#### リクエスト例

```json
{
  "residentId": "1",
  "planTitle": "2025年度 第1期ケアプラン",
  "planType": "initial",
  "careLevel": "要介護1",
  "certificationDate": "2025-01-15",
  "certValidityStart": "2025-01-15",
  "certValidityEnd": "2026-01-14",
  "certificationStatus": "certified",
  "careManager": "山田太郎",
  "careManagerOffice": "こうべケアプランセンター",
  "nextReviewDate": "2025-07-15",
  "isReferral": false,
  "goals": ["自立した日常生活の維持", "転倒リスクの軽減", "社会参加の促進"],
  "residentIntention": "自宅での生活を継続したい。できるだけ自立した生活を送りたい。",
  "familyIntention": "本人の意向を尊重し、安全に自宅で過ごせるよう支援したい。",
  "assessmentCommitteeOpinion": "要介護1の認定は適切。訪問介護とデイサービスの組み合わせが効果的。",
  "comprehensiveGuidance": "血圧管理を中心とした健康維持と、転倒予防に重点を置いたケアを実施。社会参加の機会も確保する。",
  "notes": "血圧管理に注意が必要。定期的なバイタルチェックを実施。",
  "consentObtained": true,
  "services": [
    {
      "serviceName": "訪問介護",
      "serviceType": "home_care",
      "frequency": "週3回",
      "duration": "1時間/回",
      "provider": "ハートケアサービス",
      "startDate": "2025-01-01",
      "notes": "身体介護中心"
    },
    {
      "serviceName": "デイサービス",
      "serviceType": "day_service",
      "frequency": "週2回",
      "duration": "6時間/回",
      "provider": "みどりデイサービスセンター",
      "startDate": "2025-01-01",
      "notes": "機能訓練・入浴サービス"
    }
  ]
}
```

## 参考資料

- [Issue #113: [設計] #015 利用者｜ケアプラン登録](https://github.com/ambi-tious/CareBase-staff/issues/113)
- [ケアプラン編集画面設計書 (#111)](https://github.com/ambi-tious/CareBase-staff/issues/111)
- [利用者詳細（ケアプラン）画面設計書 (#115)](https://github.com/ambi-tious/CareBase-staff/issues/115)
- [CareBase-staff設計書フォーマット (#141)](https://github.com/ambi-tious/CareBase-staff/issues/141)
- [Care Plan Types](../../../../types/care-plan.ts)
- [Care Plan Mock Data](../../../../mocks/care-plan-data.ts)
- [利用者登録画面設計書](../../new/README.md) - フォーム設計の参考
- [申し送り作成画面設計書](../../../handovers/new/README.md) - フォーム設計の参考
- [標準設計書](../../../../docs/standard-design-document.md)
- [画面一覧](../../../../docs/screen-list.md)
