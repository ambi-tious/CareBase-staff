# 利用者編集画面設計書

- 画面名: `利用者編集`
- パス: `/residents/{residentId}/edit`
- URL: https://carebase-staff.vercel.app/residents/5/edit

## 概要

利用者編集画面設計書です。
職員が既存利用者の基本情報を編集して、施設での情報を更新するためのフォーム画面です。
利用者詳細画面から遷移し、編集完了後は該当利用者の詳細画面に自動遷移します。

Issue: [#136 [設計] #005 利用者｜利用者編集](https://github.com/ambi-tious/CareBase-staff/issues/136)

## 全体レイアウト

### 画面構成

利用者登録画面と同様のレイアウト構成：

- ページヘッダー（画面タイトル、説明文、戻るボタン）
- エラー表示エリア（入力エラー時に表示）
- 基本情報入力フォーム（2列レイアウト）
- アクションボタン（キャンセル、更新）
- 部屋管理モーダル（部屋管理ボタンクリック時に表示）

### 画面項目

| 項目名               | コンポーネント | 必須 | 表示条件     | 初期値             | 備考                                            |
| -------------------- | -------------- | ---- | ------------ | ------------------ | ----------------------------------------------- |
| 戻るボタン           | Button         | -    | 常時         | 戻る               | アウトライン、ArrowLeft アイコン                |
| 画面タイトル         | Heading        | -    | 常時         | 利用者情報編集     | Edit3 アイコン付き                              |
| 説明文               | Text           | -    | 常時         | 基本情報編集の説明 | 必須項目マークの説明含む                        |
| エラーアラート       | Alert          | -    | 送信エラー時 | -                  | 赤色背景、エラーメッセージ表示                  |
| 利用者画像           | FileUpload     | -    | 常時         | 既存画像           | 画像ファイルのみ、5MB制限、プレビュー表示       |
| 氏名                 | FormField      | ◯    | 常時         | 既存データ         | テキスト入力、プレースホルダー「山田 太郎」     |
| フリガナ             | FormField      | -    | 常時         | 既存データ         | テキスト入力、プレースホルダー「ヤマダ タロウ」 |
| 生年月日             | FormField      | ◯    | 常時         | 既存データ         | 日付入力                                        |
| 年齢                 | FormSelect     | -    | 常時         | 既存データ         | 選択肢：0歳～120歳、生年月日と相互自動計算      |
| 性別                 | FormSelect     | ◯    | 常時         | 既存データ         | 選択肢：男性/女性/その他                        |
| 所属フロア・グループ | FormSelect     | ◯    | 常時         | 既存データ         | ログイン職員のグループを自動設定、編集可能      |
| 所属ユニット・チーム | FormSelect     | ◯    | 常時         | 既存データ         | ログイン職員のチームを自動設定、編集可能        |
| 部屋情報             | Select         | ◯    | 常時         | 既存データ         | 部屋選択、空き状況表示、部屋管理ボタン付き      |
| 入所日               | FormField      | ◯    | 常時         | 既存データ         | 日付入力                                        |
| 退所日               | FormField      | -    | 常時         | 既存データ         | 日付入力                                        |
| キャンセルボタン     | Button         | -    | 常時         | キャンセル         | アウトライン                                    |
| 更新ボタン           | Button         | -    | 常時         | 更新               | 青色スタイル、Save アイコン                     |

## 機能仕様

### 初期データ取得

| 項目名               | データソース                                | 取得方法                     | フォールバック処理               |
| -------------------- | ------------------------------------------- | ---------------------------- | -------------------------------- |
| 利用者基本情報       | `getResidentById(residentId)`               | ページロード時に取得         | エラー画面表示                   |
| 所属フロア・グループ | localStorage `carebase_selected_staff_data` | `groupName` プロパティを取得 | 既存データのまま（手動入力可能） |
| 所属ユニット・チーム | localStorage `carebase_selected_staff_data` | `teamName` プロパティを取得  | 既存データのまま（手動入力可能） |

#### 初期データ取得の動作仕様

- **取得タイミング**: コンポーネントマウント時
- **ローディング状態**: データ取得中はローディングスピナー表示
- **エラーハンドリング**: 取得失敗時はエラーメッセージ表示
- **フォーム初期化**: 取得データでフォームフィールドを初期化

### 相互自動計算機能

利用者登録画面と同様：

#### 生年月日と年齢の自動計算

- **生年月日→年齢**: 生年月日が入力されると年齢を自動計算
- **年齢→生年月日**: 年齢が選択されると生年月日を自動計算（既存の生年月日の月日を基準）
- **計算方式**: JST時間帯での現在日付を基準とした正確な年齢計算
- **更新タイミング**: 各フィールドの値変更時にリアルタイム更新

### 部屋管理機能

利用者登録画面と同様：

#### 部屋選択機能

- **動的部屋取得**: 選択されたグループ・チームに応じて利用可能な部屋を動的に取得
- **空き状況表示**: 各部屋の現在の入居者数と定員を表示（例：1/2名 - 空きあり）
- **満室表示**: 満室の部屋は無効化して表示
- **空き状況サマリー**: 空きあり部屋数と満室部屋数を表示

#### 部屋管理モーダル

- **部屋一覧表示**: 現在のグループ・チームの部屋一覧を表示
- **部屋作成**: 新しい部屋の作成機能
- **部屋編集**: 既存部屋の編集機能
- **部屋削除**: 部屋の削除機能（確認ダイアログ付き）

### アクション

| 項目名           | 処理内容                           | 対象API                          | 遷移先画面                                 |
| ---------------- | ---------------------------------- | -------------------------------- | ------------------------------------------ |
| 戻るボタン       | 利用者詳細画面に戻る               | -                                | 利用者詳細画面 (`/residents/{residentId}`) |
| フォーム入力     | リアルタイムバリデーション実行     | -                                | 同一画面（エラー表示更新）                 |
| キャンセルボタン | 入力内容を破棄して詳細画面に戻る   | -                                | 利用者詳細画面 (`/residents/{residentId}`) |
| 部屋管理ボタン   | 部屋管理モーダルを表示             | -                                | 同一画面（モーダル表示）                   |
| 更新ボタン       | 利用者情報を更新して詳細画面に遷移 | `residentService.updateResident` | 利用者詳細画面 (`/residents/{residentId}`) |

### 入力チェック

利用者登録画面と同様：

| 項目名               | イベント | チェック内容               | エラーメッセージ                               |
| -------------------- | -------- | -------------------------- | ---------------------------------------------- |
| 利用者画像           | upload   | ファイルサイズチェック     | ファイルサイズは5MB以下にしてください          |
| 利用者画像           | upload   | ファイル形式チェック       | 画像ファイルを選択してください                 |
| 氏名                 | input    | 必須チェック               | 氏名は必須です                                 |
| 氏名                 | input    | 文字数チェック             | 氏名は50文字以内で入力してください             |
| フリガナ             | input    | カタカナ形式チェック       | フリガナはカタカナで入力してください           |
| 生年月日             | input    | 必須チェック               | 生年月日は必須です                             |
| 性別                 | select   | 必須チェック               | 性別は必須です                                 |
| 所属フロア・グループ | select   | 必須チェック               | 所属フロア・グループは必須です                 |
| 所属ユニット・チーム | select   | 必須チェック               | 所属ユニット・チームは必須です                 |
| 部屋情報             | select   | 必須チェック               | 部屋情報は必須です                             |
| 入所日               | input    | 必須チェック               | 入所日は必須です                               |
| 入所日               | input    | 生年月日との整合性チェック | 入所日は生年月日より後の日付を入力してください |
| 退所日               | input    | 入所日との整合性チェック   | 退所日は入所日より後の日付を入力してください   |

### バリデーション仕様

利用者登録画面と同様：

#### リアルタイムバリデーション

- **入力時検証**: フォーム項目への入力と同時にバリデーションを実行（`mode: 'onChange'`）
- **エラー表示**: 各項目下部に赤色でエラーメッセージを表示
- **送信制御**: バリデーションエラーがある場合は更新ボタンクリック時に送信を阻止
- **バリデーションライブラリ**: Zod + React Hook Form

#### 文字列検証

- **フリガナ**: カタカナ、長音符、スペースのみ許可（正規表現: `/^[ァ-ヶー\s]*$/`）
- **必須項目**: 空文字、空白のみの入力を無効とする
- **日付形式**: ISO 8601形式での日付入力を要求

#### 日付検証

- **入所日 > 生年月日**: 入所日が生年月日より後の日付であることを確認
- **退所日 > 入所日**: 退所日が入所日より後の日付であることを確認（退所日が入力されている場合）

#### エラーハンドリング

| エラー種別           | 発生条件                           | 表示メッセージ                                           | 表示場所           |
| -------------------- | ---------------------------------- | -------------------------------------------------------- | ------------------ |
| 初期データ取得エラー | getResidentById失敗                | 利用者情報の取得に失敗しました。もう一度お試しください。 | 画面上部アラート   |
| API通信エラー        | residentService.updateResident失敗 | 利用者情報の更新に失敗しました。もう一度お試しください。 | 画面上部アラート   |
| バリデーションエラー | 必須項目未入力時の送信             | 入力内容に不備があります。必須項目を確認してください。   | 画面上部アラート   |
| ファイルサイズエラー | 5MB超過画像アップロード            | ファイルサイズは5MB以下にしてください                    | ブラウザアラート   |
| ファイル形式エラー   | 画像以外ファイルアップロード       | 画像ファイルを選択してください                           | ブラウザアラート   |
| フィールド個別エラー | リアルタイムバリデーション         | 各項目固有のエラーメッセージ                             | 該当フィールド下部 |

## UI/UX仕様

### レスポンシブデザイン

利用者登録画面と同様：

- **モバイル（〜768px）**:
  - フォーム項目を1列で縦並び表示
  - ボタンを全幅で縦積み配置
  - 余白を最小化してコンテンツエリアを最大化
- **タブレット（768px〜1024px）**:
  - フォーム項目を2列グリッドで表示
  - ボタンを右寄せで横並び配置
- **デスクトップ（1024px〜）**:
  - フォーム全体の最大幅を6xlに制限
  - 2列グリッドレイアウトを維持
  - 余白を十分に確保

### カラーテーマ

利用者登録画面と同様：

- **背景色**: `bg-carebase-bg` - アプリケーション標準背景色
- **更新ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark` - メインアクション
- **戻る・キャンセルボタン**: `border-gray-300 text-gray-700` - セカンダリアクション
- **エラーアラート**: `bg-red-50 border-red-200 text-red-700` - エラー状態
- **必須マーク**: `text-red-500` - 必須項目表示
- **セクション見出し**: `text-carebase-text-primary border-b` - セクション分割
- **部屋管理ボタン**: `border-purple-300 text-purple-600 hover:bg-purple-50` - 特殊アクション

### フォームUI仕様

利用者登録画面と同様：

- **入力フィールド間隔**: `gap-6` - 項目間の適切な間隔
- **セクション分割**: 基本情報と施設情報・認定情報を明確に分離
- **ラベル配置**: 各入力フィールドの上部に配置
- **プレースホルダー**: 入力例を示すサンプルテキスト
- **フォーカス状態**: 青色のアウトライン表示

### 画像アップロード仕様

利用者登録画面と同様：

#### ファイル制限

- **対応形式**: `image/*` (JPEG, PNG, GIF, WebP等)
- **ファイルサイズ**: 最大5MB
- **アップロード方式**: Base64エンコードでフォームデータに含める

#### 画像圧縮機能

- **自動圧縮**: アップロード時に自動的に画像を圧縮
- **圧縮設定**: 最大幅400px、最大高さ400px、品質0.8、最大サイズ500KB
- **正方形化**: 強制的に正方形にリサイズ
- **圧縮結果表示**: コンソールに圧縮前後のサイズを表示

#### UI動作

- **初期表示時**:
  - 既存画像がある場合：128x128pxのプレビュー画像表示
  - 既存画像がない場合：点線ボーダーのドロップエリア表示
- **画像変更時**:
  - 新しい画像の128x128pxプレビュー表示
  - 「画像を変更」「画像を削除」ボタン表示
  - 削除時はプレビューとフォームデータをクリア
- **圧縮中**:
  - ローディングスピナー表示
  - 「圧縮中...」テキスト表示
  - 操作無効化

#### エラーハンドリング

- **サイズ超過**: ブラウザアラートで即座通知
- **形式不正**: ブラウザアラートで即座通知
- **読み込み失敗**: コンソールエラーログ出力

### 部屋選択UI仕様

利用者登録画面と同様：

#### 部屋選択ドロップダウン

- **動的オプション**: グループ・チーム選択に応じて部屋オプションを動的生成
- **空き状況表示**: 各部屋の入居者数/定員と空き状況を表示
- **満室表示**: 満室の部屋は無効化して表示
- **プレースホルダー**: 「部屋を選択してください」

#### 部屋状況サマリー

- **空きあり表示**: 緑色ドット + 空きあり部屋数
- **満室表示**: 赤色ドット + 満室部屋数
- **表示条件**: 部屋が存在する場合のみ表示

#### 部屋管理ボタン

- **ボタンスタイル**: 紫色のアウトライン、Settingsアイコン付き
- **配置**: 部屋選択フィールドの右側
- **機能**: 部屋管理モーダルを開く

### アニメーション

利用者登録画面と同様：

- **ボタンホバー**: スムーズなカラートランジション
- **フォーム送信**: ローディング状態の表示（「更新中...」）
- **エラー表示**: フェードイン効果でアラート表示
- **バリデーション**: リアルタイムでエラーメッセージ表示・非表示
- **画像圧縮**: ローディングスピナーアニメーション

### アクセシビリティ

利用者登録画面と同様：

- **キーボードナビゲーション**: Tabキーでの順次フォーカス移動
- **スクリーンリーダー**:
  - 適切なlabel要素の関連付け
  - 必須項目のaria-required属性
  - エラーメッセージのaria-describedby属性
- **コントラスト比**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスリング表示

### ローディング・無効化状態

#### 初期データ取得中状態

- **フォーム全体**: ローディングスピナー表示
- **全ボタン**: クリック無効化

#### 送信中状態（isSubmitting: true）

- **フォーム全体**: `disabled={isSubmitting}` で全入力フィールドを無効化
- **戻るボタン**: クリック無効化で誤操作防止
- **キャンセルボタン**: クリック無効化で誤操作防止
- **更新ボタン**:
  - テキスト変更: 「更新」→「更新中...」
  - クリック無効化: `disabled={isSubmitting}`
  - ローディング表示: Saveアイコン継続表示

#### 自動設定フィールド

- **所属フロア・グループ**: localStorage から自動設定、編集可能
- **所属ユニット・チーム**: localStorage から自動設定、編集可能
- **視覚的表示**: 通常の入力フィールドと同様の表示

#### バリデーションエラー時の表示

- **該当フィールド**: 赤色ボーダー表示
- **エラーメッセージ**: フィールド下部に即座表示
- **送信制御**: エラーがある場合は送信処理を中断

## 実装詳細

### データ構造

利用者登録画面と同様：

```typescript
interface ResidentBasicInfo {
  name: string;
  furigana: string;
  dob: string;
  age?: string;
  sex: '男' | '女' | 'その他';
  careLevel: string;
  floorGroup: string;
  unitTeam: string;
  roomInfo: string;
  address: string;
  admissionDate: string;
  dischargeDate: string;
  profileImage: string;
  certificationDate: string;
  certificationStartDate: string;
  certificationEndDate: string;
}
```

### 自動計算処理

利用者登録画面と同様：

#### 認定期間自動計算

- **認定日**: 入所日と同じ日付に自動設定
- **認定有効期間開始日**: 入所日と同じ日付に自動設定
- **認定有効期間終了日**: 入所日の1年後の前日に自動計算

### API連携

- **取得API**: `getResidentById(residentId: number)` (mocks/care-board-data.ts)
- **更新API**: `residentService.updateResident(residentId: string, data: ResidentBasicInfo)`
- **部屋取得API**: `roomService.getAllActiveRooms()`
- **遅延処理**: 1秒のシミュレート遅延
- **日付変換**: YYYY/MM/DD形式からYYYY-MM-DD形式への変換

### 部屋管理機能

利用者登録画面と同様：

#### 部屋データ構造

```typescript
interface Room {
  id: string;
  name: string;
  capacity: number;
  currentOccupancy?: number;
  groupId: string;
  teamId: string;
  isActive: boolean;
  createdAt: string;
  updatedAt: string;
}
```

#### 部屋管理モーダル機能

- **部屋作成**: 新しい部屋の作成（名前、定員、グループ、チーム）
- **部屋編集**: 既存部屋の情報編集
- **部屋削除**: 部屋の削除（確認ダイアログ付き）
- **バリデーション**: 部屋名の重複チェック、定員の数値チェック

## 主な差分（利用者登録画面との違い）

### 画面要素の差分

| 項目                     | 登録画面           | 編集画面           |
| ------------------------ | ------------------ | ------------------ |
| 画面タイトル             | 新規利用者登録     | 利用者情報編集     |
| アイコン                 | UserPlus           | Edit3              |
| 説明文                   | 基本情報入力の説明 | 基本情報編集の説明 |
| アクションボタン         | 登録               | 更新               |
| ボタンテキスト（送信中） | 登録中...          | 更新中...          |

### 機能の差分

| 項目                 | 登録画面                     | 編集画面                         |
| -------------------- | ---------------------------- | -------------------------------- |
| 初期データ           | 空のフォーム                 | 既存データで初期化               |
| データ取得           | 不要                         | ページロード時に取得             |
| API呼び出し          | createResident               | getResidentById + updateResident |
| 遷移先（完了後）     | 新規作成した利用者の詳細画面 | 編集対象利用者の詳細画面         |
| 遷移先（キャンセル） | 利用者一覧画面               | 利用者詳細画面                   |

### エラーハンドリングの差分

| エラー種別           | 登録画面                   | 編集画面                       |
| -------------------- | -------------------------- | ------------------------------ |
| 初期データ取得エラー | 該当なし                   | 利用者情報の取得に失敗しました |
| API通信エラー        | 利用者の登録に失敗しました | 利用者情報の更新に失敗しました |

## 参考資料

- [Issue #136: [設計] #005 利用者｜利用者編集](https://github.com/ambi-tious/CareBase-staff/issues/136)
- [利用者編集画面実装](./page.tsx)
- [ResidentBasicInfoForm コンポーネント](../../../../components/2_molecules/forms/resident-basic-info-form.tsx)
- [useResidentForm カスタムフック](../../../../hooks/useResidentForm.ts) - フォーム状態管理、バリデーション、送信処理
- [residentService](../../../../services/residentService.ts) - 利用者取得・更新API、認定期間自動計算
- [roomService](../../../../services/roomService.ts) - 部屋管理API
- [RoomManagementModal](../../../../components/3_organisms/modals/room-management-modal.tsx) - 部屋管理モーダル
- [利用者登録画面設計書](../new/README.md)
- [利用者詳細画面設計書](../README.md)
- [利用者一覧画面設計書](../../README.md)
- [画面一覧](../../../../docs/screen-list.md#利用者管理)
