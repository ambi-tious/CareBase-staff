# 利用者一覧画面設計書

- 画面名: `利用者一覧`
- パス: `/residents`
- URL: https://carebase-staff.vercel.app/residents

## 概要

利用者一覧画面設計書です。
ログインしているグループとチームに紐づいた利用者の一覧表示、検索機能、アラート状態の検知機能を提供します。
利用者の基本情報とアラート状況を一目で把握でき、詳細画面への遷移や新規利用者登録が可能です。

**アラートメイン設計**: 利用者のアラート状態を最優先で表示し、緊急度に応じた視覚的な識別を可能にします。

## 全体レイアウト

### 画面構成

<img width="998" height="474" alt="image" src="https://github.com/user-attachments/assets/e6fbf920-fce0-4712-90f1-d061bdf6b85f" />

利用者管理のメイン画面として以下の要素で構成：

- ページヘッダー（統計情報）
- 検索・操作ツールバー
- 利用者カード一覧（グリッドレイアウト）
- フィルター・エクスポート機能

### FlutterFlow参考画面分析

参考URL: [FlutterFlow参考画面](https://carebase.flutterflow.app/customerList)

<img alt="FlutterFlow Reference" src="https://github.com/user-attachments/assets/8ab805b4-efc7-49cb-83ef-f3fa7ee13fc5">

#### FlutterFlow画面要素マッピング

| FlutterFlow要素 | 実装対応 | コンポーネント | 備考 |
|----------------|----------|---------------|------|
| 検索バー | ✅ | ResidentSearchBar | 名前・ふりがな検索対応 |
| 利用者カード | ✅ | ResidentCard | アバター、基本情報、アラート表示 |
| 新規作成ボタン | ✅ | Button (UserPlus) | 青色メインボタン |
| フィルター機能 | ✅ | Button (Filter) | アウトライン形式 |
| 退所者表示切替 | ✅ | Switch | ラベル付きトグル |
| 統計情報表示 | ✅ | 情報表示エリア | 入居中・退所済・表示中件数 |

### アラート表示参考

<img alt="Alert Display Reference" src="https://github.com/user-attachments/assets/3dba12d9-02a5-4312-b8d4-625e4115b29d">

この参考画像に基づき、以下のアラート表示仕様を実装：
- アラートアイコンの視覚的配置（利用者アバターとの組み合わせ）
- 数値ベースのアラートカウント表示（ケース記録、申し送り、下書き、医療イベント）
- アラート項目の分類表示と色分け

### 画面項目

| 項目名             | コンポーネント    | 必須 | 表示条件     | 初期値                     | 備考                            |
| ------------------ | ----------------- | ---- | ------------ | -------------------------- | ------------------------------- |
| 統計情報           | 情報表示エリア    | -    | 常時         | 入居中・退所済・表示中件数 | リアルタイム更新                |
| 検索バー           | ResidentSearchBar | -    | 常時         | 空文字                     | 名前・ふりがなで検索            |
| 新規登録ボタン     | Button            | -    | 常時         | 新規利用者登録             | 青色スタイル、UserPlus アイコン |
| 退所済み表示トグル | Switch            | -    | 常時         | false                      | 退所済み利用者も表示            |
| フィルターボタン   | Button            | -    | 常時         | フィルター                 | アウトライン、Filter アイコン   |
| エクスポートボタン | Button            | -    | 常時         | エクスポート               | アウトライン、Download アイコン |
| 利用者カード       | ResidentCard      | -    | 検索結果あり | -                          | グリッドレイアウト              |
| 空状態表示         | EmptyState        | -    | 検索結果なし | -                          | Users アイコン付きメッセージ    |

## 機能仕様

### アラート状態検知機能

#### リアルタイムアラート検知
- **検知対象**: ケース記録、申し送り事項、下書き、医療イベント等
- **更新頻度**: リアルタイム（WebSocket または定期ポーリング）
- **優先度判定**: 緊急（高）> 注意（中）> 情報（低）
- **表示制御**: アラート数に応じた視覚的強調表示

#### アラート分類仕様
| アラート種別 | 優先度 | 検知条件 | 表示形式 |
|-------------|--------|----------|----------|
| ケース記録 | 高 | 未対応の緊急記録 | 赤色バッジ + 件数 |
| 申し送り | 中 | 未確認の申し送り事項 | オレンジ色バッジ + 件数 |
| 下書き | 低 | 未完了の下書き | 青色バッジ + 件数 |
| 医療イベント | 高 | 緊急医療対応要求 | 赤色バッジ + 件数 |

### グループ・チーム連携仕様

#### 認証連携
- **ログイン情報**: JWTトークンからグループID・チームIDを取得
- **フィルタリング**: 所属グループ・チーム配下の利用者のみ表示
- **権限制御**: グループ・チーム管理者権限に応じた操作制限

#### データ取得API
```typescript
// 利用者一覧取得API仕様
GET /api/v1/residents?groupId={groupId}&teamId={teamId}&includeDischarged={boolean}
```

### CareBoard統合可能性

#### 既存システム連携
- **CareBoard連携**: 既存ケアボードデータ（`/mocks/care-board-data.ts`）との整合性確保
- **データ同期**: ケアボード更新時の利用者一覧への反映
- **統合表示**: ケアボードアラートと利用者一覧アラートの統一

#### 将来拡張仕様
- **ワークフロー統合**: ケアボード → 利用者詳細 → ケア記録の連携フロー
- **通知システム**: ケアボードアラートと連動した通知機能
- **レポート統合**: 利用者別ケア実績とアラート履歴の統合レポート

### アクション

| 項目名           | 処理内容                         | 対象API                    | 遷移先画面                            |
| ---------------- | -------------------------------- | -------------------------- | ------------------------------------- |
| 検索実行         | 名前・ふりがなでの部分一致検索   | -                          | 同一画面（結果更新）                  |
| 退所済み表示切替 | 退所済み利用者の表示・非表示切替 | -                          | 同一画面（結果更新）                  |
| 新規利用者登録   | 新規利用者登録画面への遷移       | -                          | 新規利用者登録画面 (`/residents/new`) |
| 利用者詳細表示   | 選択した利用者の詳細画面への遷移 | -                          | 利用者詳細画面 (`/residents/{id}`)    |
| フィルター実行   | 詳細条件でのフィルタリング       | `/api/v1/residents/filter` | 同一画面（結果更新）                  |
| エクスポート実行 | 利用者データのCSV出力            | `/api/v1/residents/export` | ファイルダウンロード                  |

### 入力チェック

| 項目名       | イベント | チェック内容              | エラーメッセージ                              |
| ------------ | -------- | ------------------------- | --------------------------------------------- |
| 検索バー     | input    | 文字数制限（100文字以内） | 検索キーワードは100文字以内で入力してください |
| 検索バー     | input    | 特殊文字制限              | 使用できない文字が含まれています              |
| フィルター   | submit   | 必須項目チェック          | 必須項目を入力してください                    |
| エクスポート | click    | 権限チェック              | エクスポート権限がありません                  |

#### バリデーション仕様

#### 検索ロジック

- **部分一致検索**: 利用者名・ふりがなの両方で部分一致検索を実行
- **大文字小文字無視**: 検索時は大文字小文字を区別しない
- **リアルタイム検索**: 入力と同時に検索結果を更新
- **空文字処理**: 検索キーワードが空の場合は全件表示

#### 表示制御

- 入居中利用者: デフォルトで表示
- 退所済み利用者: トグルON時のみ表示
- **アラート優先表示**: 緊急・注意アラートを持つ利用者を上位表示
- **アラート並び順**: 緊急度 > アラート件数 > 利用者名（あいうえお順）
- ページネーション: 大量データ時の分割表示（将来実装）

#### アラート検知ロジック

参考画像に基づく具体的なアラート検知仕様：

| アラート項目 | 検知条件 | 優先度 | 表示例 |
|-------------|----------|--------|--------|
| ケース記録 | 未完了・要対応ケース | 高 | 赤丸5件 |
| 申し送り | 未確認・当日申し送り | 中 | オレンジ丸5件 |
| 下書き | 未保存・一時保存中 | 低 | 青丸5件 |
| 医療イベント | 本日の医療予定・アラート | 高 | 赤丸26件 |

**アラート更新仕様**:
- リフレッシュ間隔: 30秒
- リアルタイム通知対応: WebSocket利用時
- アラート履歴保持: 過去7日間

#### エラーハンドリング

- 検索結果0件時の適切なメッセージ表示
- API通信エラー時のフォールバック表示
- 画像読み込み失敗時のプレースホルダー表示

## UI/UX仕様

### レスポンシブデザイン

- **利用者カード**: 1列（モバイル）→ 2列（タブレット）→ 3列（デスクトップ）
- **ツールバー**: 縦積み（モバイル）→ 横並び（タブレット以上）
- **検索バー**: 全幅（モバイル）→ 最大幅制限（デスクトップ）

### カラーテーマ

- **アラートバッジ**:
  - 緊急: `bg-red-100 text-red-800 border-red-200`
  - 注意: `bg-orange-100 text-orange-800 border-orange-200`
  - 情報: `bg-blue-100 text-blue-800 border-blue-200`
- **ステータスバッジ**:
  - 入居中: `bg-green-100 text-green-800`
  - 退所済: `bg-gray-100 text-gray-800`
- **新規登録ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark`

### アニメーション

- **カードホバー**: `hover:shadow-md transition-shadow`
- **検索結果更新**: フェードイン・アウト効果
- **ローディング**: スケルトンローディング表示
- **スムーズスクロール**: 検索結果表示時の自動スクロール

### アクセシビリティ

- **キーボードナビゲーション**: Tab キーでの操作対応
- **スクリーンリーダー**: 適切な aria-label 設定
- **コントラスト比**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスインジケーター

## タスク完了確認

### 1. 要件整理
- [x] FlutterFlow参考画面の分析 → FlutterFlow画面要素マッピング表作成
- [x] アラート状態検知機能の仕様確認 → リアルタイムアラート検知仕様定義
- [x] グループ・チーム連携の整合性確認 → 認証連携・データ取得API仕様策定
- [x] ケアボード統合可能性の検討 → 既存システム連携・将来拡張仕様検討

### 2. 画面設計
- [x] 全体レイアウトの設計（一覧表示、検索エリア、ボタン配置）
- [x] 画面項目の定義（利用者カード、アラート表示、検索フィールド等）
- [x] レスポンシブデザインの考慮

### 3. 機能仕様の定義
- [x] 検索機能仕様（名前検索、フィルタリング）
- [x] 表示制御仕様（退所者表示切替、グループ・チーム絞込）
- [x] アクション仕様（新規作成、詳細遷移）

### 4. UI/UX仕様の定義
- [x] アラート表示仕様（優先度、色分け、アニメーション）
- [x] カラーテーマの設定
- [x] アクセシビリティ対応

## 参考資料

- [利用者詳細画面設計書](./[residentId]/README.md)
- [新規利用者登録画面設計書](./new/README.md)
- [Issue #137: [設計] #003 利用者｜利用者一覧](https://github.com/ambi-tious/CareBase-staff/issues/137)
- [FlutterFlow参考画面](https://carebase.flutterflow.app/customerList)
- [画面一覧](../../../docs/screen-list.md#利用者管理)
- [利用者一覧画面実装](./page.tsx)
- [ResidentsList コンポーネント](../../../components/3_organisms/resident/residents-list.tsx)  
- [ResidentCard コンポーネント](../../../components/2_molecules/resident/resident-card.tsx)
- [AlertIndicator コンポーネント](../../../components/1_atoms/residents/alert-indicator.tsx)
