# 利用者詳細画面（ケアプラン）設計書

- 画面名: `利用者詳細（ケアプラン）`
- パス: `/residents/[id]/care-plans`
- URL: https://carebase-staff.vercel.app/residents/1/care-plans

## 概要

利用者詳細画面のケアプラン表示・管理機能設計書です。
利用者のケアプラン確認、新規作成、更新管理を行う機能を提供します。
ケアプラン一覧の表示、フィルタリング、検索機能により、利用者の計画管理を効率的に行えます。

Issue: [#115 [設計] #014 利用者｜利用者詳細（ケアプラン）](https://github.com/ambi-tious/CareBase-staff/issues/115)

## 全体レイアウト

### 画面構成

1画面で完結するケアプラン管理インターフェース：

- ページヘッダー（利用者名、統計情報、新規作成ボタン）
- 検索・フィルター機能（キーワード検索、ステータス、要介護度フィルター）
- ケアプラン一覧表示（カード形式、グリッドレイアウト）
- 空状態メッセージ（データなし時）

### 画面項目

| 項目名                 | コンポーネント        | 必須 | 表示条件             | 初期値                       | 備考                                |
| ---------------------- | --------------------- | ---- | -------------------- | ---------------------------- | ----------------------------------- |
| ケアプランアイコン     | FileText              | -    | 常時                 | -                            | 青色のファイルアイコン              |
| ページタイトル         | Heading               | ◯    | 常時                 | [利用者名]様のケアプラン     | 大文字、太字                        |
| 総件数表示             | テキスト              | ◯    | 常時                 | 総件数: X件                  | グレー文字、小サイズ                |
| 有効件数表示           | テキスト              | ◯    | 常時                 | 有効: X件                    | 緑色文字、太字                      |
| 表示中件数表示         | テキスト              | ◯    | 常時                 | 表示中: X件                  | グレー文字、小サイズ                |
| 新規作成ボタン         | Button                | -    | 常時                 | 新規ケアプラン作成           | 青色、プラスアイコン付き            |
| 検索バー               | CarePlanSearchBar     | -    | 常時                 | -                            | プレースホルダー付き検索入力        |
| フィルター機能         | CarePlanFilters       | -    | 常時                 | -                            | ステータス・要介護度フィルター      |
| ケアプランカード       | CarePlanCard          | -    | データ存在時         | -                            | 個別ケアプラン情報表示カード        |
| 空状態メッセージ       | テキスト              | -    | データなし時         | ケアプランが見つかりません   | 中央配置、ファイルアイコン付き      |
| 空状態説明             | テキスト              | -    | データなし時         | 条件に応じた説明文           | グレー文字、中央配置                |
| 計画書タイトル         | CardTitle             | ◯    | カード内             | -                            | ケアプラン名、青色リンク            |
| ステータスバッジ       | Badge                 | ◯    | カード内             | -                            | 有効/下書き/アーカイブの状態表示    |
| 要介護度表示           | テキスト              | ◯    | カード内             | -                            | 要介護1-5の表示                     |
| 認定日表示             | テキスト              | ◯    | カード内             | -                            | カレンダーアイコン付き              |
| 認定有効期間表示       | テキスト              | ◯    | カード内             | -                            | 開始日〜終了日形式                  |
| ケアマネージャー表示   | テキスト              | ◯    | カード内             | -                            | ユーザーアイコン付き                |
| 居宅介護支援事業所表示 | テキスト              | ◯    | カード内             | -                            | ビルディングアイコン付き            |
| 作成日表示             | テキスト              | ◯    | カード内             | -                            | カレンダーアイコン付き              |
| 次回見直し日表示       | テキスト              | ◯    | カード内             | -                            | 時計アイコン付き                    |

## 機能仕様

### アクション

| 項目名           | 処理内容                       | 対象API                                | 遷移先画面                               |
| ---------------- | ------------------------------ | -------------------------------------- | ---------------------------------------- |
| 新規作成ボタン   | ケアプラン新規作成画面に遷移   | -                                      | ケアプラン新規作成画面（/care-plans/new） |
| 検索機能         | キーワードによるケアプラン検索 | -                                      | 同一画面（検索結果表示）                 |
| フィルター機能   | ステータス・要介護度で絞り込み | -                                      | 同一画面（フィルター結果表示）           |
| フィルターリセット | 全フィルター条件をクリア      | -                                      | 同一画面（全件表示）                     |
| ケアプランカード | ケアプラン詳細画面に遷移       | -                                      | ケアプラン詳細画面（/care-plans/[id]）   |
| 初期データ取得   | 利用者のケアプラン一覧取得     | `/api/v1/residents/[id]/care-plans`    | -                                        |

### 検索・フィルター仕様

#### 検索機能

| 検索対象       | 検索方式     | 備考                           |
| -------------- | ------------ | ------------------------------ |
| 計画書タイトル | 部分一致     | 大文字小文字の区別なし         |
| ケアマネージャー | 部分一致     | 大文字小文字の区別なし         |
| 居宅介護支援事業所 | 部分一致   | 大文字小文字の区別なし         |

#### フィルター機能

| フィルター項目 | 選択肢                                 | 備考                 |
| -------------- | -------------------------------------- | -------------------- |
| ステータス     | 有効/下書き/アーカイブ                 | 複数選択不可         |
| 要介護度       | 要介護1/要介護2/要介護3/要介護4/要介護5 | 複数選択不可         |

#### 表示制御

- 検索結果とフィルター結果は AND 条件で絞り込み
- 条件に一致しない場合は空状態メッセージを表示
- フィルター条件がある場合は「条件に一致するケアプランがありません」
- フィルター条件がない場合は「ケアプランが登録されていません」

### 入力チェック

| 項目名     | イベント     | チェック内容     | エラーメッセージ                 |
| ---------- | ------------ | ---------------- | -------------------------------- |
| 利用者ID   | ページロード | 存在チェック     | 指定された利用者が見つかりません |
| 利用者ID   | ページロード | 有効性チェック   | 無効な利用者IDです               |
| データ取得 | ページロード | API接続チェック  | データの取得に失敗しました       |

### バリデーション仕様

#### 表示制御

- **ケアプラン一覧**: 作成日降順でソート表示
- **ステータスバッジ**: 状態に応じた色分け表示
  - 有効: `bg-green-100 text-green-700 border-green-200`
  - 下書き: `bg-gray-100 text-gray-700 border-gray-200`
  - アーカイブ: `bg-yellow-100 text-yellow-700 border-yellow-200`
- **認定有効期間**: 開始日と終了日を「〜」で連結して表示
- **空状態**: データ件数とフィルター条件に応じた適切なメッセージ表示

#### エラーハンドリング

- **データ取得エラー**: API接続失敗時の統一エラー表示
- **利用者不存在エラー**: 無効な利用者ID指定時の404ページ表示
- **ネットワークエラー**: 通信失敗時のリトライ機能
- **検索エラー**: 検索処理失敗時の適切なフォールバック

## UI/UX仕様

### レスポンシブデザイン

- **モバイル（〜768px）**:
  - ヘッダー情報を縦並び表示
  - 検索バーとフィルターを縦積み配置
  - ケアプランカードを1列表示
  - カード内情報を縦並び表示
- **タブレット（768px〜1024px）**:
  - ヘッダー情報を2列表示
  - 検索バーとフィルターを横並び配置
  - ケアプランカードを1列表示
  - カード内情報を2列グリッド表示
- **デスクトップ（1024px〜）**:
  - ヘッダー情報を横並び表示
  - 検索バーとフィルターを横並び配置
  - ケアプランカードを2列表示
  - カード内情報を2列グリッド表示

### カラーテーマ

- **新規作成ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark`
- **ケアプランタイトル**: `text-carebase-blue hover:text-carebase-blue-dark`
- **ステータスバッジ**: 状態に応じた色分け（上記参照）
- **統計情報**: `text-gray-600`（総件数・表示中件数）、`text-green-600 font-medium`（有効件数）
- **情報ラベル**: `text-gray-500 text-sm font-medium`
- **情報値**: `text-carebase-text-primary`

### アイコン使用

- **ページタイトル**: `FileText` アイコン（青色）
- **新規作成ボタン**: `PlusCircle` アイコン
- **認定日**: `Calendar` アイコン
- **認定有効期間**: `Calendar` アイコン
- **ケアマネージャー**: `User` アイコン
- **居宅介護支援事業所**: `Building2` アイコン
- **作成日**: `Calendar` アイコン
- **次回見直し日**: `Clock` アイコン
- **空状態**: `FileText` アイコン（グレー色）

### アニメーション

- **カード表示**: フェードイン効果
- **ホバー効果**: `hover:shadow-md transition-shadow duration-200`
- **ボタンホバー**: カラー変更トランジション
- **フィルター切り替え**: スムーズなトランジション効果

### アクセシビリティ

- **キーボードナビゲーション**: Tab キーでの要素移動対応
- **スクリーンリーダー対応**: 適切なaria-label設定
  - 新規作成ボタン: `aria-label="新しいケアプランを作成"`
  - 検索バー: `aria-label="ケアプランを検索"`
  - フィルター: `aria-label="ケアプランをフィルター"`
  - ケアプランカード: `aria-label="${計画書タイトル}の詳細を表示"`
- **コントラスト**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスインジケーター
- **エラー表示**: role="alert"でエラーメッセージを通知

## データ仕様

### ケアプラン情報項目

基本的なケアプラン情報に加えて、コメントで指定された以下の項目をケアプラン側に保持：

| 項目名           | データ型 | 必須 | 備考                                       |
| ---------------- | -------- | ---- | ------------------------------------------ |
| 要介護度         | string   | ◯    | 要介護1-5、ケアプラン側にデータを保持      |
| 認定日           | string   | ◯    | YYYY-MM-DD形式、ケアプラン側にデータを保持 |
| 認定有効期間開始日 | string   | ◯    | YYYY-MM-DD形式、ケアプラン側にデータを保持 |
| 認定有効期間終了日 | string   | ◯    | YYYY-MM-DD形式、ケアプラン側にデータを保持 |

※利用者詳細ページで表示する要介護度・認定日・認定有効期間は、最新のケアプランのデータから取得する

### API エンドポイント

| メソッド | エンドポイント                         | 説明                       |
| -------- | -------------------------------------- | -------------------------- |
| GET      | `/api/v1/residents/[id]/care-plans`    | 利用者のケアプラン一覧取得 |
| GET      | `/api/v1/residents/[id]`               | 利用者基本情報取得         |

## 技術仕様

### 使用コンポーネント

#### 既存実装済みコンポーネント

- **CarePlanList**: ケアプラン一覧表示コンポーネント
  - パス: `components/3_organisms/care-plan/care-plan-list.tsx`
  - 機能: ケアプラン一覧表示、検索・フィルター機能
  - プロパティ: carePlans, residentId, residentName, className

- **CarePlanCard**: ケアプラン個別カード表示
  - パス: `components/2_molecules/care-plan/care-plan-card.tsx`
  - 機能: 個別ケアプラン情報の表示
  - プロパティ: carePlan

- **CarePlanSearchBar**: ケアプラン検索バー
  - パス: `components/2_molecules/care-plan/care-plan-search-bar.tsx`
  - 機能: キーワード検索機能
  - プロパティ: onSearch, className

- **CarePlanFilters**: ケアプランフィルター機能
  - パス: `components/2_molecules/care-plan/care-plan-filters.tsx`
  - 機能: ステータス・要介護度フィルター
  - プロパティ: selectedStatus, selectedCareLevel, onStatusChange, onCareLevelChange, onReset

#### 型定義

- **CarePlan**: ケアプラン情報エンティティ型
  - パス: `types/care-plan.ts`
  - 拡張項目: careLevel, certificationDate, certValidityStart, certValidityEnd

- **CarePlanStatus**: ケアプランステータス型
  - 値: 'active' | 'draft' | 'archived'

- **CarePlanSearchParams**: 検索・フィルターパラメータ型
  - パス: `types/care-plan.ts`

### 状態管理

#### ローカル状態

- ケアプラン一覧の表示状態
- 検索クエリの状態
- フィルター条件の状態
- ローディング状態
- エラー状態

#### データフェッチング

- 初期ローディング時のケアプラン一覧取得
- 利用者情報の取得
- エラー時のリトライ機能

## 参考資料

- [ケアプラン登録画面設計書](https://github.com/ambi-tious/CareBase-staff/issues/113)
- [ケアプラン編集画面設計書](https://github.com/ambi-tious/CareBase-staff/issues/111)
- [利用者詳細画面実装](../page.tsx)
- [CarePlanList コンポーネント](../../../../components/3_organisms/care-plan/care-plan-list.tsx)
- [CarePlanCard コンポーネント](../../../../components/2_molecules/care-plan/care-plan-card.tsx)
- [CarePlan Types](../../../../types/care-plan.ts)
- [Issue #115: [設計] #014 利用者｜利用者詳細（ケアプラン）](https://github.com/ambi-tious/CareBase-staff/issues/115)
- [親Issue #133: 利用者詳細（基本情報）](https://github.com/ambi-tious/CareBase-staff/issues/133)
- [画面一覧](../../../../docs/screen-list.md#利用者管理)