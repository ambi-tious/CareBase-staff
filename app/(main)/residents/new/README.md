# 利用者登録画面設計書

- 画面名: `利用者登録`
- パス: `/residents/new`
- URL: https://carebase-staff.vercel.app/residents/new

## 概要

利用者登録画面設計書です。
職員が新しい利用者の基本情報を入力して、施設への登録を行うためのフォーム画面です。
利用者一覧画面から遷移し、登録完了後は新しく作成された利用者の詳細画面に自動遷移します。

Issue: [#135 [設計] #004 利用者｜利用者登録](https://github.com/ambi-tious/CareBase-staff/issues/135)

## 全体レイアウト

### 画面構成

<img width="1041" height="1127" alt="image" src="https://github.com/user-attachments/assets/9ca6adfc-1f00-4f67-b7e5-f07529f3ec48" />

職員による利用者情報入力のためのフォーム画面として以下の要素で構成：

- ページヘッダー（画面タイトル、説明文、戻るボタン）
- エラー表示エリア（入力エラー時に表示）
- 基本情報入力フォーム（2列レイアウト）
- アクションボタン（キャンセル、登録）

### 画面項目

| 項目名         | コンポーネント | 必須 | 表示条件     | 初期値             | 備考                                            |
| -------------- | -------------- | ---- | ------------ | ------------------ | ----------------------------------------------- |
| 戻るボタン     | Button         | -    | 常時         | 戻る               | アウトライン、ArrowLeft アイコン                |
| 画面タイトル   | Heading        | -    | 常時         | 新規利用者登録     | UserPlus アイコン付き                           |
| 説明文         | Text           | -    | 常時         | 基本情報入力の説明 | 必須項目マークの説明含む                        |
| エラーアラート | Alert          | -    | 送信エラー時 | -                  | 赤色背景、エラーメッセージ表示                  |
| 利用者画像     | FileUpload     | -    | 常時         | 空                 | 画像ファイルのみ、5MB制限、プレビュー表示       |
| 氏名           | FormField      | ◯    | 常時         | 空文字             | テキスト入力、プレースホルダー「山田 太郎」     |
| フリガナ       | FormField      | -    | 常時         | 空文字             | テキスト入力、プレースホルダー「ヤマダ タロウ」 |

| 生年月日 | FormField | ◯ | 常時 | 空文字 | 日付入力 |
| 年齢 | FormSelect | - | 常時 | 空文字 | 選択肢：0歳～120歳、生年月日と相互自動計算 |
| 性別 | FormSelect | ◯ | 常時 | 男 | 選択肢：男性/女性/その他 |
| 所属フロア・グループ | FormSelect | ◯ | 常時 | localStorage自動取得 | ログイン職員のグループを自動設定、編集可能 |
| 所属ユニット・チーム | FormSelect | ◯ | 常時 | localStorage自動取得 | ログイン職員のチームを自動設定、編集可能 |
| 部屋情報 | FormField | - | 常時 | 空文字 | テキスト入力、プレースホルダー「101号室」 |
| 入所日 | FormField | ◯ | 常時 | 空文字 | 日付入力 |
| キャンセルボタン | Button | - | 常時 | キャンセル | アウトライン |
| 登録ボタン | Button | - | 常時 | 登録 | 青色スタイル、Save アイコン |

## 機能仕様

### 自動入力機能

| 項目名               | データソース                                | 取得方法                     | フォールバック処理           |
| -------------------- | ------------------------------------------- | ---------------------------- | ---------------------------- |
| 所属フロア・グループ | localStorage `carebase_selected_staff_data` | `groupName` プロパティを取得 | 空文字のまま（手動入力可能） |
| 所属ユニット・チーム | localStorage `carebase_selected_staff_data` | `teamName` プロパティを取得  | 空文字のまま（手動入力可能） |

#### 自動入力の動作仕様

- **初期化タイミング**: コンポーネントマウント時およびlocalStorageの変更検知時
- **データ構造**: `{ staff: {...}, groupName: string, teamName: string }`
- **更新検知**: `storage` イベントリスナーでスタッフ切り替えを検知
- **フィールド制御**: 自動設定されたフィールドも編集可能

### 相互自動計算機能

#### 生年月日と年齢の自動計算

- **生年月日→年齢**: 生年月日が入力されると年齢を自動計算
- **年齢→生年月日**: 年齢が選択されると生年月日を自動計算（既存の生年月日の月日を基準）
- **計算方式**: JST時間帯での現在日付を基準とした正確な年齢計算
- **更新タイミング**: 各フィールドの値変更時にリアルタイム更新

### アクション

| 項目名           | 処理内容                           | 対象API                          | 遷移先画面                         |
| ---------------- | ---------------------------------- | -------------------------------- | ---------------------------------- |
| 戻るボタン       | 利用者一覧画面に戻る               | -                                | 利用者一覧画面 (`/residents`)      |
| フォーム入力     | リアルタイムバリデーション実行     | -                                | 同一画面（エラー表示更新）         |
| キャンセルボタン | 入力内容を破棄して一覧に戻る       | -                                | 利用者一覧画面 (`/residents`)      |
| 登録ボタン       | 利用者情報を保存して詳細画面に遷移 | `residentService.createResident` | 利用者詳細画面 (`/residents/{id}`) |

### 入力チェック

| 項目名               | イベント | チェック内容               | エラーメッセージ                               |
| -------------------- | -------- | -------------------------- | ---------------------------------------------- |
| 利用者画像           | upload   | ファイルサイズチェック     | ファイルサイズは5MB以下にしてください          |
| 利用者画像           | upload   | ファイル形式チェック       | 画像ファイルを選択してください                 |
| 氏名                 | input    | 必須チェック               | 氏名は必須です                                 |
| フリガナ             | input    | カタカナ形式チェック       | フリガナはカタカナで入力してください           |
| 生年月日             | input    | 必須チェック               | 生年月日は必須です                             |
| 性別                 | select   | 必須チェック               | 性別は必須です                                 |
| 所属フロア・グループ | select   | 必須チェック               | 所属フロア・グループは必須です                 |
| 所属ユニット・チーム | select   | 必須チェック               | 所属ユニット・チームは必須です                 |
| 入所日               | input    | 必須チェック               | 入所日は必須です                               |
| 入所日               | input    | 生年月日との整合性チェック | 入所日は生年月日より後の日付を入力してください |

### バリデーション仕様

#### リアルタイムバリデーション

- **入力時検証**: フォーム項目への入力と同時にバリデーションを実行（`mode: 'onChange'`）
- **エラー表示**: 各項目下部に赤色でエラーメッセージを表示
- **送信制御**: バリデーションエラーがある場合は登録ボタンクリック時に送信を阻止
- **バリデーションライブラリ**: Zod + React Hook Form

#### 文字列検証

- **フリガナ**: カタカナ、長音符、スペースのみ許可（正規表現: `/^[ァ-ヶー\s]+$/`）
- **必須項目**: 空文字、空白のみの入力を無効とする
- **日付形式**: ISO 8601形式での日付入力を要求

#### 日付検証

- **入所日 > 生年月日**: 入所日が生年月日より後の日付であることを確認
- **未来日制限**: 現在日より未来の入所日は警告表示（実装予定）

#### エラーハンドリング

| エラー種別           | 発生条件                           | 表示メッセージ                                         | 表示場所           |
| -------------------- | ---------------------------------- | ------------------------------------------------------ | ------------------ |
| API通信エラー        | residentService.createResident失敗 | 利用者の登録に失敗しました。もう一度お試しください。   | 画面上部アラート   |
| バリデーションエラー | 必須項目未入力時の送信             | 入力内容に不備があります。必須項目を確認してください。 | 画面上部アラート   |
| ファイルサイズエラー | 5MB超過画像アップロード            | ファイルサイズは5MB以下にしてください                  | ブラウザアラート   |
| ファイル形式エラー   | 画像以外ファイルアップロード       | 画像ファイルを選択してください                         | ブラウザアラート   |
| フィールド個別エラー | リアルタイムバリデーション         | 各項目固有のエラーメッセージ                           | 該当フィールド下部 |

#### リアルタイムバリデーション詳細

- **実行タイミング**: フォームデータ変更時（React Hook Form の onChange モード）
- **エラー状態管理**: `useResidentForm` フックで一元管理
- **表示制御**: エラーがある場合のみ赤色でメッセージ表示

## UI/UX仕様

### レスポンシブデザイン

- **モバイル（〜768px）**:
  - フォーム項目を1列で縦並び表示
  - ボタンを全幅で縦積み配置
  - 余白を最小化してコンテンツエリアを最大化
- **タブレット（768px〜1024px）**:
  - フォーム項目を2列グリッドで表示
  - ボタンを右寄せで横並び配置
- **デスクトップ（1024px〜）**:
  - フォーム全体の最大幅を6xlに制限
  - 2列グリッドレイアウトを維持
  - 余白を十分に確保

### カラーテーマ

- **背景色**: `bg-carebase-bg` - アプリケーション標準背景色
- **登録ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark` - メインアクション
- **戻る・キャンセルボタン**: `border-gray-300 text-gray-700` - セカンダリアクション
- **エラーアラート**: `bg-red-50 border-red-200 text-red-700` - エラー状態
- **必須マーク**: `text-red-500` - 必須項目表示
- **セクション見出し**: `text-carebase-text-primary border-b` - セクション分割

### フォームUI仕様

- **入力フィールド間隔**: `gap-6` - 項目間の適切な間隔
- **セクション分割**: 基本情報と施設情報・認定情報を明確に分離
- **ラベル配置**: 各入力フィールドの上部に配置
- **プレースホルダー**: 入力例を示すサンプルテキスト
- **フォーカス状態**: 青色のアウトライン表示

### 画像アップロード仕様

#### ファイル制限

- **対応形式**: `image/*` (JPEG, PNG, GIF, WebP等)
- **ファイルサイズ**: 最大5MB
- **アップロード方式**: Base64エンコードでフォームデータに含める

#### UI動作

- **未選択時**:
  - 点線ボーダーのドロップエリア表示（128x128px）
  - Uploadアイコンと「画像を選択」テキスト
  - クリックでファイル選択ダイアログ表示
- **選択後**:
  - 128x128pxのプレビュー画像表示
  - 「画像を削除」ボタン表示（Xアイコン付き）
  - 削除時はプレビューとフォームデータをクリア

#### エラーハンドリング

- **サイズ超過**: ブラウザアラートで即座通知
- **形式不正**: ブラウザアラートで即座通知
- **読み込み失敗**: コンソールエラーログ出力

### アニメーション

- **ボタンホバー**: スムーズなカラートランジション
- **フォーム送信**: ローディング状態の表示（「登録中...」）
- **エラー表示**: フェードイン効果でアラート表示
- **バリデーション**: リアルタイムでエラーメッセージ表示・非表示

### アクセシビリティ

- **キーボードナビゲーション**: Tabキーでの順次フォーカス移動
- **スクリーンリーダー**:
  - 適切なlabel要素の関連付け
  - 必須項目のaria-required属性
  - エラーメッセージのaria-describedby属性
- **コントラスト比**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスリング表示

### ローディング・無効化状態

#### 送信中状態（isSubmitting: true）

- **フォーム全体**: `disabled={isSubmitting}` で全入力フィールドを無効化
- **戻るボタン**: クリック無効化で誤操作防止
- **キャンセルボタン**: クリック無効化で誤操作防止
- **登録ボタン**:
  - テキスト変更: 「登録」→「登録中...」
  - クリック無効化: `disabled={isSubmitting}`
  - ローディング表示: Saveアイコン継続表示

#### 自動設定フィールド

- **所属フロア・グループ**: localStorage から自動設定、編集可能
- **所属ユニット・チーム**: localStorage から自動設定、編集可能
- **視覚的表示**: 通常の入力フィールドと同様の表示

#### バリデーションエラー時の表示

- **該当フィールド**: 赤色ボーダー表示
- **エラーメッセージ**: フィールド下部に即座表示
- **送信制御**: エラーがある場合は送信処理を中断

## 実装詳細

### データ構造

```typescript
interface ResidentBasicInfo {
  name: string;
  furigana: string;
  dob: string;
  age?: string;
  sex: '男' | '女' | 'その他';
  careLevel: string;
  floorGroup: string;
  unitTeam: string;
  roomInfo: string;
  address: string;
  admissionDate: string;
  profileImage: string;
  certificationDate: string;
  certificationStartDate: string;
  certificationEndDate: string;
}
```

### 自動計算処理

#### 認定期間自動計算

- **認定日**: 入所日と同じ日付に自動設定
- **認定有効期間開始日**: 入所日と同じ日付に自動設定
- **認定有効期間終了日**: 入所日の1年後の前日に自動計算

### API連携

- **作成API**: `residentService.createResident(data: ResidentBasicInfo)`
- **遅延処理**: 1秒のシミュレート遅延
- **ID生成**: 既存の最大IDに1を加えて新しいIDを生成
- **日付変換**: ISO形式からYYYY/MM/DD形式への変換

## 参考資料

- [Issue #135: [設計] #004 利用者｜利用者登録](https://github.com/ambi-tious/CareBase-staff/issues/135)
- [利用者登録画面実装](./page.tsx)
- [ResidentBasicInfoForm コンポーネント](../../../../components/2_molecules/forms/resident-basic-info-form.tsx)
- [useResidentForm カスタムフック](../../../../hooks/useResidentForm.ts) - フォーム状態管理、バリデーション、送信処理
- [residentService](../../../../services/residentService.ts) - 利用者作成API、認定期間自動計算
- [利用者一覧画面設計書](../README.md)
- [利用者詳細画面設計書](../[residentId]/README.md)
- [利用者登録画面テスト](<../../../../__tests__/app/(main)/residents/new/new-resident-page.test.tsx>)
- [ResidentBasicInfoForm テスト](../../../../__tests__/components/2_molecules/forms/resident-basic-info-form.test.tsx)
- [画面一覧](../../../../docs/screen-list.md#利用者管理)
