# 申し送り編集画面設計書

画面名: `申し送り編集`  
パス: `/handovers/edit/[handoverId]`  
URL: https://carebase-staff.vercel.app/handovers/edit/[handoverId]

## 概要

CareBase-staffアプリケーションの申し送り編集画面設計書です。  
既存の申し送り情報を編集・更新する機能を提供し、医療・介護現場での情報共有の修正や追記を効率的に行えます。  
テンプレート文章機能、画像・動画添付機能、下書き保存機能、コメント機能を含む包括的な編集機能を提供します。

## 全体レイアウト

### 画面構成

申し送り編集のメイン画面として以下の要素で構成：

- ページヘッダー（画面タイトル、説明文、戻るボタン、削除ボタン）
- 成功・エラーメッセージ表示エリア
- 申し送り者情報表示（変更不可）
- 申し送り編集フォーム（2列レイアウト）
- テンプレート文章機能エリア
- 添付ファイル管理エリア
- コメント機能エリア
- アクションボタン（キャンセル、下書き保存、更新）
- 削除確認モーダル

### 画面項目

| 項目名               | コンポーネント   | 必須 | 表示条件       | 初期値               | 備考                                                     |
| -------------------- | ---------------- | ---- | -------------- | -------------------- | -------------------------------------------------------- |
| 戻るボタン           | Button           | -    | 常時           | 戻る                 | アウトライン、ArrowLeft アイコン                         |
| 画面タイトル         | Heading          | -    | 常時           | 申し送り編集         | Edit3 アイコン付き                                       |
| 削除ボタン           | Button           | -    | 常時           | 削除                 | 赤色アウトライン、Trash2 アイコン                        |
| 説明文               | Text             | -    | 常時           | 編集説明             | 必須項目マークの説明含む                                 |
| 成功メッセージ       | Alert            | -    | 更新成功時     | -                    | 緑色背景、CheckCircle アイコン                           |
| エラーアラート       | Alert            | -    | 更新エラー時   | -                    | 赤色背景、エラーメッセージ表示                           |
| 申し送り者表示       | InfoDisplay      | -    | 常時           | 作成者名             | 青色背景、User アイコン付き、編集不可                    |
| 作成日時表示         | InfoDisplay      | -    | 常時           | 作成日時             | グレー色、Clock アイコン付き                             |
| 件名入力             | FormField        | ◯    | 常時           | 既存データ           | テキスト入力、プレースホルダー「佐藤様の血圧について」   |
| カテゴリ選択         | FormSelect       | ◯    | 常時           | 既存データ           | 医療/介護/連絡事項/緊急/家族対応/その他                  |
| 重要度選択           | FormSelect       | ◯    | 常時           | 既存データ           | 高/中/低                                                 |
| 実施予定日入力       | FormField        | -    | 常時           | 既存データ           | 日付入力                                                 |
| 実施予定時刻入力     | FormField        | -    | 常時           | 既存データ           | 時刻入力                                                 |
| 申し送り先選択       | StaffSelector    | ◯    | 常時           | 既存データ           | 複数選択可能、検索機能付き                               |
| 対象利用者選択       | ResidentSelector | -    | 常時           | 既存データ           | 単一選択、検索機能付き                                   |
| 申し送り内容入力     | Textarea         | ◯    | 常時           | 既存データ           | 大きなテキストエリア、1000文字制限                       |
| テンプレート選択     | TemplateSelector | -    | 常時           | 未選択               | 定型文テンプレート選択                                   |
| テンプレート挿入     | Button           | -    | テンプレート選択時 | テンプレート挿入     | 青色アウトライン、FileText アイコン                      |
| 添付ファイル一覧     | FileList         | -    | 常時           | 既存添付ファイル     | アップロード済みファイルの一覧表示                       |
| ファイル追加ボタン   | Button           | -    | 常時           | ファイル追加         | アウトライン、Paperclip アイコン                         |
| コメント一覧         | CommentList      | -    | 常時           | 既存コメント         | コメントの一覧表示                                       |
| コメント入力         | Textarea         | -    | 常時           | 空文字               | コメント入力エリア、500文字制限                          |
| コメント送信ボタン   | Button           | -    | コメント入力時 | コメント送信         | 青色、MessageSquare アイコン                             |
| 未保存変更警告       | Alert            | -    | 変更あり時     | -                    | 黄色背景、AlertCircle アイコン                           |
| キャンセルボタン     | Button           | -    | 常時           | キャンセル           | アウトライン                                             |
| 下書き保存ボタン     | Button           | -    | 常時           | 下書き保存           | アウトライン、Save アイコン                              |
| 更新ボタン           | Button           | -    | 常時           | 申し送りを更新       | 青色スタイル、Send アイコン                              |
| 削除確認モーダル     | Modal            | -    | 削除時         | -                    | 削除確認ダイアログ                                       |

## 機能仕様

### アクション

| 項目名             | 処理内容                           | 対象API                            | 遷移先画面                                    |
| ------------------ | ---------------------------------- | ---------------------------------- | --------------------------------------------- |
| 戻るボタン         | 申し送り詳細画面に戻る             | -                                  | 申し送り詳細画面 (`/handovers/{id}`)          |
| フォーム入力       | リアルタイムバリデーション実行     | -                                  | 同一画面（エラー表示更新）                    |
| テンプレート選択   | テンプレート一覧から選択           | `GET /api/v1/handover-templates`   | 同一画面（テンプレート表示）                  |
| テンプレート挿入   | 選択テンプレートを内容に挿入       | -                                  | 同一画面（内容更新）                          |
| ファイル追加       | 画像・動画ファイルのアップロード   | `POST /api/v1/handovers/{id}/files` | 同一画面（添付ファイル一覧更新）              |
| ファイル削除       | 添付ファイルの削除                 | `DELETE /api/v1/handovers/{id}/files/{fileId}` | 同一画面（添付ファイル一覧更新）              |
| コメント送信       | コメントを追加                     | `POST /api/v1/handovers/{id}/comments` | 同一画面（コメント一覧更新）                  |
| 下書き保存         | 入力内容を下書きとして保存         | `PUT /api/v1/handovers/{id}/draft` | 同一画面（成功メッセージ表示）                |
| 更新ボタン         | 申し送りを確定して更新             | `PUT /api/v1/handovers/{id}`       | 申し送り詳細画面 (`/handovers/{id}`)          |
| 削除ボタン         | 削除確認モーダルを表示             | -                                  | 同一画面（モーダル表示）                      |
| 削除確認           | 申し送りを削除                     | `DELETE /api/v1/handovers/{id}`    | 申し送り一覧画面 (`/handovers`)               |
| キャンセルボタン   | 入力内容を破棄して詳細に戻る       | -                                  | 申し送り詳細画面 (`/handovers/{id}`)          |

### 入力チェック

| 項目名           | イベント | チェック内容                   | エラーメッセージ                         |
| ---------------- | -------- | ------------------------------ | ---------------------------------------- |
| 件名入力         | blur     | 必須チェック                   | 件名は必須です                           |
| 件名入力         | blur     | 文字数チェック（100文字以内）  | 件名は100文字以内で入力してください      |
| カテゴリ選択     | change   | 必須選択チェック               | カテゴリは必須です                       |
| 重要度選択       | change   | 必須選択チェック               | 重要度は必須です                         |
| 申し送り先選択   | change   | 必須選択チェック               | 申し送り先を選択してください             |
| 申し送り内容     | blur     | 必須チェック                   | 内容は必須です                           |
| 申し送り内容     | input    | 文字数チェック（1000文字以内） | 内容は1000文字以内で入力してください     |
| ファイル追加     | change   | ファイル形式チェック           | サポートされていないファイル形式です     |
| ファイル追加     | change   | ファイルサイズチェック（10MB） | ファイルサイズは10MB以下にしてください   |
| コメント入力     | input    | 文字数チェック（500文字以内）  | コメントは500文字以内で入力してください  |
| フォーム送信     | submit   | 全必須項目チェック             | 必須項目をすべて入力してください         |

### バリデーション仕様

#### リアルタイムバリデーション

- **入力時検証**: フォーム項目への入力と同時にバリデーションを実行
- **エラー表示**: 各項目下部に赤色でエラーメッセージを表示
- **送信制御**: バリデーションエラーがある場合は送信ボタンクリック時に送信を阻止

#### 文字数制限

- **件名**: 100文字以内
- **申し送り内容**: 1000文字以内、リアルタイム文字数表示
- **コメント**: 500文字以内、リアルタイム文字数表示
- **文字数表示**: 入力中の文字数を「xxx/1000文字」形式で表示

#### テンプレート機能仕様

- **テンプレート一覧**: カテゴリ別にテンプレートを表示
- **テンプレート挿入**: 現在のカーソル位置または選択範囲に挿入
- **カスタマイズ**: 挿入後に内容を編集可能
- **履歴保存**: よく使用するテンプレートの履歴表示

#### 添付ファイル仕様

- **対応形式**: 
  - 画像: JPEG, PNG, GIF, WebP（最大10MB）
  - 動画: MP4, MOV, AVI（最大50MB）
  - 文書: PDF, DOC, DOCX, TXT（最大10MB）
- **プレビュー**: 画像・動画のサムネイル表示
- **一覧表示**: ファイル名、サイズ、アップロード日時
- **削除機能**: 個別ファイルの削除機能

#### コメント機能仕様

- **リアルタイム更新**: 新しいコメントの自動表示
- **投稿者表示**: コメント投稿者名と投稿日時
- **編集・削除**: 自分のコメントのみ編集・削除可能
- **未読表示**: 新しいコメントの未読バッジ

#### 下書き保存仕様

- **バリデーション**: 下書き保存時は必須項目チェックを緩和
- **自動保存**: 5分ごとの自動下書き保存
- **復元機能**: 下書きからの復元機能
- **変更検知**: 未保存変更の検知と警告表示

#### エラーハンドリング

- **API通信エラー**: 「ネットワークエラーが発生しました。接続を確認してもう一度お試しください。」
- **バリデーションエラー**: 「入力内容に不備があります。必須項目を確認してください。」
- **更新エラー**: 「申し送りの更新に失敗しました。もう一度お試しください。」
- **削除エラー**: 「申し送りの削除に失敗しました。もう一度お試しください。」
- **ファイルアップロードエラー**: 「ファイルのアップロードに失敗しました。ファイル形式とサイズを確認してください。」
- **下書き保存エラー**: 「下書き保存に失敗しました。もう一度お試しください。」

## UI/UX仕様

### レスポンシブデザイン

- **モバイル（〜768px）**:
  - フォーム項目を1列で縦並び表示
  - テンプレート・添付・コメント機能をタブ形式で表示
  - ボタンを全幅で縦積み配置
  - 余白を最小化してコンテンツエリアを最大化
- **タブレット（768px〜1024px）**:
  - フォーム項目を2列グリッドで表示
  - サイドバーでテンプレート・添付・コメント機能を表示
  - ボタンを右寄せで横並び配置
- **デスクトップ（1024px〜）**:
  - フォーム全体の最大幅を6xlに制限
  - 2列グリッドレイアウトを維持
  - サイドバーで補助機能を配置
  - 余白を十分に確保

### カラーテーマ

- **背景色**: `bg-carebase-bg` - アプリケーション標準背景色
- **更新ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark` - メインアクション
- **下書き保存ボタン**: `border-gray-400 text-gray-700 hover:bg-gray-50` - セカンダリアクション
- **削除ボタン**: `border-red-300 text-red-600 hover:bg-red-50` - 危険なアクション
- **戻る・キャンセルボタン**: `border-gray-300 text-gray-700` - セカンダリアクション
- **成功アラート**: `bg-green-50 border-green-200 text-green-700` - 成功状態
- **エラーアラート**: `bg-red-50 border-red-200 text-red-700` - エラー状態
- **警告アラート**: `bg-yellow-50 border-yellow-200 text-yellow-800` - 警告状態
- **申し送り者表示**: `bg-blue-50 border-blue-200 text-blue-800` - 情報表示
- **テンプレートエリア**: `bg-gray-50 border-gray-200` - 補助エリア
- **コメントエリア**: `bg-gray-50 border-gray-200` - 補助エリア

### フォームUI仕様

- **入力フィールド間隔**: `gap-6` - 項目間の適切な間隔
- **セクション分割**: 基本情報、テンプレート機能、添付機能、コメント機能を明確に分離
- **ラベル配置**: 各入力フィールドの上部に配置
- **プレースホルダー**: 入力例を示すサンプルテキスト
- **フォーカス状態**: 青色のアウトライン表示
- **文字数カウンター**: 申し送り内容・コメントの下部に表示

### テンプレート機能UI仕様

- **テンプレート一覧**: カードレイアウトで表示
- **カテゴリフィルター**: タブ形式でカテゴリ切り替え
- **検索機能**: テンプレート名での検索
- **プレビュー**: マウスオーバーでテンプレート内容を表示
- **挿入ボタン**: 各テンプレートに挿入ボタンを配置

### 添付ファイル機能UI仕様

- **ドラッグ&ドロップ**: ファイル追加エリアでのD&D対応
- **ファイル一覧**: グリッド形式で添付ファイルを表示
- **プレビュー**: 画像・動画のサムネイル表示
- **進捗表示**: アップロード時のプログレスバー
- **削除ボタン**: 各ファイルに削除ボタンを配置

### コメント機能UI仕様

- **チャット形式**: コメントをチャット形式で表示
- **投稿者アバター**: ユーザーアイコンまたはイニシャル表示
- **時系列表示**: 新しいコメントを下部に表示
- **自動スクロール**: 新コメント追加時に自動スクロール
- **未読バッジ**: 新コメント数の表示

### アニメーション

- **ボタンホバー**: スムーズなカラートランジション
- **フォーム送信**: ローディング状態の表示（「更新中...」「保存中...」）
- **アラート表示**: フェードイン効果でアラート表示
- **バリデーション**: リアルタイムでエラーメッセージ表示・非表示
- **モーダル表示**: フェードイン・スケールアニメーション
- **ファイルアップロード**: プログレスアニメーション
- **コメント追加**: スライドイン効果

### アクセシビリティ

- **キーボードナビゲーション**: Tabキーでの順次フォーカス移動
- **スクリーンリーダー**:
  - 適切なlabel要素の関連付け
  - 必須項目のaria-required属性
  - エラーメッセージのaria-describedby属性
  - テンプレート・添付・コメント機能のaria-label
- **コントラスト比**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスリング表示
- **音声読み上げ**: 重要なアクション結果の音声フィードバック

### ローディング・無効化状態

- **更新中状態**:
  - 全フォーム要素の無効化
  - 更新ボタンテキストを「更新中...」に変更
  - 下書き保存ボタンの無効化
- **下書き保存中状態**:
  - 下書き保存ボタンテキストを「保存中...」に変更
  - 更新ボタンの無効化
- **削除中状態**:
  - 削除ボタンテキストを「削除中...」に変更
  - 全ボタンの無効化
- **ファイルアップロード中状態**:
  - アップロード対象ファイルの無効化
  - プログレスバーの表示
- **コメント送信中状態**:
  - コメント入力エリアの無効化
  - 送信ボタンテキストを「送信中...」に変更
- **バリデーションエラー時**:
  - 該当フィールドの赤色ボーダー表示
  - エラーメッセージの即座表示

## 技術仕様

### 使用コンポーネント

#### 2_molecules層

- **HandoverEditForm**: 申し送り編集フォーム
- **TemplateSelector**: テンプレート選択・挿入
- **FileUploader**: ファイルアップロード
- **CommentSystem**: コメント機能
- **HandoverDeleteModal**: 削除確認モーダル

#### 1_atoms層

- **CategoryBadge**: カテゴリバッジ表示
- **PriorityBadge**: 重要度バッジ表示
- **StatusBadge**: ステータスバッジ表示
- **FilePreview**: ファイルプレビュー
- **CommentItem**: コメント項目

#### カスタムフック

- **useHandoverEditForm**: フォーム状態管理とバリデーション
- **useFileUpload**: ファイルアップロード管理
- **useComments**: コメント機能管理
- **useTemplates**: テンプレート機能管理

#### サービス層

- **handoverService**: 申し送りのCRUD操作
- **templateService**: テンプレート管理
- **fileService**: ファイル管理
- **commentService**: コメント管理

### データ型定義

```typescript
interface HandoverEditFormData {
  title: string; // 件名（必須、100文字以内）
  content: string; // 内容（必須、1000文字以内）
  category: HandoverCategory; // カテゴリ（必須）
  priority: HandoverPriority; // 重要度（必須）
  targetStaffIds: string[]; // 申し送り先（必須、1名以上）
  residentId?: string; // 対象利用者（任意）
  scheduledDate?: string; // 実施予定日（任意）
  scheduledTime?: string; // 実施予定時刻（任意）
  attachments?: HandoverAttachment[]; // 添付ファイル（任意）
  isDraft?: boolean; // 下書きフラグ（任意）
}

interface HandoverTemplate {
  id: string;
  name: string;
  content: string;
  category: HandoverCategory;
  createdBy: string;
  createdAt: string;
  usageCount: number;
}

interface HandoverAttachment {
  id: string;
  fileName: string;
  fileType: string;
  fileSize: number;
  filePath: string;
  uploadedBy: string;
  uploadedAt: string;
  thumbnailPath?: string;
}

interface HandoverComment {
  id: string;
  handoverId: string;
  content: string;
  createdBy: string;
  createdByName: string;
  createdAt: string;
  updatedAt?: string;
  isRead: boolean;
}
```

### API仕様

| メソッド | エンドポイント                                    | 説明                     |
| -------- | ------------------------------------------------- | ------------------------ |
| GET      | `/api/v1/handovers/{id}`                          | 申し送り詳細取得         |
| PUT      | `/api/v1/handovers/{id}`                          | 申し送り更新             |
| DELETE   | `/api/v1/handovers/{id}`                          | 申し送り削除             |
| PUT      | `/api/v1/handovers/{id}/draft`                    | 下書き保存               |
| GET      | `/api/v1/handover-templates`                      | テンプレート一覧取得     |
| POST     | `/api/v1/handovers/{id}/files`                    | ファイルアップロード     |
| DELETE   | `/api/v1/handovers/{id}/files/{fileId}`           | 添付ファイル削除         |
| GET      | `/api/v1/handovers/{id}/comments`                 | コメント一覧取得         |
| POST     | `/api/v1/handovers/{id}/comments`                 | コメント投稿             |
| PUT      | `/api/v1/handovers/{id}/comments/{commentId}`     | コメント更新             |
| DELETE   | `/api/v1/handovers/{id}/comments/{commentId}`     | コメント削除             |

### 状態管理

- **フォーム状態**: 入力値、バリデーション状態、送信状態
- **テンプレート状態**: 選択中テンプレート、テンプレート一覧
- **ファイル状態**: アップロード進捗、添付ファイル一覧
- **コメント状態**: コメント一覧、新規コメント、未読状態
- **エラー状態**: API通信エラー、バリデーションエラー
- **成功状態**: 更新成功、下書き保存成功
- **未保存変更**: フォーム変更の検知と警告表示

## 削除機能仕様

### 削除確認フロー

1. **削除ボタンクリック**: 削除確認モーダルを表示
2. **確認メッセージ**: 申し送りタイトルを含む確認メッセージ
3. **削除実行**: 確認後にAPI呼び出し
4. **完了処理**: 削除成功後に一覧画面に遷移

### 削除時の注意事項

- **データ復元不可**: 削除されたデータは復元できない旨を明示
- **関連データ**: 添付ファイル・コメントも同時削除される旨を説明
- **二段階確認**: モーダル表示による確認プロセス
- **エラーハンドリング**: 削除失敗時の適切なエラー表示

## テンプレート機能仕様

### テンプレート管理

- **カテゴリ別表示**: 申し送りカテゴリに応じたテンプレート表示
- **検索機能**: テンプレート名・内容での検索
- **使用頻度**: よく使用するテンプレートの優先表示
- **カスタムテンプレート**: ユーザー独自のテンプレート作成（将来実装）

### テンプレート挿入

- **カーソル位置挿入**: 現在のカーソル位置に挿入
- **選択範囲置換**: 選択中のテキストを置換
- **変数置換**: `{利用者名}` 等の変数を実際の値に置換
- **フォーマット保持**: 改行・インデント等のフォーマット保持

## コメント機能仕様

### コメント表示

- **時系列表示**: 投稿日時順でコメントを表示
- **投稿者情報**: 投稿者名・投稿日時・アバター表示
- **未読管理**: 新規コメントの未読状態管理
- **自動更新**: 5秒間隔でコメント一覧を自動更新

### コメント投稿

- **リアルタイム投稿**: 送信と同時にコメント一覧に反映
- **文字数制限**: 500文字以内の制限
- **入力支援**: Enter キーでの送信（Shift+Enter で改行）
- **投稿確認**: 投稿成功時の視覚的フィードバック

## 参考資料

- [申し送り一覧画面設計書](../../README.md)
- [申し送り作成画面設計書](../../new/README.md)
- [申し送り詳細画面設計書](../../[handoverId]/README.md)
- [HandoverEditForm コンポーネント](../../../../components/2_molecules/handover/handover-edit-form.tsx)
- [useHandoverEditForm フック](../../../../hooks/useHandoverEditForm.ts)
- [Handover Types](../../../../types/handover.ts)
- [Handover Service](../../../../services/handoverService.ts)
- [画面一覧](../../../../docs/screen-list.md#申し送り介護記録)
- [FlutterFlow 申し送り編集画面参考資料](https://github.com/user-attachments/assets/89980d2d-f34b-457a-9073-b3d414081065)