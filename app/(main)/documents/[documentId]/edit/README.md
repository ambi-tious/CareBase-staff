# 書類編集画面設計書

画面名: `書類編集`  
パス: `/documents/[documentId]/edit`  
URL: [https://carebase-staff.vercel.app/documents/edit/doc-3](https://carebase-staff.vercel.app/documents/edit/doc-3)

## 概要

CareBase-staffアプリケーションの書類編集画面設計書です。  
既存書類の編集機能を提供し、議事録形式でのコンテンツ管理、下書き保存、画像・動画添付機能を備えます。  
GoogleDocs風のインターフェースで直感的な編集体験を実現し、会議記録の効率的な作成・更新を支援します。

Issue: [#75 [設計] #034 書類｜書類編集](https://github.com/ambi-tious/CareBase-staff/issues/75)

## 全体レイアウト

### 画面構成

<img width="1470" height="793" alt="スクリーンショット 2025-07-30 10 29 53" src="https://github.com/user-attachments/assets/e7c4f0dc-3e2f-4fe8-a668-a53ad90d32e0" />

書類編集のメイン画面として以下の要素で構成：

- ページヘッダー（書類タイトル、保存状態、アクションボタン）
- 書類メタデータ編集エリア（日時・分類・場所・参加者等）
- GoogleDocs風リッチテキストエディター（メインコンテンツ編集）
- 添付ファイル管理エリア（画像・動画アップロード）
- 保存・公開アクションエリア

### 画面項目

| 項目名             | コンポーネント | 必須 | 表示条件     | 初期値                 | 備考                                     |
| ------------------ | -------------- | ---- | ------------ | ---------------------- | ---------------------------------------- |
| 戻るボタン         | Button         | -    | 常時         | 戻る                   | アウトライン、ArrowLeft アイコン         |
| 書類タイトル       | FormField      | ◯    | 常時         | 既存データまたは空文字 | 大見出し形式、インライン編集             |
| 保存状態表示       | Badge          | -    | 常時         | 自動保存済み/未保存    | 緑色/グレー、リアルタイム更新            |
| 下書き保存ボタン   | Button         | -    | 常時         | 下書き保存             | アウトライン                             |
| 公開ボタン         | Button         | -    | 常時         | 公開                   | 青色スタイル、Send アイコン              |
| 内容エディター     | RichTextEditor | ◯    | 常時         | 既存データまたは空     | GoogleDocs風、フォーマット機能           |
| 要約               | FormField      | -    | 常時         | 既存データまたは空文字 | 複数行テキスト、AI生成ボタン（将来実装） |
| 備考               | FormField      | -    | 常時         | 既存データまたは空文字 | 複数行テキスト、自由記述                 |
| 添付ファイル       | FileUpload     | -    | 常時         | 既存ファイルまたは空   | ドラッグ&ドロップ、画像・動画対応        |
| ファイルプレビュー | MediaPreview   | -    | ファイル有時 | -                      | 画像はサムネイル、動画は再生コントロール |

## 機能仕様

### 自動保存機能

| 機能名   | 動作タイミング               | 保存内容               | 視覚的フィードバック           |
| -------- | ---------------------------- | ---------------------- | ------------------------------ |
| 自動保存 | フィールド変更から3秒後      | 全フォームデータ       | 「自動保存済み」緑色バッジ表示 |
| 手動保存 | 下書き保存ボタンクリック     | 下書きステータスで保存 | 「下書き保存しました」通知     |
| 公開保存 | 公開ボタンクリック           | 公開ステータスで保存   | 「書類を公開しました」通知     |
| 一時保存 | ページ離脱時（beforeunload） | 現在の編集内容         | 確認ダイアログ表示             |

### アクション

| 項目名       | 処理内容                         | 対象API                          | 遷移先画面                       |
| ------------ | -------------------------------- | -------------------------------- | -------------------------------- |
| 戻るボタン   | 書類一覧画面に戻る               | -                                | 書類一覧画面 (`/documents`)      |
| 自動保存     | フォーム内容を下書きとして保存   | `PUT /api/v1/documents/{id}`     | 同一画面（状態更新）             |
| 下書き保存   | 現在の内容を下書きとして保存     | `PUT /api/v1/documents/{id}`     | 同一画面（成功通知）             |
| 公開         | 書類を公開状態で保存             | `PUT /api/v1/documents/{id}`     | 書類詳細画面 (`/documents/{id}`) |
| ファイル添付 | 画像・動画ファイルをアップロード | `POST /api/v1/documents/upload`  | 同一画面（プレビュー表示）       |
| ファイル削除 | 添付ファイルを削除               | `DELETE /api/v1/documents/file`  | 同一画面（プレビュー削除）       |
| AI要約生成   | コンテンツからAI要約を生成       | `POST /api/v1/documents/summary` | 同一画面（要約フィールド更新）   |
| 編集履歴表示 | 書類の編集履歴を表示             | `GET /api/v1/documents/history`  | 履歴モーダル表示                 |

### 入力チェック

| 項目名       | イベント | チェック内容               | エラーメッセージ                        |
| ------------ | -------- | -------------------------- | --------------------------------------- |
| 書類タイトル | input    | 必須チェック               | タイトルは必須です                      |
| 書類タイトル | input    | 文字数制限（100文字以内）  | タイトルは100文字以内で入力してください |
| 内容         | editor   | 必須チェック               | 内容は必須です                          |
| 添付ファイル | upload   | ファイルサイズチェック     | ファイルサイズは50MB以下にしてください  |
| 添付ファイル | upload   | ファイル形式チェック       | サポートされていないファイル形式です    |
| 添付ファイル | upload   | ファイル数制限（10個まで） | 添付ファイルは10個まで追加可能です      |

### バリデーション仕様

#### リアルタイムバリデーション

- **入力時検証**: フォーム項目への入力と同時にバリデーションを実行
- **エラー表示**: 各項目下部に赤色でエラーメッセージを表示
- **保存制御**: バリデーションエラーがある場合は公開ボタンを無効化
- **自動保存制御**: エラーがあっても下書きとしては保存可能

#### 文字数制限

- **タイトル**: 100文字以内
- **要約**: 1000文字以内
- **今後のアクション**: 2000文字以内
- **備考**: 2000文字以内

#### ファイル制限

- **対応形式**:
  - 画像: JPEG, PNG, GIF, WebP
  - 動画: MP4, WebM, MOV
  - 文書: PDF, DOC, DOCX, XLS, XLSX
- **ファイルサイズ**: 50MB以下/ファイル
- **ファイル数**: 10個まで
- **総容量**: 500MB以下

#### エラーハンドリング

| エラー種別           | 発生条件                     | 表示メッセージ                                         | 表示場所           |
| -------------------- | ---------------------------- | ------------------------------------------------------ | ------------------ |
| API通信エラー        | 保存処理失敗                 | 保存に失敗しました。ネットワーク接続を確認してください | 画面上部アラート   |
| バリデーションエラー | 必須項目未入力での公開       | 入力内容に不備があります。必須項目を確認してください   | 画面上部アラート   |
| ファイルサイズエラー | 50MB超過ファイルアップロード | ファイルサイズは50MB以下にしてください                 | ファイル下部エラー |
| ファイル形式エラー   | サポート外形式アップロード   | サポートされていないファイル形式です                   | ファイル下部エラー |
| 権限エラー           | 編集権限なし                 | この書類を編集する権限がありません                     | 画面上部アラート   |

## UI/UX仕様

### レスポンシブデザイン

- **モバイル（〜768px）**:
  - メタデータ項目を1列で縦並び表示
  - チックテキストエディターは全幅表示
  - ツールバーは横スクロール対応
  - 添付ファイルは縦積み表示
- **タブレット（768px〜1024px）**:
  - メタデータを2列グリッドで表示
  - エディター領域とサイドバーを分離
  - ツールバーは2行表示
- **デスクトップ（1024px〜）**:
  - 左サイド: メタデータ・添付ファイル（固定幅400px）
  - 右メイン: リッチテキストエディター（可変幅）
  - ツールバーは1行で全機能表示

### GoogleDocs風インターフェース

#### エディター機能

- **テキスト装飾**:
  - 太字、斜体、下線、取り消し線
  - フォントサイズ変更（10px〜24px）
  - 文字色・背景色選択
  - ハイライト機能
- **段落機能**:
  - 見出し（H1〜H3）
  - 箇条書き（・、数字）
  - インデント調整
  - 文字揃え（左・中央・右・両端）
- **挿入機能**:
  - ハイパーリンク
  - 水平線
  - 表の挿入（3×3〜10×10）
  - 画像埋め込み（添付ファイルから）

#### ツールバー構成

| セクション     | 機能                               | アイコン                    |
| -------------- | ---------------------------------- | --------------------------- |
| 履歴           | 元に戻す、やり直し                 | Undo, Redo                  |
| フォーマット   | 太字、斜体、下線、取り消し線       | Bold, Italic, Underline     |
| 色・ハイライト | 文字色、背景色、ハイライト         | Palette, Highlighter        |
| 段落           | 見出し、箇条書き、番号付きリスト   | Heading, List, NumberedList |
| 配置           | 左揃え、中央揃え、右揃え、両端揃え | AlignLeft, AlignCenter      |
| 挿入           | リンク、表、画像、水平線           | Link, Table, Image          |
| 表示           | プレビュー、全画面、印刷プレビュー | Eye, Maximize, Print        |

### カラーテーマ

- **背景色**: `bg-carebase-bg` - アプリケーション標準背景色
- **エディター背景**: `bg-white` - 文書編集エリア
- **公開ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark` - メインアクション
- **下書きボタン**: `border-gray-300 text-gray-700 hover:bg-gray-50` - セカンダリ
- **保存状態バッジ**: `bg-green-100 text-green-700` - 成功状態
- **エラーアラート**: `bg-red-50 border-red-200 text-red-700` - エラー状態
- **必須マーク**: `text-red-500` - 必須項目表示
- **ツールバー**: `bg-gray-50 border-b border-gray-200` - エディター境界

### ファイル添付UI仕様

#### アップロード領域

- **未添付時**:
  - 点線ボーダーのドロップエリア表示（200px高）
  - Upload アイコンと「ファイルを選択またはドラッグ&ドロップ」
  - 対応形式とサイズ制限の説明文表示
  - ホバー時に背景色変更（`hover:bg-blue-50`）
- **添付後**:
  - ファイルリスト表示（サムネイル付き）
  - 各ファイルに削除ボタン（Xアイコン）
  - 「さらに追加」ボタン表示

#### ファイルプレビュー

- **画像ファイル**:
  - 64x64pxサムネイル表示
  - クリックで拡大モーダル表示
  - ファイル名とサイズ表示
- **動画ファイル**:
  - 64x64px動画プレビュー（最初のフレーム）
  - 再生ボタンオーバーレイ
  - クリックで動画プレーヤーモーダル
- **文書ファイル**:
  - ファイル形式別アイコン表示
  - ファイル名とサイズ表示
  - ダウンロードリンク

### アニメーション

- **自動保存**: フェードイン・アウトでバッジ変更
- **エラー表示**: シェイクアニメーション付きアラート表示
- **ファイルアップロード**: プログレスバー表示
- **ツールバーホバー**: スムーズなボタンハイライト
- **モーダル表示**: フェードとスケールアニメーション

### アクセシビリティ

- **キーボードナビゲーション**:
  - Tab キーでの順次フォーカス移動
  - エディター内でのキーボードショートカット対応
  - Ctrl+S で保存、Ctrl+Z で元に戻す
- **スクリーンリーダー**:
  - 適切な見出し構造（h1, h2, h3）
  - フォーム要素の label 関連付け
  - エラーメッセージの aria-describedby 属性
  - エディターの編集可能領域説明
- **コントラスト比**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスリング表示

## 技術仕様

### 使用コンポーネント

#### 1_atoms層

- **FormField**: テキスト入力フィールド
- **FormSelect**: 選択ボックス
- **Button**: 各種アクションボタン
- **Badge**: 保存状態表示
- **FileUpload**: ファイルアップロード

#### 2_molecules層

- **DocumentFormFields**: 書類メタデータ入力フォーム
- **DocumentEditor**: リッチテキストエディター
- **DocumentToolbar**: エディターツールバー
- **FilePreviewCard**: 添付ファイルプレビュー
- **AutoSaveIndicator**: 自動保存状態表示

#### 3_organisms層

- **DocumentFormEditor**: 書類編集フォーム全体
- **DocumentEditHeader**: ページヘッダー
- **MediaUploadArea**: メディアアップロード領域

### データ型定義

```typescript
interface Document {
  id: string;
  title: string;
  content: string;
  category: 'meeting-minutes' | 'report' | 'proposal' | 'other';
  description: string;
  status: 'draft' | 'published' | 'archived';
  tags: string;
  createdAt: Date;
  updatedAt: Date;
  // 議事録固有フィールド
  meetingDate: Date;
  location?: string;
  participants?: string;
  summary?: string;
  futureActions?: string;
  notes?: string;
  attachedFiles: AttachedFile[];
}

interface AttachedFile {
  id: string;
  name: string;
  size: number;
  type: string;
  url: string;
  thumbnailUrl?: string;
  createdAt: Date;
}

interface DocumentFormData {
  title: string;
  category: string;
  description: string;
  status: 'draft' | 'published' | 'archived';
  tags: string;
  meetingDate: string;
  location: string;
  participants: string;
  summary: string;
  futureActions: string;
  notes: string;
}
```

### API エンドポイント

| メソッド | エンドポイント                         | 説明                 |
| -------- | -------------------------------------- | -------------------- |
| GET      | `/api/v1/documents/{id}`               | 書類詳細取得         |
| PUT      | `/api/v1/documents/{id}`               | 書類更新             |
| POST     | `/api/v1/documents/{id}/upload`        | ファイルアップロード |
| DELETE   | `/api/v1/documents/{id}/file/{fileId}` | 添付ファイル削除     |
| POST     | `/api/v1/documents/{id}/summary`       | AI要約生成           |
| GET      | `/api/v1/documents/{id}/history`       | 編集履歴取得         |
| POST     | `/api/v1/documents/{id}/autosave`      | 自動保存             |

### 状態管理

- **フォーム状態**: React Hook Form による状態管理
- **自動保存**: useDebounce フックで3秒遅延保存
- **ファイル管理**: ローカル状態とAPIの同期管理
- **エディター状態**: Slate.js または TipTap でのリッチテキスト状態
- **エラー処理**: React Error Boundary での例外処理

### パフォーマンス最適化

- **遅延読み込み**: 画像・動画の lazy loading
- **メモ化**: React.memo による再レンダリング防止
- **デバウンス**: 自動保存とバリデーションの最適化
- **仮想化**: 大量ファイル添付時のリスト仮想化
- **キャッシュ**: SWR によるAPIレスポンスキャッシュ

## 参考資料

- [書類編集画面実装](./page.tsx)
- [DocumentFormEditor コンポーネント](../../../../../components/3_organisms/documents/document-form-editor.tsx)
- [DocumentFormFields コンポーネント](../../../../../components/2_molecules/documents/document-form-fields.tsx)
- [Document Types](../../../../../types/document.ts)
- [書類一覧画面設計書](../../README.md)
- [書類詳細画面設計書](../README.md)
- [FlutterFlow参考画面](https://github.com/user-attachments/assets/3a44da98-1032-47ad-a8cf-3fe4c6cac27d)
- [画面一覧](../../../../../docs/screen-list.md#書類管理)
