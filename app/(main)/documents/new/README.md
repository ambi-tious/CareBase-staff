# 書類登録画面設計書

画面名: `書類登録`  
パス: `/documents/new`  
URL: https://carebase-staff.vercel.app/documents/new

## 概要

CareBase-staffアプリケーションの書類登録画面設計書です。  
職員が新しい書類（議事録等）を作成・登録するためのフォーム画面です。  
GoogleDocs風のインターフェースを採用し、下書き機能や画像・動画添付機能を提供します。  
書類一覧画面から遷移し、登録完了後は新しく作成された書類の詳細画面に自動遷移します。

Issue: [#033 [設計] #033 書類｜書類登録](https://github.com/ambi-tious/CareBase-staff/issues/77)

## 全体レイアウト

### 画面構成

<img width="1470" height="781" alt="スクリーンショット 2025-07-30 9 27 45" src="https://github.com/user-attachments/assets/13fdad75-ef3d-4745-a690-2cb3d3b3abc4" />
<img width="1470" height="689" alt="スクリーンショット 2025-07-30 9 29 17" src="https://github.com/user-attachments/assets/78c79e93-d9fa-4b5e-8bba-8aaf427cfb42" />

職員による書類情報入力のためのフォーム画面として以下の要素で構成：

- ページヘッダー（画面タイトル、説明文、戻るボタン）
- エラー表示エリア（入力エラー時に表示）
- 書類情報入力フォーム（2列レイアウト + GoogleDocs風コンテンツエリア）
- 添付ファイル管理エリア
- アクションボタン（下書き保存、キャンセル、登録）

### 画面項目

| 項目名           | コンポーネント | 必須 | 表示条件     | 初期値             | 備考                                           |
| ---------------- | -------------- | ---- | ------------ | ------------------ | ---------------------------------------------- |
| 戻るボタン       | Button         | -    | 常時         | 戻る               | アウトライン、ArrowLeft アイコン               |
| 画面タイトル     | Heading        | -    | 常時         | 新規書類登録       | FileText アイコン付き                          |
| 説明文           | Text           | -    | 常時         | 書類情報入力の説明 | 必須項目マークの説明含む                       |
| エラーアラート   | Alert          | -    | 送信エラー時 | -                  | 赤色背景、エラーメッセージ表示                 |
| タイトル         | FormField      | ◯    | 常時         | 空文字             | テキスト入力、プレースホルダー「月次定例会議」 |
| 内容             | RichTextEditor | ◯    | 常時         | 空文字             | GoogleDocs風リッチテキストエディタ             |
| 要約             | FormField      | -    | 常時         | 空文字             | テキストエリア、AI支援機能予定                 |
| 添付ファイル     | FileUpload     | -    | 常時         | 空                 | 画像・動画ファイル、複数選択可、50MB制限       |
| 下書き保存ボタン | Button         | -    | 常時         | 下書き保存         | グレースタイル、Save アイコン                  |
| キャンセルボタン | Button         | -    | 常時         | キャンセル         | アウトライン                                   |
| 登録ボタン       | Button         | -    | 常時         | 登録               | 青色スタイル、Send アイコン                    |

## 機能仕様

### 自動入力機能

| 項目名 | データソース                                | 取得方法                      | フォールバック処理           |
| ------ | ------------------------------------------- | ----------------------------- | ---------------------------- |
| 日時   | システム現在日時                            | `new Date()`                  | 手動入力可能                 |
| 参加者 | localStorage `carebase_selected_staff_data` | `staff.name` プロパティを取得 | 空文字のまま（手動入力可能） |

#### 自動入力の動作仕様

- **初期化タイミング**: コンポーネントマウント時
- **日時の初期設定**: 現在日時を ISO 8601 形式で設定
- **参加者の初期設定**: ログイン中の職員名を初期値として設定
- **更新検知**: 日時は手動変更可能、参加者は追記可能

### アクション

| 項目名           | 処理内容                         | 対象API                          | 遷移先画面                         |
| ---------------- | -------------------------------- | -------------------------------- | ---------------------------------- |
| 戻るボタン       | 書類一覧画面に戻る               | -                                | 書類一覧画面 (`/documents`)        |
| フォーム入力     | リアルタイムバリデーション実行   | -                                | 同一画面（エラー表示更新）         |
| 下書き保存ボタン | 下書きとして保存                 | `documentService.saveDraft`      | 同一画面（保存完了メッセージ表示） |
| キャンセルボタン | 入力内容を破棄して一覧に戻る     | -                                | 書類一覧画面 (`/documents`)        |
| 登録ボタン       | 書類情報を保存して詳細画面に遷移 | `documentService.createDocument` | 書類詳細画面 (`/documents/{id}`)   |

### 入力チェック

| 項目名       | イベント | チェック内容           | エラーメッセージ                        |
| ------------ | -------- | ---------------------- | --------------------------------------- |
| 添付ファイル | upload   | ファイルサイズチェック | ファイルサイズは50MB以下にしてください  |
| 添付ファイル | upload   | ファイル形式チェック   | 画像・動画ファイルを選択してください    |
| タイトル     | input    | 必須チェック           | タイトルは必須です                      |
| タイトル     | input    | 文字数チェック         | タイトルは100文字以内で入力してください |
| 内容         | input    | 必須チェック           | 内容は必須です                          |
| 内容         | input    | 文字数チェック         | 内容は10000文字以内で入力してください   |

### バリデーション仕様

#### リアルタイムバリデーション

- **入力時検証**: フォーム項目への入力と同時にバリデーションを実行
- **エラー表示**: 各項目下部に赤色でエラーメッセージを表示
- **送信制御**: バリデーションエラーがある場合は登録ボタンクリック時に送信を阻止

#### 文字列検証

- **必須項目**: 空文字、空白のみの入力を無効とする
- **文字数制限**: タイトル100文字、内容10000文字まで
- **日時形式**: ISO 8601形式での日時入力を要求

#### ファイル検証

- **ファイル形式**: 画像（JPEG, PNG, GIF, WebP）、動画（MP4, MOV, AVI）
- **ファイルサイズ**: 1ファイル最大50MB
- **ファイル数**: 最大10ファイルまで

#### エラーハンドリング

| エラー種別           | 発生条件                           | 表示メッセージ                                         | 表示場所           |
| -------------------- | ---------------------------------- | ------------------------------------------------------ | ------------------ |
| API通信エラー        | documentService.createDocument失敗 | 書類の登録に失敗しました。もう一度お試しください。     | 画面上部アラート   |
| 下書き保存エラー     | documentService.saveDraft失敗      | 下書きの保存に失敗しました。もう一度お試しください。   | 画面上部アラート   |
| バリデーションエラー | 必須項目未入力時の送信             | 入力内容に不備があります。必須項目を確認してください。 | 画面上部アラート   |
| ファイルサイズエラー | 50MB超過ファイルアップロード       | ファイルサイズは50MB以下にしてください                 | ブラウザアラート   |
| ファイル形式エラー   | 対応外ファイルアップロード         | 対応している形式のファイルを選択してください           | ブラウザアラート   |
| フィールド個別エラー | リアルタイムバリデーション         | 各項目固有のエラーメッセージ                           | 該当フィールド下部 |

#### リアルタイムバリデーション詳細

- **実行タイミング**: フォームデータ変更時（useEffect依存）
- **エラー状態管理**: `useDocumentForm` フックで一元管理
- **表示制御**: エラーがある場合のみ赤色でメッセージ表示

## UI/UX仕様

### レスポンシブデザイン

- **モバイル（〜768px）**:
  - フォーム項目を1列で縦並び表示
  - リッチテキストエディタをモバイル最適化
  - ボタンを全幅で縦積み配置
  - 余白を最小化してコンテンツエリアを最大化
- **タブレット（768px〜1024px）**:
  - 基本情報フォーム項目を2列グリッドで表示
  - リッチテキストエディタを全幅表示
  - ボタンを右寄せで横並び配置
- **デスクトップ（1024px〜）**:
  - フォーム全体の最大幅を8xlに制限
  - 2列グリッドレイアウトを維持
  - リッチテキストエディタを広々と表示
  - 余白を十分に確保

### カラーテーマ

- **背景色**: `bg-carebase-bg` - アプリケーション標準背景色
- **登録ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark` - メインアクション
- **下書き保存ボタン**: `bg-gray-500 hover:bg-gray-600` - セカンダリアクション
- **戻る・キャンセルボタン**: `border-gray-300 text-gray-700` - 中性アクション
- **エラーアラート**: `bg-red-50 border-red-200 text-red-700` - エラー状態
- **成功アラート**: `bg-green-50 border-green-200 text-green-700` - 成功状態
- **必須マーク**: `text-red-500` - 必須項目表示
- **セクション見出し**: `text-carebase-text-primary border-b` - セクション分割

### フォームUI仕様

- **入力フィールド間隔**: `gap-6` - 項目間の適切な間隔
- **セクション分割**: 基本情報・内容・添付ファイルを明確に分離
- **ラベル配置**: 各入力フィールドの上部に配置
- **プレースホルダー**: 入力例を示すサンプルテキスト
- **フォーカス状態**: 青色のアウトライン表示

### リッチテキストエディタ仕様

#### GoogleDocs風インターフェース

- **ツールバー構成**:
  - 基本書式: 太字、斜体、下線、取り消し線
  - リスト: 番号付きリスト、箇条書きリスト
  - インデント: インデント増加、インデント減少
  - 配置: 左寄せ、中央寄せ、右寄せ、均等割り付け
  - リンク: URLリンク挿入
  - 元に戻す・やり直し機能

- **エディタ機能**:
  - リアルタイム文字数カウント表示
  - マークダウン記法サポート
  - キーボードショートカット対応
  - 自動保存機能（下書き）
  - コピー&ペースト時の書式保持

#### エディタUI仕様

- **最小高さ**: `min-h-96` - 十分な編集領域確保
- **最大高さ**: `max-h-screen` - 画面いっぱいまで拡張可能
- **ボーダー**: `border-2 border-gray-200 focus:border-blue-500` - フォーカス表示
- **パディング**: `p-4` - 適切な内部余白
- **背景**: `bg-white` - 編集領域を明確に区別

### 添付ファイル管理仕様

#### ファイル制限

- **対応形式**:
  - 画像: `image/*` (JPEG, PNG, GIF, WebP等)
  - 動画: `video/*` (MP4, MOV, AVI等)
- **ファイルサイズ**: 1ファイル最大50MB
- **ファイル数**: 最大10ファイル
- **アップロード方式**: Base64エンコードまたはマルチパートアップロード

#### UI動作

- **未選択時**:
  - 点線ボーダーのドロップエリア表示
  - Uploadアイコンと「ファイルを選択またはドラッグ&ドロップ」テキスト
  - クリックでファイル選択ダイアログ表示
  - ドラッグ&ドロップ対応

- **選択後**:
  - ファイル一覧をカード形式で表示
  - 画像の場合はサムネイル表示（64x64px）
  - 動画の場合は動画アイコンとファイル名表示
  - 各ファイルに削除ボタン（Xアイコン）表示
  - プログレスバー表示（アップロード中）

#### エラーハンドリング

- **サイズ超過**: ブラウザアラートで即座通知
- **形式不正**: ブラウザアラートで即座通知
- **ファイル数超過**: 「最大10ファイルまでアップロード可能です」
- **読み込み失敗**: コンソールエラーログ出力

### 下書き機能仕様

#### 自動保存機能

- **保存タイミング**: 5秒間入力がない場合に自動実行
- **保存対象**: 全フォーム項目（添付ファイルを除く）
- **ストレージ**: ブラウザのlocalStorageを使用
- **キー命名**: `carebase_document_draft_{timestamp}`

#### 手動保存機能

- **保存ボタン**: 「下書き保存」ボタンクリック時
- **保存内容**: 全フォーム項目（添付ファイル含む）
- **API呼び出し**: `documentService.saveDraft`
- **成功通知**: 「下書きを保存しました」トースト表示

#### 下書き復元機能

- **復元タイミング**: ページ読み込み時に下書きが存在する場合
- **確認ダイアログ**: 「下書きを復元しますか？」選択肢表示
- **復元内容**: 保存済みの全フォーム項目を復元
- **クリア機能**: 下書きクリアボタンで削除可能

### アニメーション

- **ボタンホバー**: スムーズなカラートランジション
- **フォーム送信**: ローディング状態の表示（「登録中...」「保存中...」）
- **エラー表示**: フェードイン効果でアラート表示
- **バリデーション**: リアルタイムでエラーメッセージ表示・非表示
- **添付ファイル**: ドラッグ&ドロップ時のハイライト効果

### アクセシビリティ

- **キーボードナビゲーション**: Tabキーでの順次フォーカス移動
- **スクリーンリーダー**:
  - 適切なlabel要素の関連付け
  - 必須項目のaria-required属性
  - エラーメッセージのaria-describedby属性
  - ランドマークrole属性の適切な配置
- **コントラスト比**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスリング表示
- **リッチテキストエディタ**: キーボード操作完全対応

### ローディング・無効化状態

#### 送信中状態（isSubmitting: true）

- **フォーム全体**: `disabled={isSubmitting}` で全入力フィールドを無効化
- **戻るボタン**: クリック無効化で誤操作防止
- **キャンセルボタン**: クリック無効化で誤操作防止
- **登録ボタン**:
  - テキスト変更: 「登録」→「登録中...」
  - クリック無効化: `disabled={isSubmitting}`
  - ローディング表示: スピナーアイコン表示
- **下書き保存ボタン**: クリック無効化で重複保存防止

#### 下書き保存中状態（isSavingDraft: true）

- **下書き保存ボタン**:
  - テキスト変更: 「下書き保存」→「保存中...」
  - クリック無効化: `disabled={isSavingDraft}`
  - ローディング表示: スピナーアイコン表示

#### バリデーションエラー時の表示

- **該当フィールド**: 赤色ボーダー表示
- **エラーメッセージ**: フィールド下部に即座表示
- **送信制御**: エラーがある場合は送信処理を中断
- **リッチテキストエディタ**: エラー時は赤色ボーダー表示

## 技術仕様

### 使用コンポーネント

- **フォームフレームワーク**: React Hook Form + Zod
- **リッチテキストエディタ**: TipTap または Draft.js
- **ファイルアップロード**: React Dropzone
- **日時ピッカー**: React DatePicker
- **通知**: Sonner Toast
- **バリデーション**: Zod Schema

### データ構造

```typescript
interface DocumentForm {
  datetime: string; // ISO 8601
  category: 'meeting' | 'discussion' | 'training' | 'other';
  venue: string;
  participants: string;
  title: string;
  content: string; // HTML形式
  summary?: string;
  futureActions?: string;
  remarks?: string;
  attachments: File[];
}

interface DocumentDraft {
  id: string;
  formData: Partial<DocumentForm>;
  createdAt: string;
  updatedAt: string;
}
```

### API仕様

```typescript
// 書類作成
documentService.createDocument(data: DocumentForm): Promise<Document>

// 下書き保存
documentService.saveDraft(data: Partial<DocumentForm>): Promise<DocumentDraft>

// 下書き取得
documentService.getDrafts(): Promise<DocumentDraft[]>

// 下書き削除
documentService.deleteDraft(id: string): Promise<void>
```

## 参考資料

- [Issue #77: [設計] #033 書類｜書類登録](https://github.com/ambi-tious/CareBase-staff/issues/77)
- [FlutterFlow書類登録画面参考資料](https://github.com/user-attachments/assets/3a44da98-1032-47ad-a8cf-3fe4c6cac27d)
- [書類登録画面実装](./page.tsx)
- [DocumentForm コンポーネント](../../../../components/2_molecules/forms/document-form.tsx)
- [useDocumentForm カスタムフック](../../../../hooks/useDocumentForm.ts) - フォーム状態管理、バリデーション、送信処理
- [documentService](../../../../services/documentService.ts) - 書類作成API、下書き管理
- [書類一覧画面設計書](../README.md)
- [書類詳細画面設計書](../[documentId]/README.md)
- [書類登録画面テスト](<../../../../__tests__/app/(main)/documents/new/new-document-page.test.tsx>)
- [DocumentForm テスト](../../../../__tests__/components/2_molecules/forms/document-form.test.tsx)
- [画面一覧](../../../../docs/screen-list.md#書類管理)
