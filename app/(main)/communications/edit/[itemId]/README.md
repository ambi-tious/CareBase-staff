# 連絡・予定｜連絡編集画面設計書

**画面名**: 連絡予定編集画面  
**パス**: `/communications/edit/[itemId]`  
**URL**: `https://carebase.example.com/communications/edit/{itemId}`

## 概要

既存の連絡予定情報を編集する画面です。登録画面と同様のフォーム構成を持ち、既存データの読み込み、更新処理、エラーハンドリングを提供します。連絡詳細画面からのアクセスとコメント機能も含み、スタッフ間の継続的な情報共有を支援します。

### 主要機能
- 既存連絡予定データの読み込み・表示
- 登録画面と同様の編集フォーム
- カテゴリ・通知対象の変更
- 更新履歴の表示
- コメント機能
- 下書き保存・更新処理
- 削除機能（権限チェック付き）

## 全体レイアウト

### 画面構成

```
┌─────────────────────────────────────────────────────────────┐
│ ヘッダー（共通）                                              │
├─────────────────────────────────────────────────────────────┤
│ パンくずリスト                                               │
│ 連絡・予定 > カレンダー > 連絡編集                           │
├─────────────────────────────────────────────────────────────┤
│ 編集フォームエリア                                           │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 基本情報                                                │ │
│ │ ┌─────────────┐ ┌─────────────┐                      │ │
│ │ │ 件名        │ │ カテゴリ    │                      │ │
│ │ └─────────────┘ └─────────────┘                      │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ 内容                                                │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 日時・対象設定                                          │ │
│ │ ┌─────────────┐ ┌─────────────┐                      │ │
│ │ │ 開始日時    │ │ 終了日時    │                      │ │
│ │ └─────────────┘ └─────────────┘                      │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ 対象利用者選択                                      │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ 通知対象スタッフ選択                                │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 更新履歴・コメント                                      │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ 更新履歴                                            │ │ │
│ │ │ 2024/01/15 10:30 田中花子 - 件名変更                │ │ │
│ │ │ 2024/01/14 15:20 佐藤太郎 - 通知対象追加            │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ コメント                                            │ │ │
│ │ │ [新規コメント入力エリア]                            │ │ │
│ │ │ [既存コメント一覧]                                  │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ アクションボタン                                             │
│ [削除] [キャンセル] [下書き保存] [更新]                      │
└─────────────────────────────────────────────────────────────┘
```

### 画面項目

| 項目名 | 種別 | 必須 | 説明 |
|--------|------|------|------|
| 件名 | テキスト | ○ | 連絡予定の件名（100文字以内） |
| カテゴリ | セレクト | ○ | インフォメーション/イベント/タスク/その他 |
| 内容 | テキストエリア | ○ | 連絡予定の詳細内容（1000文字以内） |
| 開始日時 | 日時 | ○ | 予定開始日時 |
| 終了日時 | 日時 | - | 予定終了日時（開始日時より後） |
| 対象利用者 | マルチセレクト | - | 関連する利用者の選択 |
| 通知対象スタッフ | マルチセレクト | ○ | 通知を送信するスタッフ |
| 更新履歴 | 表示エリア | - | 変更履歴の時系列表示 |
| コメント入力 | テキストエリア | - | 新規コメント入力（500文字以内） |
| コメント一覧 | 表示エリア | - | 既存コメントの表示 |

## 機能仕様

### アクション

#### 1. データ読み込み
- **トリガー**: 画面初期表示
- **処理内容**:
  1. URLパラメータからitemId取得
  2. 連絡予定データ取得
  3. フォームに既存データ設定
  4. 更新履歴・コメント取得
- **API呼び出し**: 
  - `GET /api/communications/{itemId}`
  - `GET /api/communications/{itemId}/history`
  - `GET /api/communications/{itemId}/comments`

#### 2. データ更新
- **トリガー**: 更新ボタンクリック
- **処理内容**:
  1. 全項目バリデーション実行
  2. 変更差分の検出
  3. 更新データ送信
  4. 更新履歴記録
  5. 通知対象への変更通知送信
- **API呼び出し**: `PUT /api/communications/{itemId}`

#### 3. 下書き保存
- **トリガー**: 下書き保存ボタンクリック
- **処理内容**:
  1. 現在の入力状態を保存
  2. バリデーション（必須項目以外）
  3. 下書き状態フラグ更新
  4. 保存成功メッセージ表示
- **API呼び出し**: `PUT /api/communications/{itemId}/draft`

#### 4. コメント追加
- **トリガー**: コメント投稿ボタンクリック
- **処理内容**:
  1. コメント内容バリデーション
  2. コメントデータ作成
  3. コメント一覧更新
  4. 関係者への通知送信
- **API呼び出し**: `POST /api/communications/{itemId}/comments`

#### 5. 削除処理
- **トリガー**: 削除ボタンクリック
- **処理内容**:
  1. 削除権限チェック
  2. 削除確認ダイアログ表示
  3. 関連データの削除影響確認
  4. 論理削除実行
  5. カレンダー画面へ遷移
- **API呼び出し**: `DELETE /api/communications/{itemId}`

#### 6. キャンセル
- **トリガー**: キャンセルボタンクリック
- **処理内容**:
  1. 未保存変更確認ダイアログ表示
  2. 確認後前画面へ遷移
  3. 下書きデータの保持確認

### 入力チェック

#### 基本項目（新規登録と同様）
- **件名**: 必須、1-100文字
- **内容**: 必須、1-1000文字
- **開始日時**: 必須、有効な日時形式
- **通知対象**: 最低1名選択必須

#### コメント
- **文字数チェック**: 1-500文字
- **文字種チェック**: 全角・半角文字、数字、記号
- **改行処理**: 改行文字の適切な処理

### バリデーション仕様

#### 更新時バリデーション
- **変更検出**: 既存データとの差分チェック
- **権限チェック**: 編集権限の確認
- **競合チェック**: 他ユーザーによる同時編集検出

#### エラーハンドリング
- **ネットワークエラー**: リトライ機能提供
- **権限エラー**: 適切なエラーメッセージ表示
- **データ競合**: 最新データ再読み込み提案

## UI/UX仕様

### レスポンシブデザイン

#### デスクトップ（1024px以上）
- フォーム: 2カラムレイアウト
- 履歴・コメント: サイドパネル表示
- モーダル: 中央表示（最大幅800px）

#### タブレット（768px-1023px）
- フォーム: 1カラムレイアウト
- 履歴・コメント: タブ切り替え表示
- モーダル: 画面幅90%

#### モバイル（767px以下）
- フォーム: 縦スクロール1カラム
- 履歴・コメント: アコーディオン表示
- モーダル: フルスクリーン表示

### カラーテーマ

#### 編集状態表示
- **変更あり**: `border-yellow-300 bg-yellow-50`
- **保存済み**: `border-green-300 bg-green-50`
- **エラー**: `border-red-300 bg-red-50`

#### 履歴・コメント
- **更新履歴**: `bg-blue-50 border-blue-200`
- **コメント**: `bg-gray-50 border-gray-200`
- **自分のコメント**: `bg-blue-100 border-blue-300`

### アニメーション

#### データ読み込み
- **ローディング**: `animate-pulse` スケルトン表示
- **データ表示**: `animate-fade-in` フェードイン効果

#### 更新処理
- **保存中**: `animate-spin` ローディングアイコン
- **保存完了**: `animate-bounce` 一時的な強調

### アクセシビリティ

#### キーボード操作
- **Tab**: フィールド間移動
- **Ctrl+S**: 下書き保存
- **Ctrl+Enter**: 更新実行
- **Escape**: モーダル・ダイアログ閉じる

#### スクリーンリーダー対応
- **aria-label**: 各フィールドに説明追加
- **aria-describedby**: エラーメッセージとの関連付け
- **live-region**: 動的コンテンツの変更通知

#### 権限表示
- **読み取り専用**: フィールドの無効化と説明
- **編集権限なし**: 適切な権限エラーメッセージ

## 参考資料

### 関連設計書
- [カレンダー表示画面設計書](../../calendar/README.md)
- [連絡登録画面設計書](../../new/README.md)
- [申し送り編集画面設計書](../../../handovers/edit/[handoverId]/README.md)

### 参考コンポーネント
- [Handover Form Component](../../../../../components/2_molecules/handover/handover-form.tsx)
- [Contact Form Component](../../../../../components/2_molecules/forms/contact-form.tsx)
- [Contact Edit Modal](../../../../../components/3_organisms/modals/contact-edit-modal.tsx)

### FlutterFlow参考資料
- [連絡編集画面](https://github.com/ambi-tious/CareBase-staff/issues/99)
- 連絡詳細画面とコメント機能
- 既存データ読み込み・更新処理
- エラーハンドリング機能

### API仕様
- `GET /api/communications/{itemId}` - 連絡予定詳細取得
- `PUT /api/communications/{itemId}` - 連絡予定更新
- `PUT /api/communications/{itemId}/draft` - 下書き保存
- `DELETE /api/communications/{itemId}` - 連絡予定削除
- `GET /api/communications/{itemId}/history` - 更新履歴取得
- `GET /api/communications/{itemId}/comments` - コメント一覧取得
- `POST /api/communications/{itemId}/comments` - コメント追加

### 既存パターン参考
- [Handover Types](../../../../../types/handover.ts) - データ型定義パターン
- [Contact Service](../../../../../services/contactService.ts) - API通信パターン
- [Contact Info Card](../../../../../components/2_molecules/resident/contact-info-card.tsx) - 表示コンポーネントパターン

### 権限・セキュリティ
- 作成者・管理者のみ編集可能
- 削除は管理者権限必須
- 他ユーザーによる同時編集の競合検出
- 変更履歴の完全記録
