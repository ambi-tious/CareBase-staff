# 連絡・予定｜連絡登録画面設計書

**画面名**: 連絡予定登録画面  
**パス**: `/communications/new`  
**URL**: `https://carebase.example.com/communications/new`

## 概要

利用者選択から連絡予定の作成を行う画面です。Google Calendar風のフォームデザインを採用し、カテゴリ管理、通知対象選択、下書き・確認必須機能を提供します。スタッフ間の連絡・予定管理を効率化し、情報共有の質を向上させます。

### 主要機能
- 利用者選択による連絡予定作成
- カテゴリ管理（インフォメーション、イベント、タスク、その他）
- カテゴリの作成・削除・編集・並び替え
- Google Calendar風フォームデザイン
- 通知対象選択機能
- 下書き保存・確認必須機能
- バリデーション・エラーハンドリング

## 全体レイアウト

### 画面構成

```
┌─────────────────────────────────────────────────────────────┐
│ ヘッダー（共通）                                              │
├─────────────────────────────────────────────────────────────┤
│ パンくずリスト                                               │
│ 連絡・予定 > 新規登録                                        │
├─────────────────────────────────────────────────────────────┤
│ フォームエリア                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 基本情報                                                │ │
│ │ ┌─────────────┐ ┌─────────────┐                      │ │
│ │ │ 件名        │ │ カテゴリ    │                      │ │
│ │ └─────────────┘ └─────────────┘                      │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ 内容                                                │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 日時・対象設定                                          │ │
│ │ ┌─────────────┐ ┌─────────────┐                      │ │
│ │ │ 開始日時    │ │ 終了日時    │                      │ │
│ │ └─────────────┘ └─────────────┘                      │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ 対象利用者選択                                      │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ │ ┌─────────────────────────────────────────────────────┐ │ │
│ │ │ 通知対象スタッフ選択                                │ │ │
│ │ └─────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ オプション設定                                          │ │
│ │ □ 確認必須  □ 下書き保存                               │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ アクションボタン                                             │
│ [キャンセル] [下書き保存] [登録]                             │
└─────────────────────────────────────────────────────────────┘
```

### 画面項目

| 項目名 | 種別 | 必須 | 説明 |
|--------|------|------|------|
| 件名 | テキスト | ○ | 連絡予定の件名（100文字以内） |
| カテゴリ | セレクト | ○ | インフォメーション/イベント/タスク/その他 |
| 内容 | テキストエリア | ○ | 連絡予定の詳細内容（1000文字以内） |
| 開始日時 | 日時 | ○ | 予定開始日時 |
| 終了日時 | 日時 | - | 予定終了日時（開始日時より後） |
| 対象利用者 | マルチセレクト | - | 関連する利用者の選択 |
| 通知対象スタッフ | マルチセレクト | ○ | 通知を送信するスタッフ |
| 確認必須フラグ | チェックボックス | - | 確認必須設定 |
| 下書きフラグ | チェックボックス | - | 下書き保存設定 |

## 機能仕様

### アクション

#### 1. カテゴリ管理
- **トリガー**: カテゴリドロップダウン操作
- **処理内容**:
  1. カテゴリ一覧表示
  2. 新規カテゴリ作成モーダル表示
  3. 既存カテゴリ編集・削除
  4. カテゴリ並び替え機能
- **API呼び出し**: 
  - `GET /api/communication-categories`
  - `POST /api/communication-categories`
  - `PUT /api/communication-categories/{id}`
  - `DELETE /api/communication-categories/{id}`

#### 2. 利用者選択
- **トリガー**: 対象利用者フィールドクリック
- **処理内容**:
  1. 利用者一覧モーダル表示
  2. 検索・フィルタリング機能
  3. 複数選択対応
  4. 選択状態の保存
- **API呼び出し**: `GET /api/residents?active=true`

#### 3. スタッフ選択
- **トリガー**: 通知対象スタッフフィールドクリック
- **処理内容**:
  1. スタッフ一覧モーダル表示
  2. 部署・役職別フィルタリング
  3. 複数選択対応
  4. 必須選択チェック
- **API呼び出し**: `GET /api/staff?active=true`

#### 4. 下書き保存
- **トリガー**: 下書き保存ボタンクリック
- **処理内容**:
  1. 入力データの一時保存
  2. バリデーション（必須項目以外）
  3. 保存成功メッセージ表示
  4. 編集継続可能状態維持
- **API呼び出し**: `POST /api/communications/draft`

#### 5. 連絡予定登録
- **トリガー**: 登録ボタンクリック
- **処理内容**:
  1. 全項目バリデーション実行
  2. 連絡予定データ作成
  3. 通知対象への通知送信
  4. 登録完了後カレンダー画面へ遷移
- **API呼び出し**: `POST /api/communications`

#### 6. キャンセル
- **トリガー**: キャンセルボタンクリック
- **処理内容**:
  1. 未保存変更確認ダイアログ表示
  2. 確認後カレンダー画面へ遷移
  3. 下書きデータの保持確認

### 入力チェック

#### 件名
- **必須チェック**: 空文字不可
- **文字数チェック**: 1-100文字
- **文字種チェック**: 全角・半角文字、数字、記号

#### 内容
- **必須チェック**: 空文字不可
- **文字数チェック**: 1-1000文字
- **改行処理**: 改行文字の適切な処理

#### 日時
- **必須チェック**: 開始日時は必須
- **形式チェック**: YYYY-MM-DD HH:mm形式
- **論理チェック**: 終了日時 > 開始日時
- **範囲チェック**: 過去日時は警告表示

#### 通知対象
- **必須チェック**: 最低1名選択必須
- **上限チェック**: 最大50名まで選択可能

### バリデーション仕様

#### リアルタイムバリデーション
- **件名**: 入力時文字数カウント表示
- **内容**: 入力時文字数カウント表示
- **日時**: 入力時形式チェック・論理チェック

#### サブミット時バリデーション
- **全項目**: 必須チェック・形式チェック実行
- **エラー表示**: フィールド単位でエラーメッセージ表示
- **フォーカス**: 最初のエラーフィールドにフォーカス移動

## UI/UX仕様

### レスポンシブデザイン

#### デスクトップ（1024px以上）
- フォーム: 2カラムレイアウト
- モーダル: 中央表示（最大幅800px）
- 日時選択: インラインカレンダー表示

#### タブレット（768px-1023px）
- フォーム: 1カラムレイアウト
- モーダル: 画面幅90%
- 日時選択: ポップアップカレンダー

#### モバイル（767px以下）
- フォーム: 縦スクロール1カラム
- モーダル: フルスクリーン表示
- 日時選択: ネイティブピッカー使用

### カラーテーマ

#### カテゴリ別色分け
- **インフォメーション**: `bg-blue-100 text-blue-700 border-blue-200`
- **イベント**: `bg-purple-100 text-purple-700 border-purple-200`
- **タスク**: `bg-orange-100 text-orange-700 border-orange-200`
- **その他**: `bg-gray-100 text-gray-700 border-gray-200`

#### 状態別色分け
- **必須フィールド**: `border-red-300 focus:border-red-500`
- **エラー状態**: `border-red-500 bg-red-50`
- **成功状態**: `border-green-500 bg-green-50`

### アニメーション

#### フォーム操作
- **フィールドフォーカス**: `transition-colors duration-200`
- **エラー表示**: `animate-shake` (軽微な振動効果)
- **保存成功**: `animate-pulse` (一時的な強調)

#### モーダル表示
- **開閉**: `transition-opacity duration-300`
- **背景**: `backdrop-blur-sm`

### アクセシビリティ

#### キーボード操作
- **Tab**: フィールド間移動
- **Enter**: 次フィールドまたはサブミット
- **Escape**: モーダル閉じる
- **Space**: チェックボックス切り替え

#### スクリーンリーダー対応
- **aria-label**: 各フィールドに説明追加
- **aria-required**: 必須フィールドマーク
- **aria-invalid**: エラー状態表示
- **role**: 適切なロール設定

#### エラーハンドリング
- **エラーメッセージ**: 具体的で理解しやすい内容
- **エラー位置**: 該当フィールド近くに表示
- **エラー音**: スクリーンリーダー用音声フィードバック

## 参考資料

### 関連設計書
- [カレンダー表示画面設計書](../calendar/README.md)
- [連絡編集画面設計書](../edit/[itemId]/README.md)
- [申し送り登録画面設計書](../../handovers/new/README.md)

### 参考コンポーネント
- [Handover Form Component](../../../../components/2_molecules/handover/handover-form.tsx)
- [Contact Form Component](../../../../components/2_molecules/forms/contact-form.tsx)
- [Calendar UI Component](../../../../components/ui/calendar.tsx)

### FlutterFlow参考資料
- [連絡登録画面](https://github.com/ambi-tious/CareBase-staff/issues/101)
- Google Calendar風フォームデザイン
- カテゴリ管理機能
- 通知対象選択機能

### API仕様
- `POST /api/communications` - 連絡予定作成
- `POST /api/communications/draft` - 下書き保存
- `GET /api/communication-categories` - カテゴリ一覧取得
- `POST /api/communication-categories` - カテゴリ作成
- `GET /api/residents?active=true` - 利用者一覧取得
- `GET /api/staff?active=true` - スタッフ一覧取得

### 既存パターン参考
- [Handover Types](../../../../types/handover.ts) - フォームスキーマパターン
- [Contact Service](../../../../services/contactService.ts) - API通信パターン
- [Dashboard Menu](../../../../mocks/dashboard-menu.ts) - ナビゲーションパターン
