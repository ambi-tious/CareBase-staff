# 介護記録編集画面設計書

画面名: `介護記録編集`  
パス: `/care-records/[recordId]/edit`  
URL: https://carebase-staff.vercel.app/care-records/[recordId]/edit

## 概要

CareBase-staffアプリケーションの介護記録編集画面設計書です。  
既存の介護記録の内容を編集・更新する機能を提供し、介護現場での記録修正や追記を効率的に行えます。  
下書き保存機能、テンプレート文章機能、画像・動画添付機能、職員通知選択機能により、作業の中断・再開が可能で、削除機能も含む包括的な編集機能を提供します。

## 全体レイアウト

### 画面構成

介護記録編集のメイン画面として以下の要素で構成：

- ページヘッダー（画面タイトル、説明文、戻るボタン、削除ボタン）
- 成功・エラーメッセージ表示エリア
- 担当職員情報表示
- 対象利用者情報表示（選択時）
- お知らせ職員選択機能
- 介護記録編集フォーム（2列レイアウト）
- テンプレート文章機能
- 画像・動画添付機能
- アクションボタン（キャンセル、下書き保存、更新）
- 削除確認モーダル

### 画面項目

| 項目名           | コンポーネント | 必須 | 表示条件     | 初期値             | 備考                                                   |
| ---------------- | -------------- | ---- | ------------ | ------------------ | ------------------------------------------------------ |
| 戻るボタン       | Button         | -    | 常時         | 戻る               | アウトライン、ArrowLeft アイコン                       |
| 画面タイトル     | Heading        | -    | 常時         | 介護記録編集       | Edit3 アイコン付き                                     |
| 削除ボタン       | Button         | -    | 常時         | 削除               | 赤色アウトライン、Trash2 アイコン                      |
| 説明文           | Text           | -    | 常時         | 編集説明           | 必須項目マークの説明含む                               |
| 成功メッセージ   | Alert          | -    | 更新成功時   | -                  | 緑色背景、CheckCircle アイコン                         |
| エラーアラート   | Alert          | -    | 更新エラー時 | -                  | 赤色背景、エラーメッセージ表示                         |
| 担当職員表示     | InfoDisplay    | -    | 常時         | ログインユーザー名 | 青色背景、User アイコン付き                            |
| 対象利用者選択   | FormSelect     | ◯    | 常時         | 既存データ         | 利用者一覧から選択                                     |
| 利用者情報表示   | InfoDisplay    | -    | 選択時       | 利用者詳細情報     | 緑色背景、年齢・性別・介護度・部屋情報表示             |
| お知らせ職員選択 | MultiSelect    | -    | 常時         | -                  | 複数職員選択可能、通知対象職員設定                     |
| 職員情報表示     | InfoDisplay    | -    | 職員選択時   | 職員一覧           | 青色背景、選択された職員リスト表示                     |
| 記録種別選択     | FormSelect     | ◯    | 常時         | 既存データ         | 食事/入浴/服薬/排泄/バイタル/運動/コミュニケーション等 |
| タイトル入力     | FormField      | ◯    | 常時         | 既存データ         | テキスト入力、プレースホルダー「朝食摂取記録」         |
| 記録日時入力     | FormField      | ◯    | 常時         | 既存データ         | datetime-local形式                                     |
| 重要度選択       | FormSelect     | ◯    | 常時         | 既存データ         | 高/中/低                                               |
| ステータス選択   | FormSelect     | ◯    | 常時         | 既存データ         | 下書き/完了/確認済み                                   |
| 記録内容入力     | Textarea       | ◯    | 常時         | 既存データ         | 大きなテキストエリア、1000文字制限                     |
| テンプレート選択 | FormSelect     | -    | 常時         | -                  | 定型文テンプレート選択、カテゴリ別テンプレート         |
| テンプレート挿入 | Button         | -    | テンプレート選択時 | テンプレート適用 | アウトライン、FileText アイコン                        |
| 画像添付         | FileInput      | -    | 常時         | -                  | 画像ファイル選択、プレビュー表示、複数選択可能         |
| 動画添付         | FileInput      | -    | 常時         | -                  | 動画ファイル選択、プレビュー表示、複数選択可能         |
| 添付ファイル一覧 | FileList       | -    | ファイル選択時 | 添付ファイル一覧   | 添付済みファイルの一覧表示、削除機能付き               |
| 記録ガイドライン | InfoDisplay    | -    | 常時         | ガイドライン表示   | グレー背景、記録作成のヒント                           |
| 未保存変更警告   | Alert          | -    | 変更あり時   | -                  | 黄色背景、AlertCircle アイコン                         |
| キャンセルボタン | Button         | -    | 常時         | キャンセル         | アウトライン                                           |
| 下書き保存ボタン | Button         | -    | 常時         | 下書き保存         | アウトライン、Save アイコン                            |
| 更新ボタン       | Button         | -    | 常時         | 記録を更新         | 青色スタイル、Send アイコン                            |
| 削除確認モーダル | Modal          | -    | 削除時       | -                  | 削除確認ダイアログ                                     |

## 機能仕様

### アクション

| 項目名           | 処理内容                       | 対象API                              | 遷移先画面                              |
| ---------------- | ------------------------------ | ------------------------------------ | --------------------------------------- |
| 戻るボタン       | 介護記録詳細画面に戻る         | -                                    | 介護記録詳細画面 (`/care-records/{id}`) |
| フォーム入力     | リアルタイムバリデーション実行 | -                                    | 同一画面（エラー表示更新）              |
| お知らせ職員選択 | 通知対象職員の選択・解除       | -                                    | 同一画面（職員情報表示更新）            |
| テンプレート選択 | カテゴリ別テンプレート一覧表示 | `templateService.getTemplates`       | 同一画面（テンプレート選択肢表示）      |
| テンプレート適用 | 選択テンプレートを記録内容に挿入 | -                                    | 同一画面（記録内容更新）                |
| 画像添付         | 画像ファイルの選択・アップロード | `fileService.uploadFile`             | 同一画面（添付ファイル一覧更新）        |
| 動画添付         | 動画ファイルの選択・アップロード | `fileService.uploadFile`             | 同一画面（添付ファイル一覧更新）        |
| 添付ファイル削除 | 添付ファイルの削除             | `fileService.deleteFile`             | 同一画面（添付ファイル一覧更新）        |
| 下書き保存       | 入力内容を下書きとして保存     | `careRecordService.updateCareRecord` | 同一画面（成功メッセージ表示）          |
| 更新ボタン       | 介護記録を確定して更新         | `careRecordService.updateCareRecord` | 介護記録詳細画面 (`/care-records/{id}`) |
| 削除ボタン       | 削除確認モーダルを表示         | -                                    | 同一画面（モーダル表示）                |
| 削除確認         | 介護記録を削除                 | `careRecordService.deleteCareRecord` | 介護記録一覧画面 (`/care-records`)      |
| キャンセルボタン | 入力内容を破棄して詳細に戻る   | -                                    | 介護記録詳細画面 (`/care-records/{id}`) |

### 入力チェック

| 項目名         | イベント | チェック内容                   | エラーメッセージ                         |
| -------------- | -------- | ------------------------------ | ---------------------------------------- |
| 利用者選択     | change   | 必須選択チェック               | 利用者を選択してください                 |
| 記録種別選択   | change   | 必須選択チェック               | 記録種別を選択してください               |
| タイトル入力   | blur     | 必須チェック                   | タイトルは必須です                       |
| タイトル入力   | blur     | 文字数チェック（100文字以内）  | タイトルは100文字以内で入力してください  |
| 記録日時入力   | change   | 必須チェック                   | 記録日時は必須です                       |
| 記録日時入力   | change   | 日時形式チェック               | 有効な日時を入力してください             |
| 重要度選択     | change   | 必須選択チェック               | 重要度を選択してください                 |
| ステータス選択 | change   | 必須選択チェック               | ステータスを選択してください             |
| 記録内容入力   | blur     | 必須チェック                   | 記録内容は必須です                       |
| 記録内容入力   | input    | 文字数チェック（1000文字以内） | 記録内容は1000文字以内で入力してください |
| 画像添付       | change   | ファイル形式チェック           | JPEG、PNG、GIF形式のみ対応しています     |
| 画像添付       | change   | ファイルサイズチェック（5MB）  | 画像ファイルは5MB以下にしてください      |
| 動画添付       | change   | ファイル形式チェック           | MP4、MOV、AVI形式のみ対応しています      |
| 動画添付       | change   | ファイルサイズチェック（50MB） | 動画ファイルは50MB以下にしてください     |
| 添付ファイル   | change   | 総数制限チェック（10ファイル） | 添付ファイルは10個まで選択できます       |
| フォーム送信   | submit   | 全必須項目チェック             | 必須項目をすべて入力してください         |

### バリデーション仕様

#### リアルタイムバリデーション

- **入力時検証**: フォーム項目への入力と同時にバリデーションを実行
- **エラー表示**: 各項目下部に赤色でエラーメッセージを表示
- **送信制御**: バリデーションエラーがある場合は送信ボタンクリック時に送信を阻止

#### 文字数制限

- **タイトル**: 100文字以内
- **記録内容**: 1000文字以内、リアルタイム文字数表示
- **文字数表示**: 入力中の文字数を「xxx/1000文字」形式で表示

#### 下書き保存仕様

- **バリデーション**: 下書き保存時は必須項目チェックを緩和
- **自動保存**: 一定時間ごとの自動下書き保存（将来実装予定）
- **復元機能**: 下書きからの復元機能（将来実装予定）

#### テンプレート機能仕様

- **カテゴリ別テンプレート**: 記録種別に応じたテンプレート文章を表示
- **テンプレート管理**: 管理者による定型文テンプレートの作成・編集機能
- **挿入方式**: 選択したテンプレートを記録内容フィールドに挿入
- **編集可能**: 挿入後のテンプレート文章は編集可能

#### 添付ファイル機能仕様

- **対応形式**:
  - 画像: JPEG、PNG、GIF
  - 動画: MP4、MOV、AVI
- **ファイルサイズ制限**:
  - 画像: 5MB以下
  - 動画: 50MB以下
- **総数制限**: 10ファイルまで同時添付可能
- **プレビュー機能**: 添付前にファイル内容を確認可能
- **削除機能**: 個別ファイルの削除が可能

#### 職員通知機能仕様

- **複数選択**: チェックボックスによる複数職員選択
- **通知範囲**: 同じグループ・チーム内の職員のみ選択可能
- **通知タイミング**: 記録保存時に選択職員へ通知送信
- **通知内容**: 記録タイトル、作成者、記録日時を含む通知

#### エラーハンドリング

- **API通信エラー**: 「ネットワークエラーが発生しました。接続を確認してもう一度お試しください。」
- **バリデーションエラー**: 「入力内容に不備があります。必須項目を確認してください。」
- **更新エラー**: 「介護記録の更新に失敗しました。もう一度お試しください。」
- **削除エラー**: 「介護記録の削除に失敗しました。もう一度お試しください。」
- **下書き保存エラー**: 「下書き保存に失敗しました。もう一度お試しください。」
- **ファイルアップロードエラー**: 「ファイルのアップロードに失敗しました。ファイル形式とサイズを確認してください。」
- **テンプレート読み込みエラー**: 「テンプレートの読み込みに失敗しました。もう一度お試しください。」
- **職員情報取得エラー**: 「職員情報の取得に失敗しました。もう一度お試しください。」

## UI/UX仕様

### レスポンシブデザイン

- **モバイル（〜768px）**:
  - フォーム項目を1列で縦並び表示
  - ボタンを全幅で縦積み配置
  - 余白を最小化してコンテンツエリアを最大化
- **タブレット（768px〜1024px）**:
  - フォーム項目を2列グリッドで表示
  - ボタンを右寄せで横並び配置
- **デスクトップ（1024px〜）**:
  - フォーム全体の最大幅を6xlに制限
  - 2列グリッドレイアウトを維持
  - 余白を十分に確保

### カラーテーマ

- **背景色**: `bg-carebase-bg` - アプリケーション標準背景色
- **更新ボタン**: `bg-carebase-blue hover:bg-carebase-blue-dark` - メインアクション
- **下書き保存ボタン**: `border-gray-400 text-gray-700 hover:bg-gray-50` - セカンダリアクション
- **削除ボタン**: `border-red-300 text-red-600 hover:bg-red-50` - 危険なアクション
- **戻る・キャンセルボタン**: `border-gray-300 text-gray-700` - セカンダリアクション
- **成功アラート**: `bg-green-50 border-green-200 text-green-700` - 成功状態
- **エラーアラート**: `bg-red-50 border-red-200 text-red-700` - エラー状態
- **警告アラート**: `bg-yellow-50 border-yellow-200 text-yellow-800` - 警告状態
- **担当職員表示**: `bg-blue-50 border-blue-200 text-blue-800` - 情報表示
- **利用者情報表示**: `bg-green-50 border-green-200 text-green-800` - 情報表示

### フォームUI仕様

- **入力フィールド間隔**: `gap-6` - 項目間の適切な間隔
- **セクション分割**: 基本情報、通知設定、記録内容、添付ファイルを明確に分離
- **ラベル配置**: 各入力フィールドの上部に配置
- **プレースホルダー**: 入力例を示すサンプルテキスト
- **フォーカス状態**: 青色のアウトライン表示
- **文字数カウンター**: 記録内容の下部に表示
- **テンプレート選択UI**: ドロップダウンメニューでカテゴリ別テンプレート表示
- **添付ファイルUI**: ドラッグ&ドロップ対応のファイル選択エリア
- **職員選択UI**: チェックボックス付きの職員一覧表示

### アニメーション

- **ボタンホバー**: スムーズなカラートランジション
- **フォーム送信**: ローディング状態の表示（「更新中...」「保存中...」）
- **アラート表示**: フェードイン効果でアラート表示
- **バリデーション**: リアルタイムでエラーメッセージ表示・非表示
- **モーダル表示**: フェードイン・スケールアニメーション
- **ファイル添付**: ドラッグオーバー時のハイライト効果
- **テンプレート適用**: 内容挿入時のスムーズなテキスト更新
- **職員選択**: チェックボックス選択時のスムーズな状態変更

### アクセシビリティ

- **キーボードナビゲーション**: Tabキーでの順次フォーカス移動
- **スクリーンリーダー**:
  - 適切なlabel要素の関連付け
  - 必須項目のaria-required属性
  - エラーメッセージのaria-describedby属性
- **コントラスト比**: WCAG 2.1 AA レベル準拠
- **フォーカス表示**: 明確なフォーカスリング表示

### ローディング・無効化状態

- **更新中状態**:
  - 全フォーム要素の無効化
  - 更新ボタンテキストを「更新中...」に変更
  - 下書き保存ボタンの無効化
- **下書き保存中状態**:
  - 下書き保存ボタンテキストを「保存中...」に変更
  - 更新ボタンの無効化
- **削除中状態**:
  - 削除ボタンテキストを「削除中...」に変更
  - 全ボタンの無効化
- **ファイルアップロード中状態**:
  - 添付ボタンの無効化
  - アップロード進行状況の表示
  - プログレスバー表示
- **テンプレート読み込み中状態**:
  - テンプレート選択の無効化
  - ローディングスピナー表示
- **バリデーションエラー時**:
  - 該当フィールドの赤色ボーダー表示
  - エラーメッセージの即座表示

## 技術仕様

### 使用コンポーネント

#### 2_molecules層

- **CareRecordForm**: 介護記録作成・編集フォーム
- **CareRecordDeleteModal**: 削除確認モーダル（将来実装）
- **TemplateSelector**: テンプレート選択・適用コンポーネント
- **FileAttachment**: ファイル添付・管理コンポーネント
- **StaffNotificationSelector**: 職員通知選択コンポーネント

#### 1_atoms層

- **CategoryBadge**: カテゴリバッジ表示
- **PriorityBadge**: 重要度バッジ表示
- **StatusBadge**: ステータスバッジ表示
- **FileUploadButton**: ファイルアップロードボタン
- **TemplateButton**: テンプレート適用ボタン

#### カスタムフック

- **useCareRecordForm**: フォーム状態管理とバリデーション
- **useTemplateManager**: テンプレート管理機能
- **useFileUpload**: ファイルアップロード機能
- **useStaffSelector**: 職員選択機能

#### サービス層

- **careRecordService**: 介護記録のCRUD操作
- **templateService**: テンプレート管理操作
- **fileService**: ファイルアップロード・削除操作
- **staffService**: 職員情報取得操作

### データ型定義

```typescript
interface CareRecordFormData {
  residentId: string; // 利用者ID（必須）
  category: CareRecordCategory; // 記録種別（必須）
  title: string; // タイトル（必須、100文字以内）
  content: string; // 記録内容（必須、1000文字以内）
  recordedAt: string; // 記録日時（必須、ISO形式）
  priority: CareRecordPriority; // 重要度（必須）
  status: CareRecordStatus; // ステータス（必須）
  notificationStaffIds?: string[]; // 通知対象職員ID（任意）
  templateId?: string; // 使用テンプレートID（任意）
  attachments?: CareRecordAttachment[]; // 添付ファイル（任意）
}

interface CareRecordAttachment {
  id: string; // 添付ファイルID
  fileName: string; // ファイル名
  fileSize: number; // ファイルサイズ（bytes）
  fileType: 'image' | 'video'; // ファイル種別
  mimeType: string; // MIMEタイプ
  url: string; // ファイルURL
  uploadedAt: string; // アップロード日時
}

interface CareRecordTemplate {
  id: string; // テンプレートID
  category: CareRecordCategory; // 対象カテゴリ
  title: string; // テンプレート名
  content: string; // テンプレート内容
  isActive: boolean; // 使用可能フラグ
}

interface StaffMember {
  id: string; // 職員ID
  name: string; // 職員名
  department: string; // 所属部署
  isSelected?: boolean; // 選択状態
}
```

### API仕様

| メソッド | エンドポイント                    | 説明                   |
| -------- | --------------------------------- | ---------------------- |
| GET      | `/api/v1/care-records/{id}`       | 介護記録詳細取得       |
| PUT      | `/api/v1/care-records/{id}`       | 介護記録更新           |
| DELETE   | `/api/v1/care-records/{id}`       | 介護記録削除           |
| POST     | `/api/v1/care-records/{id}/draft` | 下書き保存             |
| GET      | `/api/v1/templates`               | テンプレート一覧取得   |
| GET      | `/api/v1/templates/{category}`    | カテゴリ別テンプレート |
| POST     | `/api/v1/files/upload`            | ファイルアップロード   |
| DELETE   | `/api/v1/files/{fileId}`          | ファイル削除           |
| GET      | `/api/v1/staff`                   | 職員一覧取得           |
| POST     | `/api/v1/notifications`           | 職員通知送信           |

### 状態管理

- **フォーム状態**: 入力値、バリデーション状態、送信状態
- **エラー状態**: API通信エラー、バリデーションエラー
- **成功状態**: 更新成功、下書き保存成功
- **未保存変更**: フォーム変更の検知と警告表示
- **添付ファイル状態**: アップロード進行状況、添付ファイル一覧
- **テンプレート状態**: 選択中テンプレート、テンプレート一覧
- **職員選択状態**: 選択中職員一覧、通知設定

## テンプレート機能仕様

### テンプレート選択機能

- **カテゴリ連動**: 記録種別選択に応じてテンプレート一覧を更新
- **プレビュー表示**: テンプレート選択時に内容をプレビュー表示
- **適用方式**: 「適用」ボタンクリックで記録内容フィールドに挿入
- **編集可能**: 適用後のテンプレート内容は自由に編集可能

### テンプレート管理

- **管理者権限**: 管理者によるテンプレートの作成・編集・削除
- **カテゴリ分類**: 記録種別ごとのテンプレート管理
- **アクティブ制御**: 使用可能・不可能の状態管理
- **バージョン管理**: テンプレート更新履歴の管理（将来実装）

## 添付ファイル機能仕様

### ファイルアップロード機能

- **ドラッグ&ドロップ**: ファイルをドラッグして添付エリアにドロップ
- **複数選択**: Ctrl/Cmdキーによる複数ファイル同時選択
- **プレビュー機能**: 
  - 画像: サムネイル表示
  - 動画: 再生プレビュー（将来実装）
- **進行状況表示**: アップロード中のプログレスバー表示

### ファイル管理機能

- **ファイル一覧**: 添付済みファイルの一覧表示
- **個別削除**: ファイル毎の削除ボタン
- **ファイル情報**: ファイル名、サイズ、形式の表示
- **ダウンロード**: 添付ファイルのダウンロード機能（将来実装）

## 職員通知機能仕様

### 職員選択機能

- **チェックボックス**: 複数職員の選択・解除
- **職員検索**: 名前による職員検索機能
- **部署フィルター**: 所属部署による絞り込み表示
- **全選択・全解除**: 一括選択・解除機能

### 通知送信機能

- **即時通知**: 記録保存時の即座通知送信
- **通知内容**: 
  - 記録タイトル
  - 作成者名
  - 記録日時
  - 利用者名
- **通知履歴**: 送信済み通知の履歴管理（将来実装）

## 削除機能仕様

### 削除確認フロー

1. **削除ボタンクリック**: 削除確認モーダルを表示
2. **確認メッセージ**: 記録タイトルを含む確認メッセージ
3. **削除実行**: 確認後にAPI呼び出し
4. **完了処理**: 削除成功後に一覧画面に遷移

### 削除時の注意事項

- **データ復元不可**: 削除されたデータは復元できない旨を明示
- **二段階確認**: モーダル表示による確認プロセス
- **エラーハンドリング**: 削除失敗時の適切なエラー表示

## 参考資料

- [介護記録一覧画面設計書](../README.md)
- [介護記録詳細画面設計書](../[recordId]/README.md)
- [CareRecordForm コンポーネント](../../../../components/2_molecules/care-record/care-record-form.tsx)
- [TemplateSelector コンポーネント](../../../../components/2_molecules/template/template-selector.tsx)
- [FileAttachment コンポーネント](../../../../components/2_molecules/file/file-attachment.tsx)
- [StaffNotificationSelector コンポーネント](../../../../components/2_molecules/staff/staff-notification-selector.tsx)
- [useCareRecordForm フック](../../../../hooks/useCareRecordForm.ts)
- [useTemplateManager フック](../../../../hooks/useTemplateManager.ts)
- [useFileUpload フック](../../../../hooks/useFileUpload.ts)
- [useStaffSelector フック](../../../../hooks/useStaffSelector.ts)
- [Care Record Types](../../../../types/care-record.ts)
- [Template Types](../../../../types/template.ts)
- [File Types](../../../../types/file.ts)
- [Staff Types](../../../../types/staff.ts)
- [Care Record Service](../../../../services/careRecordService.ts)
- [Template Service](../../../../services/templateService.ts)
- [File Service](../../../../services/fileService.ts)
- [Staff Service](../../../../services/staffService.ts)
- [画面一覧](../../../../docs/screen-list.md#申し送り介護記録)

### FlutterFlow参考資料

![介護記録編集画面](https://github.com/user-attachments/assets/0e1905f9-4ec5-4a73-b9d9-0f0eb9961c20)

**FlutterFlow画面要素対応表:**

| FlutterFlow要素 | 対応コンポーネント | 実装内容 |
| --------------- | ------------------ | -------- |
| 該当時間        | FormField          | 記録日時入力フィールド |
| 分類            | FormSelect         | 記録種別選択ドロップダウン |
| 分類を編集する  | Button             | カテゴリ編集リンク（将来実装） |
| ケース記録      | FormSelect         | カテゴリ選択の初期値 |
| ご利用者(対象)  | FormSelect         | 利用者選択ドロップダウン |
| サンプル太郎15  | InfoDisplay        | 選択済み利用者表示 |
| 記録内容        | Textarea           | メイン記録内容入力エリア |
| アラートあり    | Toggle             | 重要度設定（高/中/低） |
| 入力してください | Placeholder       | 記録内容のプレースホルダー |
| 動画を添付      | FileInput          | 動画ファイル添付ボタン |
| 画像を添付      | FileInput          | 画像ファイル添付ボタン |
| 保存する        | Button             | 記録更新・保存ボタン |
