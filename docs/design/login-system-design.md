# ログインシステム設計書

## 概要
CareBase-staffアプリケーションにおける認証システムの設計文書です。施設職員が安全にシステムにアクセスし、適切な権限で業務を行えるようにするためのログイン機能を定義します。

## 目次
1. [UI/UXデザイン](#uiuxデザイン)
2. [データモデル設計](#データモデル設計)
3. [コンポーネント設計](#コンポーネント設計)
4. [状態管理設計](#状態管理設計)
5. [バリデーション設計](#バリデーション設計)
6. [テストケース設計](#テストケース設計)

---

## UI/UXデザイン

### 画面構成
ログインシステムは以下の2つの画面で構成されます：

#### 1. ログイン画面
![ログイン画面](https://github.com/user-attachments/assets/d5980402-aaf3-4afa-8064-371439a8bc6c)

**主要要素:**
- **ロゴ**: CareBaseブランドロゴ
- **タイトル**: 「ログイン」
- **施設ID入力フィールド**: プレースホルダー「施設IDを入力」
- **パスワード入力フィールド**: プレースホルダー「パスワードを入力」
- **ログインボタン**: 認証実行用のプライマリボタン
- **フッター**: 著作権表示

**デザインパターン:**
- **レイアウト**: 中央配置のカード形式
- **色彩**: CareBase ブルー (`carebase-blue`) をメインカラーとして使用
- **フォント**: システムフォントを使用、明瞭性を重視
- **レスポンシブ**: モバイル・タブレット対応

#### 2. 職員選択画面
![職員選択画面](https://github.com/user-attachments/assets/72025d97-a7a2-4116-984e-a1691ba8cd3f)

**主要要素:**
- **戻るボタン**: ログイン画面に戻るためのボタン
- **ステップインジケータ**: 3段階の選択プロセス表示
- **選択カード**: グループ・チーム・スタッフの選択インターフェース
- **確認ボタン**: 選択完了後の確認ボタン

**UXフロー:**
1. グループ選択
2. チーム選択
3. スタッフ選択
4. 確認・ログイン実行

---

## データモデル設計

### 認証関連データ構造

以下のデータ構造を定義しています：

- **LoginCredentials**: ログイン認証に必要な施設IDとパスワード
- **Staff**: 職員の基本情報（ID、名前、ふりがな、役職、社員ID、有効性）
- **Team**: チーム構造（ID、名前、説明、アイコン、所属職員）
- **Group**: グループ構造（ID、名前、説明、アイコン、所属チーム）
- **AuthState**: 認証状態管理用の構造

詳細な型定義: [`types/staff.ts`](/types/staff.ts)

### バリデーションスキーマ

入力検証ルール：

**ログイン入力検証:**
- 施設ID: 必須、1-50文字
- パスワード: 必須、1-100文字

**職員選択検証:**
- グループID: 必須
- チームID: 必須  
- スタッフID: 必須

バリデーション実装: [`components/2_molecules/auth/login-form.tsx`](/components/2_molecules/auth/login-form.tsx)

---

## コンポーネント設計

### アーキテクチャ
Atomic Design パターンに従った階層構造：

```
3_organisms/
├── auth/
│   ├── login-screen.tsx          # ログイン画面全体
│   └── staff-selection-screen.tsx # 職員選択画面全体

2_molecules/
├── auth/
│   ├── login-form.tsx            # ログインフォーム
│   ├── staff-group-selector.tsx  # グループ選択
│   ├── staff-team-selector.tsx   # チーム選択
│   └── staff-selector.tsx        # 職員選択

1_atoms/
├── common/
│   ├── logo.tsx                  # ロゴコンポーネント
│   └── loading-spinner.tsx       # ローディング表示
├── forms/
│   ├── input-field.tsx           # 入力フィールド
│   └── submit-button.tsx         # 送信ボタン
```

### 主要コンポーネント仕様

各コンポーネントのProps仕様と機能：

#### LoginForm
- ログイン認証フォーム
- リアルタイムバリデーション
- エラーメッセージ表示
- ローディング状態管理

#### LoginScreen 
- ログイン画面全体のレイアウト
- ロゴ表示
- フォーム統合
- 職員選択への遷移制御

#### StaffSelectionScreen
- 3段階の職員選択プロセス
- ステップインジケータ
- 戻る・リセット機能
- 選択結果の確認表示

詳細実装: [`components/`](/components/) ディレクトリ

---

## 状態管理設計

### 認証状態管理
React の useState を使用したローカル状態管理：

**状態変数:**
- `authMode`: 'login' | 'staff-selection'
- `isLoading`: ローディング状態
- 各種選択状態（グループ、チーム、スタッフ）

**状態遷移フロー:**
1. **初期状態**: `authMode = 'login'`
2. **ログイン成功**: `authMode = 'staff-selection'`
3. **職員選択完了**: メインアプリケーションへ遷移
4. **戻る操作**: `authMode = 'login'`

状態管理実装: [`app/(auth)/login/page.tsx`](/app/(auth)/login/page.tsx)

---

## バリデーション設計

### 入力検証
フロントエンドでの入力検証実装：

**検証項目:**
- 必須項目チェック（施設ID、パスワード）
- 文字数制限（施設ID: 50文字、パスワード: 100文字）
- 認証失敗時の適切なエラーメッセージ

**エラーハンドリングパターン:**
- 必須項目未入力
- 認証失敗
- システムエラー
- 職員選択エラー

バリデーション実装: [`components/2_molecules/auth/login-form.tsx`](/components/2_molecules/auth/login-form.tsx)

### エラーハンドリング
- **必須項目未入力**: 「施設IDとパスワードを入力してください。」
- **認証失敗**: 「施設IDまたはパスワードが正しくありません。」
- **システムエラー**: 「ログイン中にエラーが発生しました。もう一度お試しください。」
- **職員選択エラー**: 「スタッフが選択されていません。」「選択されたスタッフは現在利用できません。」

---

## テストケース設計

### 単体テスト
Jest + React Testing Library を使用：

**テスト対象:**
- ログインフォームコンポーネント
- 職員選択コンポーネント
- バリデーション機能
- エラーハンドリング

**テストケース:**
- フォーム要素の正常レンダリング
- 必須項目バリデーション
- 正常な認証フロー
- エラー状態の表示

テスト実装: [`__tests__/components/`](/__tests__/components/) ディレクトリ

### 統合テスト
Playwright を使用したE2Eテスト：

**テストシナリオ:**
- 完全なログイン〜職員選択フロー
- エラーケースの検証
- レスポンシブデザインの確認
- アクセシビリティテスト

E2Eテスト: [`e2e/`](/e2e/) ディレクトリ

### テストカバレッジ
- **コンポーネント**: 100% カバレッジ目標
- **認証フロー**: 全ての成功・失敗パターン
- **バリデーション**: 全ての入力パターン
- **エラーハンドリング**: 全てのエラーケース

---

## 実装済み機能

### ✅ 完了項目
- [x] **UI/UXデザイン**: ログイン画面・職員選択画面のレイアウト設計完了
- [x] **データモデル設計**: 認証・職員データ構造の定義完了
- [x] **コンポーネント設計**: Atomic Design パターンでの実装完了
- [x] **状態管理設計**: React hooks による状態管理実装完了
- [x] **バリデーション設計**: 入力検証・エラーハンドリング実装完了
- [x] **テストケース設計**: 単体テスト・E2Eテストの実装完了

### 🔧 技術仕様
- **フレームワーク**: Next.js 14 (App Router) ✅
- **UI ライブラリ**: shadcn/ui + Tailwind CSS ✅
- **状態管理**: React Context API / useState ✅
- **フォーム管理**: React Hook Form + 手動バリデーション ✅
- **認証**: JWT ベース認証（モック実装） ✅

### 📋 成果物
- [x] 画面モックアップ（スクリーンショット取得済み）
- [x] コンポーネント設計書（本文書）
- [x] API仕様書（本文書）
- [x] データモデル定義（本文書）
- [x] テストケース設計（本文書）

---

## 今後の拡張予定

### セキュリティ強化
- パスワード暗号化
- セッション管理
- CSRF対策
- 二要素認証

### UX改善
- ログイン状態の永続化
- 自動ログアウト
- パスワード変更機能
- ログイン履歴

### パフォーマンス最適化
- 職員データの遅延読み込み
- 検索機能の追加
- キャッシュ戦略

---

## 参考資料
- [Next.js 14 App Router Documentation](https://nextjs.org/docs/app)
- [shadcn/ui Components](https://ui.shadcn.com/)
- [React Testing Library](https://testing-library.com/docs/react-testing-library/intro/)
- [Playwright E2E Testing](https://playwright.dev/)